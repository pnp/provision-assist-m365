{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "resourceGroupName": {
            "defaultValue": "",
            "type": "string"
        },
        "subscriptionId": {
            "defaultValue": "",
            "type": "string"
        },
        "automationAccountName": {
            "defaultValue": "",
            "type": "string"
        },
        "tenantId": {
            "defaultValue": "",
            "type": "string"
        },
        "location": {
            "defaultvalue": "",
            "type": "string"
        },
        "requestsSiteUrl": {
            "defaultvalue": "",
            "type": "string"
        },
        "requestsListId": {
            "defaultvalue": "",
            "type": "string"
        },
        "requestsSettingsListId": {
            "defaultvalue": "",
            "type": "string"
        },
        "tenantName": {
            "defaultvalue": "",
            "type": "string"
        },
        "serviceAccountUPN": {
            "defaultValue": "",
            "type": "string"
        },
        "certName": {
            "defaultValue": "",
            "type": "string"
        },
        "spoRootSiteUrl": {
            "defaultValue": "",
            "type": "string"
        }
    },
    "variables": {
        "Singlequote": "'"
    },
    "resources": [
        {
            "comments": "Logic apps",
            "type": "Microsoft.Logic/workflows",
            "apiVersion": "2017-07-01",
            "name": "ProcessProvisionRequest",
            "location": "[parameters('location')]",
            "properties": {
                "state": "Enabled",
                "definition": {
                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "$connections": {
                            "defaultValue": {
                            },
                            "type": "Object"
                        }
                    },
                    "triggers": {
                        "When_an_item_is_created_or_modified": {
                            "recurrence": {
                                "frequency": "Hour",
                                "interval": 1
                            },
                            "splitOn": "@triggerBody()?['value']",
                            "type": "ApiConnection",
                            "inputs": {
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['sharepointonline']['connectionId']"
                                    }
                                },
                                "method": "get",
                                "path": "[concat('/datasets/@{encodeURIComponent(encodeURIComponent(',variables('singlequote'),parameters('requestsSiteUrl'),variables('singlequote'),'))}/tables/@{encodeURIComponent(encodeURIComponent(',variables('singlequote'),parameters('requestsListId'),variables('singlequote'),'))}/onupdateditems')]"
                            },
                            "conditions": [
                                {
                                    "expression": "@equals(triggerBody()?['Status']?['Value'],'Approved')"
                                }
                            ]
                        }
                    },
                    "actions": {
                        "Apply_Site_Template": {
                            "actions": {
                                "Check_if_space_type_is_a_Group_and_Site_Template_is_populated": {
                                    "actions": {
                                        "Apply_site_template_to_site": {
                                            "runAfter": {
                                                "Check_site_template_store_value": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Http",
                                            "inputs": {
                                                "uri": "@{triggerBody()?['SiteURL']}/_api/Microsoft.Sharepoint.Utilities.WebTemplateExtensions.SiteScriptUtility.ApplySiteDesign",
                                                "method": "POST",
                                                "headers": {
                                                    "Content-Type": "application/json"
                                                },
                                                "body": "@variables('SiteTemplateRequestBody')",
                                                "authentication": {
                                                    "audience": "[parameters('spoRootSiteUrl')]",
                                                    "clientId": "@body('Get_Client_ID')?['value']",
                                                    "password": "@null",
                                                    "pfx": "@body('Get_Certificate')?['value']",
                                                    "tenant": "@variables('TenantID')",
                                                    "type": "ActiveDirectoryOAuth"
                                                }
                                            }
                                        },
                                        "Check_site_template_store_value": {
                                            "actions": {
                                                "Set_SiteTemplateRequestBody_variable_-_out_of_the_box_template_-_group": {
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "SiteTemplateRequestBody",
                                                        "value": "{\"siteDesignId\":\"@{triggerBody()?['SiteTemplate']}\",\"webUrl\":\"@{triggerBody()?['SiteURL']}\",\"store\":1}"
                                                    }
                                                }
                                            },
                                            "else": {
                                                "actions": {
                                                    "Set_SiteTemplateRequestBody_variable_-_custom_template_-_group": {
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "SiteTemplateRequestBody",
                                                            "value": "{\"siteDesignId\":\"@{triggerBody()?['SiteTemplate']}\",\"webUrl\":\"@{triggerBody()?['SiteURL']}\"}"
                                                        }
                                                    }
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "equals": [
                                                            "@triggerBody()?['SiteTemplateStore']",
                                                            "@string(1)"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "type": "If",
                                            "description": "Check the store value, this determines whether to apply Microsoft out of the box site designs or custom ones."
                                        }
                                    },
                                    "else": {
                                        "actions": {}
                                    },
                                    "expression": {
                                        "and": [
                                            {
                                                "equals": [
                                                    "@triggerBody()?['SpaceTypeInternal']",
                                                    "Office 365 Group"
                                                ]
                                            },
                                            {
                                                "equals": [
                                                    "@empty(triggerBody()?['SiteTemplate'])",
                                                    "@false"
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If",
                                    "description": "Check if site template is populated and the space type is a Group. SharePoint space types have the template applied during creation."
                                }
                            },
                            "runAfter": {
                                "Process_Team": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Scope"
                        },
                        "Apply_sensitivity_label": {
                            "actions": {
                                "Check_space_type_and_if_the_sensitivity_label_is_populated": {
                                    "actions": {
                                        "Add_service_account_to_group_-_apply_label": {
                                            "type": "Http",
                                            "inputs": {
                                                "uri": "@{variables('GraphURL')}/groups/@{variables('GroupID')}/owners/$ref",
                                                "method": "POST",
                                                "body": {
                                                    "@@odata.id": "https://graph.microsoft.com/v1.0/users/@{body('Get_service_account_user_profile')?['id']}"
                                                },
                                                "authentication": {
                                                    "audience": "https://graph.microsoft.com",
                                                    "clientId": "@body('Get_Client_ID')?['value']",
                                                    "password": "@null",
                                                    "pfx": "@body('Get_Certificate')?['value']",
                                                    "tenant": "@variables('TenantID')",
                                                    "type": "ActiveDirectoryOAuth"
                                                }
                                            }
                                        },
                                        "Apply_sensitivity_label_to_the_group": {
                                            "runAfter": {
                                                "Parse_get_access_token_JSON": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Http",
                                            "inputs": {
                                                "uri": "@{variables('BetaGraphURL')}/groups/@{variables('GroupID')}",
                                                "method": "PATCH",
                                                "headers": {
                                                    "authorization": "bearer @{body('Parse_get_access_token_JSON')?['access_token']}",
                                                    "content-type": "application/json"
                                                },
                                                "body": {
                                                    "assignedLabels": [
                                                        {
                                                            "labelId": "@{triggerBody()?['SensitivityLabelId']}"
                                                        }
                                                    ]
                                                }
                                            }
                                        },
                                        "Get_access_token_for_service_account": {
                                            "runAfter": {
                                                "URL_encode_service_account_password": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Http",
                                            "inputs": {
                                                "uri": "https://login.microsoftonline.com/@{variables('TenantID')}/oauth2/token",
                                                "method": "POST",
                                                "headers": {
                                                    "content-type": "application/x-www-form-urlencoded"
                                                },
                                                "body": "grant_type=password&resource=https://graph.microsoft.com&client_id=@{body('Get_Client_ID')?['value']}&username=@{body('Get_service_account_username')?['value']}&password=@{outputs('URL_encode_service_account_password')}&client_secret=@{outputs('URL_encode_client_secret')}"
                                            }
                                        },
                                        "Get_service_account_password": {
                                            "runAfter": {
                                                "Get_service_account_username": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['keyvault']['connectionId']"
                                                    }
                                                },
                                                "method": "get",
                                                "path": "/secrets/@{encodeURIComponent('sapassword')}/value",
                                                "runtimeConfiguration": {
                                                    "secureData": {
                                                        "properties": [
                                                            "inputs",
                                                            "outputs"
                                                        ]
                                                    }
                                                }
                                            }
                                        },
                                        "Get_service_account_username": {
                                            "runAfter": {
                                                "Wait_for_owner_to_be_added_-_apply_label": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['keyvault']['connectionId']"
                                                    }
                                                },
                                                "method": "get",
                                                "path": "/secrets/@{encodeURIComponent('sausername')}/value"
                                            },
                                            "runtimeConfiguration": {
                                                "secureData": {
                                                    "properties": [
                                                        "inputs",
                                                        "outputs"
                                                    ]
                                                }
                                            }
                                        },
                                        "Parse_get_access_token_JSON": {
                                            "runAfter": {
                                                "Get_access_token_for_service_account": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ParseJson",
                                            "inputs": {
                                                "content": "@body('Get_access_token_for_service_account')",
                                                "schema": {
                                                    "properties": {
                                                        "access_token": {
                                                            "type": "string"
                                                        },
                                                        "expires_in": {
                                                            "type": "string"
                                                        },
                                                        "expires_on": {
                                                            "type": "string"
                                                        },
                                                        "ext_expires_in": {
                                                            "type": "string"
                                                        },
                                                        "not_before": {
                                                            "type": "string"
                                                        },
                                                        "resource": {
                                                            "type": "string"
                                                        },
                                                        "token_type": {
                                                            "type": "string"
                                                        }
                                                    },
                                                    "type": "object"
                                                }
                                            }
                                        },
                                        "Remove_service_account_from_group_-_apply_label": {
                                            "runAfter": {
                                                "Apply_sensitivity_label_to_the_group": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Http",
                                            "inputs": {
                                                "uri": "@{variables('GraphURL')}/groups/@{variables('GroupID')}/owners/@{body('Get_service_account_user_profile')?['id']}/$ref",
                                                "method": "DELETE",
                                                "authentication": {
                                                    "audience": "https://graph.microsoft.com",
                                                    "clientId": "@body('Get_Client_ID')?['value']",
                                                    "password": "@null",
                                                    "pfx": "@body('Get_Certificate')?['value']",
                                                    "tenant": "@variables('TenantID')",
                                                    "type": "ActiveDirectoryOAuth"
                                                }
                                            }
                                        },
                                        "URL_encode_client_secret": {
                                            "runAfter": {
                                                "Get_service_account_password": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Compose",
                                            "inputs": "@encodeUriComponent(body('Get_Client_Secret')?['value'])"
                                        },
                                        "URL_encode_service_account_password": {
                                            "runAfter": {
                                                "URL_encode_client_secret": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Compose",
                                            "inputs": "@encodeUriComponent(body('Get_service_account_password')?['value'])"
                                        },
                                        "Wait_for_owner_to_be_added_-_apply_label": {
                                            "runAfter": {
                                                "Add_service_account_to_group_-_apply_label": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Wait",
                                            "inputs": {
                                                "interval": {
                                                    "count": 2,
                                                    "unit": "Minute"
                                                }
                                            }
                                        }
                                    },
                                    "else": {
                                        "actions": {}
                                    },
                                    "expression": {
                                        "and": [
                                            {
                                                "or": [
                                                    {
                                                        "equals": [
                                                            "@triggerBody()?['SpaceTypeInternal']",
                                                            "Office 365 Group"
                                                        ]
                                                    },
                                                    {
                                                        "equals": [
                                                            "@triggerBody()?['SpaceTypeInternal']",
                                                            "Microsoft Teams Team"
                                                        ]
                                                    }
                                                ]
                                            },
                                            {
                                                "and": [
                                                    {
                                                        "equals": [
                                                            "@variables('EnableSensitivityLabels')",
                                                            "@true"
                                                        ]
                                                    },
                                                    {
                                                        "equals": [
                                                            "@empty(triggerBody()?['SensitivityLabelId'])",
                                                            "@false"
                                                        ]
                                                    }
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If"
                                }
                            },
                            "runAfter": {
                                "Invite_guests": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Scope"
                        },
                        "Check_if_space_exists": {
                            "actions": {
                                "Check_response": {
                                    "actions": {
                                        "Post_space_exists_adaptive_card_to_user": {
                                            "runAfter": {
                                                "Update_status_to_space_already_exists_-_SP_site_exists": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['teams']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "body": {
                                                    "recipient": "@triggerBody()?['Author']?['Email']",
                                                    "messageBody": "{\n    \"type\": \"AdaptiveCard\",\n    \"body\": [\n        {\n            \"type\": \"Container\",\n            \"style\": \"emphasis\",\n            \"items\": [\n                {\n                    \"type\": \"ColumnSet\",\n                    \"columns\": [\n                        {\n                            \"type\": \"Column\",\n                            \"items\": [\n                                {\n                                    \"type\": \"Image\",\n                                    \"weight\": \"Bolder\",\n                                    \"text\": \"**Space Request**\",\n                                    \"url\": \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAACXBIWXMAAC4jAAAuIwF4pT92AAAH6ElEQVR4nO2ce6xdRRWHv9vb1lqkFUObUixa6gPT+OARCrFotUisWI2AWm2qxMZHxJoaEwMJCcREY/jPRNRYqoEgpWKaFuILjQiIDdTYhhZa02B5VUtftEJL0d7+/GPdyz1nzt7nsffM6cI7X7LTzuzZa699fntm9sysuQOSyPhh3Ml2INNMFsQZWRBnZEGckQVxRhbEGVkQZ2RBnJEFcUYWxBlZEGdkQZyRBXFGFsQZWRBnZEGcMb7P9/sI8H5gGnAEeAhYDxzrsx/tOLk+SurHcY2kLSrmGUnXSxrsky+ufRxQ2iXcQeBu7K3rxOPAYuAfKR0qwJWPqQW5H3hfD+X3AucAz6dxpxBXPqbs1FdS/KB/BNYAvwaGgnPTgVUJfQpZiTcfE7WF4yQdCtrh/ZIWBOXmlLTb56Ruq736mOphlwbOn5D0npKykyQ9HZT/SSK/3PuYqslaGKRvBbaUlD0G/CjImx3boQJc+phKkNcG6d93KP+vIP2aiL6U4dLHVIIcD9Jv6lA+fLjw+hS49DGVIDuC9IoO5T8epA9G9KUMnz4m6jBnqpU7SspeW1D2k4n8cu9jyoHhelrfqr8BNwOPAmcBXwYuC8o8Sfcd5gA2LpiBjbifA/YB/3HkY28kfAMnSNpW8Ga1Y7/su7+T7U9I+o2kZyUNBTaek/SgpOVd2BkvaWsFH9/She1KR8qR+n+xN7YXDmNTE2VcDmwE1gEfBs6ktR+cDswHbgG2A19tY+94h/sVcQj4Z4/XdE8ipedJ2tXjmzfCMUlXF9j8fkV7krShwN58SU9VtHdUNrCM/tulEOOSDg9zWNITkvZ2KPe1BpsbOpR9ctjm8TZltkg6Zdjewkg+fkmRf7/YYsyQdKTA8QOSvivpUklThstOlHSxbJ1hZ8kDXyRpZcm5eyR9UdLshvufIenTkn5Wcs0vJJ0n6aWIPs5XxN8wtiAbCxxeK2lah+sGJd1U8sAhJyQt68KXD6j7ZrOOj4dkc13uBLmqwNlberTx9S5+vHN7sDdFrZOCKXz8Xo82+iLIpsDJbRXtrGnz4y2pYG9OG3uxfDwoaaCirSSCnFXwsBdUtDVFxZ3zlhr+rSqwF9vHz9fw75Uj1jhkaZDeBvy1oq1/0zrVDXBjRXsA19G68hfbx0UVbTURS5BwbeGumvbuDdIvAvfUsLcfm+5o5Oc17IEt8zby5pr2gHiCTMJG5iPHEzXtHQ3S22l9w3tlf5DeXdPeIZqfOcp0fKxAucXY5J6wCb/DNe2dCNJ1xQDzLSYPADMZfWZXgsQOiXk5SM+JYHNqkO52RriMIVprXW28xvZup7mWTAPeW8PeRFqny/fUsJcMr4I8D/wuyLuxhr1vYf3cCC8Aj9SwlwyvggCsDdKXAu+qYGcAuCHIWw28VMWp1KQOJa3DVGzdYXJD3l6s6Qm/wtrxJyyavZG5WJyuOzzXkMNYqGcj07EB3Tu7uH4qNp4JxViNUzHAdw0Z4V7gQwX5PwZ+ADwW5J8BXIOthZ8enNuNDeD6EWZUiVeDIJOxKY53lJx/GBNlCHgr9jU2oaDcEeB84O8JfIzGq0GQEW4DllW89iFsnd09/d7SVpXLgCk1rp8AfAz4A+0/CD4IzMOavddhX2J7gc3Ypp70xJgyTnzUCW4IWVFyj8tloUPteFzdhRbVOjw3WZOwDv2SkvM7ga1YR70H66hnYKFBc4ePRnYBC4CnG/IGgZ8Cn+vBrweBJaQKBUqteMVjvKTNJW/qbyVd2YWNRZLWNVw3Mzg/qOIYgG7YI+mNKZ7daw35Fa2bMF/GPmVv7dHWV7CacHOQvxb4VEH5ncBfsJp0GlZD311QbgflX37VSaFyzWNlwRu5Q9KsiPdYVHCPgyoPoL5I1oeE3BD7+b3VkJm0Lhw9A7yNuBv3H6V5tL8PqwXhppyQh4ELG9JHgTfQulxQGW9TJ98uyFtAXDHm0jr18lk6iwHw0SA9GWtGo+FJkFnA8iDvO8TfpP+ZIL0VG590wz7gh0HegroONeJJkDBqYzdwfYL7nB2ke/1ICIMtTqvhSwueBLkiSK9PdJ/BIN1rsEPYX0wqLFURL4KcSmsoUbhAFYswYOL1PV4fClp3bb4JL4KcT/O82j5sRJyCsPO+qsfr5wXpuhE2TXgR5LwgHfWtC/hlkF6ITdt3wzjg2iAv6tq8l9nebcCdjMZOhYtOMdmIjW1mNeStAS7o4trbsFngEYawhbJ49HEE7un4QsGo+36V/62TabI9JCGr/t9H6v3kzxTHeq3GRvIHsNrwduBqWj9vn8IGmC/EdMpLk3Uy2EyxIOHgtIzHiCwG+OnUTwZ1ViABToniRcBYFiTERSTKWG6yQr6J9QvLsfivo1hM8DFsL8npwE2pnciCjPIisGH4ADgX69xHRvZL+uFEbrJGeXb438XAJuyP0OxidHr9QD+cyDVklKVYlHzjnNosbOC3gvq7wroiCzJKu8iToiiWJOQmyxlZkGI2YZ347f2+cRakmUew0KALsfWYZVh46bp+OTCWBRlo+P8D2J/6m0frHvv7gCuxtfPGve0Tkzg1hicX78PCTr+BBeZ1y8XYFrnZWKBcuIW7FmNZkCuw6MMqu6lOxfY83k2cPfSvMJYFcclY7kNckgVxRhbEGVkQZ2RBnJEFcUYWxBlZEGdkQZyRBXFGFsQZWRBnZEGckQVxRhbEGVkQZ/wPGKORe/+IGzsAAAAASUVORK5CYII=\",\n                                    \"width\": \"60px\",\n                                    \"height\": \"60px\"\n                                }\n                            ],\n                            \"width\": \"60px\",\n                            \"minHeight\": \"60px\"\n                        },\n                        {\n                            \"type\": \"Column\",\n                            \"items\": [\n                                {\n                                    \"type\": \"Container\",\n                                    \"items\": [\n                                        {\n                                            \"type\": \"TextBlock\",\n                                            \"text\": \"Provision Assist\",\n                                            \"wrap\": true,\n                                            \"size\": \"ExtraLarge\",\n                                            \"weight\": \"Bolder\",\n                                            \"horizontalAlignment\": \"Left\"\n                                        }\n                                    ],\n                                    \"style\": \"default\",\n                                    \"verticalContentAlignment\": \"Bottom\"\n                                }\n                            ],\n                            \"width\": \"stretch\",\n                            \"horizontalAlignment\": \"Center\",\n                            \"verticalContentAlignment\": \"Bottom\"\n                        }\n                    ]\n                },\n                {\n                    \"type\": \"Container\",\n                    \"style\": \"attention\",\n                    \"items\": [\n                        {\n                            \"type\": \"TextBlock\",\n                            \"text\": \"Space Already Exists ❌\",\n                            \"wrap\": true,\n                            \"size\": \"Large\"\n                        }\n                    ]\n                }\n            ],\n            \"bleed\": true,\n            \"backgroundImage\": {\n                \"url\": \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA+gAAABkCAIAAACaW42NAAAACXBIWXMAAA9hAAAPYQGoP6dpAAACIUlEQVR4nO3WsQ3AIADAsNLXkbibExghkn1Bxowx1wcAALztvx0AAACcGXcAAAgw7gAAEGDcAQAgwLgDAECAcQcAgADjDgAAAcYdAAACjDsAAAQYdwAACDDuAAAQYNwBACDAuAMAQIBxBwCAAOMOAAABxh0AAAKMOwAABBh3AAAIMO4AABBg3AEAIMC4AwBAgHEHAIAA4w4AAAHGHQAAAow7AAAEGHcAAAgw7gAAEGDcAQAgwLgDAECAcQcAgADjDgAAAcYdAAACjDsAAAQYdwAACDDuAAAQYNwBACDAuAMAQIBxBwCAAOMOAAABxh0AAAKMOwAABBh3AAAIMO4AABBg3AEAIMC4AwBAgHEHAIAA4w4AAAHGHQAAAow7AAAEGHcAAAgw7gAAEGDcAQAgwLgDAECAcQcAgADjDgAAAcYdAAACjDsAAAQYdwAACDDuAAAQYNwBACDAuAMAQIBxBwCAAOMOAAABxh0AAAKMOwAABBh3AAAIMO4AABBg3AEAIMC4AwBAgHEHAIAA4w4AAAHGHQAAAow7AAAEGHcAAAgw7gAAEGDcAQAgwLgDAECAcQcAgADjDgAAAcYdAAACjDsAAAQYdwAACDDuAAAQYNwBACDAuAMAQIBxBwCAAOMOAAABxh0AAAKMOwAABBh3AAAIMO4AABBg3AEAIMC4AwBAgHEHAIAA4w4AAAHGHQAAAow7AAAEGHcAAAgw7gAAELAB7VMB0pYASVwAAAAASUVORK5CYII=\"\n            }\n        },\n        {\n            \"type\": \"Container\",\n            \"items\": [\n                {\n                    \"type\": \"ColumnSet\",\n                    \"columns\": [\n                        {\n                            \"type\": \"Column\",\n                            \"items\": [\n                                {\n                                    \"type\": \"TextBlock\",\n                                    \"size\": \"ExtraLarge\",\n                                    \"text\": \"@{triggerBody()?['Title']}\",\n                                    \"wrap\": true\n                                }\n                            ],\n                            \"width\": \"stretch\"\n                        }\n                    ]\n                },\n                {\n                    \"type\": \"TextBlock\",\n                    \"text\": \"A space matching your request for an '@{triggerBody()?['SpaceType']?['Value']}' - '@{triggerBody()?['Title']}' already exists.\",\n                    \"wrap\": true,\n                    \"weight\": \"Bolder\"\n                },\n                {\n                    \"type\": \"TextBlock\",\n                    \"text\": \"This space may be active or in the recycle bin.\",\n                    \"wrap\": true,\n                    \"weight\": \"Bolder\"\n                },\n                {\n                    \"type\": \"TextBlock\",\n                    \"text\": \"Either edit and resubmit your request or contact an Administrator for more details.\",\n                    \"wrap\": true\n                }\n            ]\n        }\n    ],\n    \"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n    \"version\": \"1.4\",\n    \"fallbackText\": \"This card requires Adaptive Cards v1.2 support to be rendered properly.\"\n}"
                                                },
                                                "path": "/v1.0/teams/conversation/adaptivecard/poster/Flow bot/location/@{encodeURIComponent('Chat with Flow bot')}"
                                            }
                                        },
                                        "Terminate_-_space_exists": {
                                            "runAfter": {
                                                "Post_space_exists_adaptive_card_to_user": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Terminate",
                                            "inputs": {
                                                "runStatus": "Succeeded"
                                            }
                                        },
                                        "Update_status_to_space_already_exists_-_SP_site_exists": {
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['sharepointonline']['connectionId']"
                                                    }
                                                },
                                                "method": "patch",
                                                "body": {
                                                    "Title": "@triggerBody()?['Title']",
                                                    "Status": {
                                                        "Value": "Space Already Exists"
                                                    },
                                                    "StatusReason": "Space already exists."
                                                },
                                                "path": "[concat('/datasets/@{encodeURIComponent(encodeURIComponent(',variables('singlequote'),parameters('requestsSiteUrl'),variables('singlequote'),'))}/tables/@{encodeURIComponent(encodeURIComponent(',variables('singlequote'),parameters('requestsListId'),variables('singlequote'),'))}/items/@{encodeURIComponent(triggerBody()?[',variables('singlequote'),'ID',variables('singlequote'),'])}')]"
                                            }
                                        }
                                    },
                                    "runAfter": {
                                        "Parse_CheckSiteExists_response": [
                                            "Succeeded"
                                        ]
                                    },
                                    "else": {
                                        "actions": {}
                                    },
                                    "expression": {
                                        "and": [
                                            {
                                                "equals": [
                                                    "@body('Parse_CheckSiteExists_response')?['exists']",
                                                    "@true"
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If"
                                },
                                "Parse_CheckSiteExists_response": {
                                    "runAfter": {
                                        "Run_CheckSiteExists_Logic_App": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "ParseJson",
                                    "inputs": {
                                        "content": "@body('Run_CheckSiteExists_Logic_App')",
                                        "schema": {
                                            "properties": {
                                                "exists": {
                                                    "type": "boolean"
                                                }
                                            },
                                            "type": "object"
                                        }
                                    }
                                },
                                "Run_CheckSiteExists_Logic_App": {
                                    "type": "Workflow",
                                    "inputs": {
                                        "host": {
                                            "workflow": {
                                                "id": "[concat('/subscriptions/',parameters('subscriptionId'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Logic/workflows/CheckSiteExists')]"
                                            },
                                            "triggerName": "manual"
                                        },
                                        "body": {
                                            "siteUrl": "@triggerBody()?['SiteURL']",
                                            "tenantId": "@variables('TenantID')"
                                        }
                                    }
                                }
                            },
                            "runAfter": {
                                "Get_Settings": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Scope",
                            "description": "Checks if the requested Site/Group/Team already exists by executing the CheckSiteExists logic app."
                        },
                        "Check_space_type": {
                            "actions": {
                                "Check_template": {
                                    "actions": {
                                        "Check_for_members": {
                                            "actions": {
                                                "Set_MembersRequestBody_variable": {
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "MembersRequestBody",
                                                        "value": "{\n  \"description\": \"@{triggerBody()?['Description']}\",\n  \"displayName\": \"@{If(equals(variables('UseNamingConventions'),true),If(and(equals(empty(triggerBody()?['Prefix']),true),equals(empty(triggerBody()?['Suffix']),true)),triggerBody()?['Title'],concat(triggerBody()?['Prefix'],triggerBody()?['SiteAlias'],triggerBody()?['Suffix'])),triggerBody()?['Title'])}\",\n  \"groupTypes\": [\n    \"Unified\"\n  ],\n  \"mailEnabled\": true,\n  \"mailNickname\": \"@{triggerBody()?['MailboxAlias']}\",\n  \"members@odata.bind\": @{if(greater(variables('MembersOwnersCount'),20),take(variables('MembersGraph'),10),variables('MembersGraph'))},\n  \"owners@odata.bind\": @{if(greater(variables('MembersOwnersCount'),20),take(variables('OwnersGraph'),10),variables('OwnersGraph'))},\n  \"securityEnabled\": false,\n\"visibility\":\"@{triggerBody()?['Visibility']?['Value']}\",\n\"classification\": @{if(empty(triggerBody()?['Classification']),'null',concat('\"',triggerBody()?['Classification'],'\"'))},\n\"resourceBehaviorOptions\":[@{if(equals(triggerBody()?['SpaceType']?['Value'],'Microsoft Teams Team'),concat(variables('QuoteMark'),'WelcomeEmailDisabled',variables('QuoteMark')),'')}]\n}"
                                                    }
                                                }
                                            },
                                            "else": {
                                                "actions": {
                                                    "Set_MembersRequestBody_variable_-_no_members": {
                                                        "runAfter": {},
                                                        "type": "SetVariable",
                                                        "inputs": {
                                                            "name": "MembersRequestBody",
                                                            "value": "{\n  \"description\": \"@{triggerBody()?['Description']}\",\n  \"displayName\": \"@{If(equals(variables('UseNamingConventions'),true),If(and(equals(empty(triggerBody()?['Prefix']),true),equals(empty(triggerBody()?['Suffix']),true)),triggerBody()?['Title'],concat(triggerBody()?['Prefix'],triggerBody()?['SiteAlias'],triggerBody()?['Suffix'])),triggerBody()?['Title'])}\",\n  \"groupTypes\": [\n    \"Unified\"\n  ],\n  \"mailEnabled\": true,\n  \"mailNickname\": \"@{triggerBody()?['MailboxAlias']}\",\n  \"owners@odata.bind\": @{variables('OwnersGraph')},\n  \"securityEnabled\": false,\n\"visibility\":\"@{triggerBody()?['Visibility']?['Value']}\",\n\"classification\":@{if(empty(triggerBody()?['Classification']),'null',concat('\"',triggerBody()?['Classification'],'\"'))},\n\"resourceBehaviorOptions\":[@{if(equals(triggerBody()?['SpaceType']?['Value'],'Microsoft Teams Team'),concat(variables('QuoteMark'),'WelcomeEmailDisabled',variables('QuoteMark')),'')}]\n}"
                                                        }
                                                    }
                                                }
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "equals": [
                                                            "@empty(variables('Members'))",
                                                            "@false"
                                                        ]
                                                    },
                                                    {
                                                        "greaterOrEquals": [
                                                            "@length(variables('MembersGraph'))",
                                                            1
                                                        ]
                                                    }
                                                ]
                                            },
                                            "type": "If",
                                            "description": "Check if members were specified when the request was created. Need to pass a different body to the graph call if there are no members. Check if members array length is greater than 1."
                                        },
                                        "Check_if_space_is_a_team": {
                                            "actions": {
                                                "Check_teams_template": {
                                                    "actions": {
                                                        "Parse_Teamify_JSON": {
                                                            "runAfter": {
                                                                "Wait_for_group_to_teamify": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "ParseJson",
                                                            "inputs": {
                                                                "content": "@body('Teamify_Group')",
                                                                "schema": {
                                                                    "properties": {
                                                                        "@@odata.context": {
                                                                            "type": "string"
                                                                        },
                                                                        "description": {
                                                                            "type": "string"
                                                                        },
                                                                        "discoverySettings": {},
                                                                        "displayName": {
                                                                            "type": "string"
                                                                        },
                                                                        "funSettings": {
                                                                            "properties": {
                                                                                "allowCustomMemes": {
                                                                                    "type": "boolean"
                                                                                },
                                                                                "allowGiphy": {
                                                                                    "type": "boolean"
                                                                                },
                                                                                "allowStickersAndMemes": {
                                                                                    "type": "boolean"
                                                                                },
                                                                                "giphyContentRating": {
                                                                                    "type": "string"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "guestSettings": {
                                                                            "properties": {
                                                                                "allowCreateUpdateChannels": {
                                                                                    "type": "boolean"
                                                                                },
                                                                                "allowDeleteChannels": {
                                                                                    "type": "boolean"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "id": {
                                                                            "type": "string"
                                                                        },
                                                                        "internalId": {
                                                                            "type": "string"
                                                                        },
                                                                        "isArchived": {},
                                                                        "memberSettings": {
                                                                            "properties": {
                                                                                "allowAddRemoveApps": {
                                                                                    "type": "boolean"
                                                                                },
                                                                                "allowCreateUpdateChannels": {
                                                                                    "type": "boolean"
                                                                                },
                                                                                "allowCreateUpdateRemoveConnectors": {
                                                                                    "type": "boolean"
                                                                                },
                                                                                "allowCreateUpdateRemoveTabs": {
                                                                                    "type": "boolean"
                                                                                },
                                                                                "allowDeleteChannels": {
                                                                                    "type": "boolean"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "messagingSettings": {
                                                                            "properties": {
                                                                                "allowChannelMentions": {
                                                                                    "type": "boolean"
                                                                                },
                                                                                "allowOwnerDeleteMessages": {
                                                                                    "type": "boolean"
                                                                                },
                                                                                "allowTeamMentions": {
                                                                                    "type": "boolean"
                                                                                },
                                                                                "allowUserDeleteMessages": {
                                                                                    "type": "boolean"
                                                                                },
                                                                                "allowUserEditMessages": {
                                                                                    "type": "boolean"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        },
                                                                        "webUrl": {
                                                                            "type": "string"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                }
                                                            }
                                                        },
                                                        "Set_TeamsTemplateOperation_variable_-_standard": {
                                                            "runAfter": {},
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "TeamsTemplateOperation",
                                                                "value": "standard"
                                                            }
                                                        },
                                                        "Teamify_Group": {
                                                            "runAfter": {
                                                                "Set_TeamsTemplateOperation_variable_-_standard": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "Http",
                                                            "inputs": {
                                                                "authentication": {
                                                                    "audience": "https://graph.microsoft.com",
                                                                    "clientId": "@body('Get_Client_ID')?['value']",
                                                                    "password": "@null",
                                                                    "pfx": "@body('Get_Certificate')?['value']",
                                                                    "tenant": "@variables('TenantID')",
                                                                    "type": "ActiveDirectoryOAuth"
                                                                },
                                                                "body": {
                                                                    "funSettings": {
                                                                        "allowGiphy": true,
                                                                        "giphyContentRating": "strict"
                                                                    },
                                                                    "memberSettings": {
                                                                        "allowCreateUpdateChannels": true
                                                                    },
                                                                    "messagingSettings": {
                                                                        "allowUserDeleteMessages": true,
                                                                        "allowUserEditMessages": true
                                                                    }
                                                                },
                                                                "headers": {
                                                                    "content-type": "application/json"
                                                                },
                                                                "method": "PUT",
                                                                "uri": "@{variables('GraphURL')}/groups/@{body('Parse_Group_JSON')?['id']}/team"
                                                            }
                                                        },
                                                        "Wait_for_group_to_teamify": {
                                                            "runAfter": {
                                                                "Teamify_Group": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "Wait",
                                                            "inputs": {
                                                                "interval": {
                                                                    "count": 2,
                                                                    "unit": "Minute"
                                                                }
                                                            }
                                                        }
                                                    },
                                                    "runAfter": {},
                                                    "else": {
                                                        "actions": {
                                                            "Create_team_from_group": {
                                                                "runAfter": {},
                                                                "type": "Http",
                                                                "inputs": {
                                                                    "authentication": {
                                                                        "audience": "https://graph.microsoft.com",
                                                                        "clientId": "@body('Get_Client_ID')?['value']",
                                                                        "password": "@null",
                                                                        "pfx": "@body('Get_Certificate')?['value']",
                                                                        "tenant": "@variables('TenantID')",
                                                                        "type": "ActiveDirectoryOAuth"
                                                                    },
                                                                    "body": {
                                                                        "group@odata.bind": "https://graph.microsoft.com/v1.0/groups('@{body('Parse_group_JSON')?['id']}')",
                                                                        "template@odata.bind": "https://graph.microsoft.com/v1.0/teamsTemplates('@{triggerBody()?['TeamsTemplate']}')"
                                                                    },
                                                                    "headers": {
                                                                        "content-type": "application/json"
                                                                    },
                                                                    "method": "POST",
                                                                    "uri": "@{variables('GraphURL')}/teams"
                                                                }
                                                            },
                                                            "Set_TeamsTemplateOperation_variable_-_from_template": {
                                                                "runAfter": {
                                                                    "Wait_for_team_to_provision": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "SetVariable",
                                                                "inputs": {
                                                                    "name": "TeamsTemplateOperation",
                                                                    "value": "template"
                                                                }
                                                            },
                                                            "Wait_for_team_to_provision": {
                                                                "runAfter": {
                                                                    "Create_team_from_group": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "Wait",
                                                                "inputs": {
                                                                    "interval": {
                                                                        "count": 2,
                                                                        "unit": "Minute"
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    },
                                                    "expression": {
                                                        "and": [
                                                            {
                                                                "equals": [
                                                                    "@triggerBody()?['TeamsTemplate']",
                                                                    "standard"
                                                                ]
                                                            }
                                                        ]
                                                    },
                                                    "type": "If",
                                                    "description": "Check if the template is standard (no template). If it is standard, we will use the v1.0 Graph API to teamify the group otherwise we will use the beta API to add a team to the group."
                                                }
                                            },
                                            "runAfter": {
                                                "Set_GroupID_variable": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "equals": [
                                                            "@triggerBody()?['SpaceTypeInternal']",
                                                            "Microsoft Teams Team"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "type": "If",
                                            "description": "Check if the requested space is a team."
                                        },
                                        "Parse_Group_JSON": {
                                            "runAfter": {
                                                "Wait_for_group_to_provision": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ParseJson",
                                            "inputs": {
                                                "content": "@body('Provision_Group')",
                                                "schema": {
                                                    "properties": {
                                                        "@@odata.context": {
                                                            "type": "string"
                                                        },
                                                        "classification": {},
                                                        "createdDateTime": {
                                                            "type": "string"
                                                        },
                                                        "creationOptions": {
                                                            "type": "array"
                                                        },
                                                        "deletedDateTime": {},
                                                        "description": {
                                                            "type": [
                                                                "string",
                                                                "null"
                                                            ]
                                                        },
                                                        "displayName": {
                                                            "type": "string"
                                                        },
                                                        "groupTypes": {
                                                            "items": {
                                                                "type": "string"
                                                            },
                                                            "type": "array"
                                                        },
                                                        "id": {
                                                            "type": "string"
                                                        },
                                                        "mail": {
                                                            "type": "string"
                                                        },
                                                        "mailEnabled": {
                                                            "type": "boolean"
                                                        },
                                                        "mailNickname": {
                                                            "type": "string"
                                                        },
                                                        "onPremisesLastSyncDateTime": {},
                                                        "onPremisesProvisioningErrors": {
                                                            "type": "array"
                                                        },
                                                        "onPremisesSecurityIdentifier": {},
                                                        "onPremisesSyncEnabled": {},
                                                        "preferredDataLocation": {},
                                                        "proxyAddresses": {
                                                            "items": {
                                                                "type": "string"
                                                            },
                                                            "type": "array"
                                                        },
                                                        "renewedDateTime": {
                                                            "type": "string"
                                                        },
                                                        "resourceBehaviorOptions": {
                                                            "type": "array"
                                                        },
                                                        "resourceProvisioningOptions": {
                                                            "type": "array"
                                                        },
                                                        "securityEnabled": {
                                                            "type": "boolean"
                                                        },
                                                        "visibility": {
                                                            "type": "string"
                                                        }
                                                    },
                                                    "type": "object"
                                                }
                                            }
                                        },
                                        "Provision_Group": {
                                            "runAfter": {
                                                "Check_for_members": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Http",
                                            "inputs": {
                                                "authentication": {
                                                    "audience": "https://graph.microsoft.com",
                                                    "clientId": "@body('Get_Client_ID')?['value']",
                                                    "password": "@null",
                                                    "pfx": "@body('Get_Certificate')?['value']",
                                                    "tenant": "@variables('TenantID')",
                                                    "type": "ActiveDirectoryOAuth"
                                                },
                                                "body": "@variables('MembersRequestBody')",
                                                "headers": {
                                                    "content-type": "application/json"
                                                },
                                                "method": "POST",
                                                "uri": "@{variables('GraphURL')}/groups/"
                                            }
                                        },
                                        "Set_GroupID_variable": {
                                            "runAfter": {
                                                "Parse_Group_JSON": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "SetVariable",
                                            "inputs": {
                                                "name": "GroupID",
                                                "value": "@body('Parse_Group_JSON')?['id']"
                                            }
                                        },
                                        "Wait_for_group_to_provision": {
                                            "runAfter": {
                                                "Provision_Group": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Wait",
                                            "inputs": {
                                                "interval": {
                                                    "count": 3,
                                                    "unit": "Minute"
                                                }
                                            }
                                        }
                                    },
                                    "runAfter": {},
                                    "else": {
                                        "actions": {
                                            "Clone_team": {
                                                "runAfter": {},
                                                "type": "Http",
                                                "inputs": {
                                                    "authentication": {
                                                        "audience": "https://graph.microsoft.com",
                                                        "clientId": "@body('Get_Client_ID')?['value']",
                                                        "password": "@null",
                                                        "pfx": "@body('Get_Certificate')?['value']",
                                                        "tenant": "@variables('TenantID')",
                                                        "type": "ActiveDirectoryOAuth"
                                                    },
                                                    "body": {
                                                        "classification": "@if(empty(triggerBody()?['Classification']),null,triggerBody()?['Classification'])",
                                                        "description": "@{triggerBody()?['Description']}",
                                                        "displayName": "@{If(equals(variables('UseNamingConventions'),true),If(and(equals(empty(triggerBody()?['Prefix']),true),equals(empty(triggerBody()?['Suffix']),true)),triggerBody()?['Title'],concat(triggerBody()?['Prefix'],triggerBody()?['SiteAlias'],triggerBody()?['Suffix'])),triggerBody()?['Title'])}",
                                                        "mailNickname": "@{triggerBody()?['MailboxAlias']}",
                                                        "partsToClone": "apps,tabs,settings,channels",
                                                        "visibility": "@{triggerBody()?['Visibility']?['Value']}"
                                                    },
                                                    "headers": {
                                                        "content-type": "application/json"
                                                    },
                                                    "method": "POST",
                                                    "uri": "@{variables('GraphURL')}/teams/@{triggerBody()?['TeamsTemplate']}/clone"
                                                }
                                            },
                                            "Set_TeamsTemplateOperation_variable_-_clone_team": {
                                                "runAfter": {
                                                    "Clone_team": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "TeamsTemplateOperation",
                                                    "value": "clone"
                                                }
                                            },
                                            "Wait_for_team_to_clone": {
                                                "runAfter": {
                                                    "Set_TeamsTemplateOperation_variable_-_clone_team": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Wait",
                                                "inputs": {
                                                    "interval": {
                                                        "count": 2,
                                                        "unit": "Minute"
                                                    }
                                                }
                                            }
                                        }
                                    },
                                    "expression": {
                                        "or": [
                                            {
                                                "equals": [
                                                    "@triggerBody()?['TeamsTemplate']",
                                                    "standard"
                                                ]
                                            },
                                            {
                                                "equals": [
                                                    "@empty(triggerBody()?['TeamsTemplate'])",
                                                    "@true"
                                                ]
                                            },
                                            {
                                                "equals": [
                                                    "@triggerBody()?['SpaceTypeInternal']",
                                                    "Office 365 Group"
                                                ]
                                            },
                                            {
                                                "equals": [
                                                    "@triggerBody()?['AdminCenterTemplate']",
                                                    "@true"
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If",
                                    "description": "Check if we should create an Office 365 Group or a Teams Team from a standard template (no template) or a template defined in the admin center."
                                }
                            },
                            "runAfter": {
                                "Parse_Owners_JSON": [
                                    "Succeeded"
                                ]
                            },
                            "else": {
                                "actions": {
                                    "Check_if_space_type_is_SharePoint_site": {
                                        "actions": {
                                            "Build_sitedesign_JSON_properties": {
                                                "runAfter": {},
                                                "type": "Compose",
                                                "inputs": "@if(equals(triggerBody()?['SiteTemplate'],'6142d2a0-63a5-4ba0-aede-d9fefca2c767'),',\"SiteDesignId\":\"6142d2a0-63a5-4ba0-aede-d9fefca2c767\",\"WebTemplateExtensionId\":\"00000000-0000-0000-0000-000000000000\"',if(equals(triggerBody()?['SiteTemplate'],'f6cc5403-0d63-442e-96c0-285923709ffc'),',\"SiteDesignId\":\"f6cc5403-0d63-442e-96c0-285923709ffc\",\"WebTemplateExtensionId\":\"00000000-0000-0000-0000-000000000000\"',if(equals(empty(triggerBody()?['SiteTemplate']),true),'',concat(',\"SiteDesignId\":\"00000000-0000-0000-0000-000000000000\",\"WebTemplateExtensionId\":\"',triggerBody()?['SiteTemplate'],'\"'))))"
                                            },
                                            "Create_Site": {
                                                "runAfter": {
                                                    "Set_SiteCreationBody_variable": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Http",
                                                "inputs": {
                                                    "authentication": {
                                                        "audience": "[parameters('spoRootSiteUrl')]",
                                                        "clientId": "@body('Get_Client_ID')?['value']",
                                                        "password": "@null",
                                                        "pfx": "@body('Get_Certificate')?['value']",
                                                        "tenant": "@variables('TenantID')",
                                                        "type": "ActiveDirectoryOAuth"
                                                    },
                                                    "body": "@variables('SiteCreationBody')",
                                                    "headers": {
                                                        "Accept": "application/json;odata=verbose",
                                                        "Content-Type": "application/json"
                                                    },
                                                    "method": "POST",
                                                    "uri": "[concat(parameters('requestsSiteUrl'),'/_api/SPSiteManager/create')]"
                                                }
                                            },
                                            "Set_SiteCreationBody_variable": {
                                                "runAfter": {
                                                    "Build_sitedesign_JSON_properties": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "SetVariable",
                                                "inputs": {
                                                    "name": "SiteCreationBody",
                                                    "value": "{\n  \"request\": {\n    \"Description\": \"@{triggerBody()?['Description']}\",\n    \"Lcid\": 1033,\n    \"Owner\": \"@{first(variables('OwnerUPNs'))}\",\n    \"ShareByEmailEnabled\": false,\n@{if(equals(empty(triggerBody()?['SensitivityLabelId']),true),'',concat('\"SensitivityLabel\":\"',triggerBody()?['SensitivityLabelId'],'\",'))}\n    \"Title\": \"@{If(equals(variables('UseNamingConventions'), true), If(and(equals(empty(triggerBody()?['Prefix']), true), equals(empty(triggerBody()?['Suffix']), true)), triggerBody()?['Title'], concat(triggerBody()?['Prefix'], triggerBody()?['SiteAlias'], triggerBody()?['Suffix'])), triggerBody()?['Title'])}\",\n    \"Url\": \"@{triggerBody()?['SiteURL']}\",\n    \"WebTemplate\": \"@{variables('WebTemplate')}\"\n@{outputs('Build_sitedesign_JSON_properties')}\n  }\n}\n"
                                                }
                                            },
                                            "Wait_for_site_to_provision": {
                                                "runAfter": {
                                                    "Create_Site": [
                                                        "Succeeded"
                                                    ]
                                                },
                                                "type": "Wait",
                                                "inputs": {
                                                    "interval": {
                                                        "count": 2,
                                                        "unit": "Minute"
                                                    }
                                                }
                                            }
                                        },
                                        "runAfter": {},
                                        "else": {
                                            "actions": {
                                                "Check_if_space_type_is_a_Viva_engage_Community": {
                                                    "actions": {
                                                        "Provision_Viva_engage_Community": {
                                                            "actions": {
                                                                "Get_viva_engage_unified_group": {
                                                                    "runAfter": {
                                                                        "Parse_Viva_Engage_community_JSON": [
                                                                            "Succeeded"
                                                                        ]
                                                                    },
                                                                    "type": "Http",
                                                                    "inputs": {
                                                                        "uri": "@{variables('GraphURL')}/groups/@{body('Parse_Viva_Engage_community_JSON')?['groupId']}",
                                                                        "method": "GET",
                                                                        "headers": {
                                                                            "content-type": "application/json"
                                                                        },
                                                                        "authentication": {
                                                                            "type": "ActiveDirectoryOAuth",
                                                                            "authority": "",
                                                                            "tenant": "@{variables('TenantID')}",
                                                                            "audience": "https://graph.microsoft.com",
                                                                            "clientId": "@{body('Get_Client_ID')?['value']}",
                                                                            "pfx": "@{body('Get_Certificate')?['value']}",
                                                                            "password": ""
                                                                        }
                                                                    }
                                                                },
                                                                "Get_viva_engage_unified_group_owners": {
                                                                    "runAfter": {
                                                                        "Parse_viva_engage_unified_group_JSON": [
                                                                            "Succeeded"
                                                                        ]
                                                                    },
                                                                    "type": "Http",
                                                                    "inputs": {
                                                                        "uri": "@{variables('GraphURL')}/groups/@{body('Parse_Viva_Engage_community_JSON')?['groupId']}/owners",
                                                                        "method": "GET",
                                                                        "headers": {
                                                                            "content-type": "application/json"
                                                                        },
                                                                        "authentication": {
                                                                            "type": "ActiveDirectoryOAuth",
                                                                            "authority": "",
                                                                            "tenant": "@{variables('TenantID')}",
                                                                            "audience": "https://graph.microsoft.com",
                                                                            "clientId": "@{body('Get_Client_ID')?['value']}",
                                                                            "pfx": "@{body('Get_Certificate')?['value']}",
                                                                            "password": ""
                                                                        }
                                                                    }
                                                                },
                                                                "Loop_through_members_-_Viva_engage_group": {
                                                                    "foreach": "@variables('MemberIDs')",
                                                                    "actions": {
                                                                        "Add_viva_engage_group_member": {
                                                                            "type": "Http",
                                                                            "inputs": {
                                                                                "uri": "@{variables('GraphURL')}/groups/@{body('Parse_Viva_Engage_community_JSON')?['groupId']}/members/$ref",
                                                                                "method": "POST",
                                                                                "headers": {
                                                                                    "content-type": "application/json"
                                                                                },
                                                                                "body": {
                                                                                    "@@odata.id": "https://graph.microsoft.com/v1.0/users/@{items('Loop_through_members_-_viva_engage_group')}"
                                                                                },
                                                                                "authentication": {
                                                                                    "type": "ActiveDirectoryOAuth",
                                                                                    "tenant": "@{variables('TenantID')}",
                                                                                    "audience": "https://graph.microsoft.com",
                                                                                    "clientId": "@{body('Get_Client_ID')?['value']}",
                                                                                    "pfx": "@{body('Get_Certificate')?['value']}",
                                                                                    "password": "@{null}"
                                                                                }
                                                                            }
                                                                        }
                                                                    },
                                                                    "runAfter": {
                                                                        "Parse_viva_engage_unified_group_owners": [
                                                                            "Succeeded"
                                                                        ]
                                                                    },
                                                                    "type": "Foreach"
                                                                },
                                                                "Loop_through_owners_-_Viva_engage_group": {
                                                                    "foreach": "@variables('Owners')",
                                                                    "actions": {
                                                                        "Check_if_owner_does_not_already_exist_in_the_viva_engage_group": {
                                                                            "actions": {
                                                                                "Add_viva_engage_group_owner": {
                                                                                    "type": "Http",
                                                                                    "inputs": {
                                                                                        "uri": "@{variables('GraphURL')}/groups/@{body('Parse_Viva_Engage_community_JSON')?['groupId']}/owners/$ref",
                                                                                        "method": "POST",
                                                                                        "headers": {
                                                                                            "content-type": "application/json"
                                                                                        },
                                                                                        "body": {
                                                                                            "@@odata.id": "https://graph.microsoft.com/v1.0/users/@{items('Loop_through_Owners_-_Viva_engage_group')?['ID']}"
                                                                                        },
                                                                                        "authentication": {
                                                                                            "type": "ActiveDirectoryOAuth",
                                                                                            "authority": "",
                                                                                            "tenant": "@{variables('TenantID')}",
                                                                                            "audience": "https://graph.microsoft.com",
                                                                                            "clientId": "@{body('Get_Client_ID')?['value']}",
                                                                                            "pfx": "@{body('Get_Certificate')?['value']}",
                                                                                            "password": ""
                                                                                        }
                                                                                    },
                                                                                    "description": "Use the graph to add the owners to the unified group. This will sync with Viva engage and the owners will become Viva engage community admins."
                                                                                }
                                                                            },
                                                                            "else": {
                                                                                "actions": {}
                                                                            },
                                                                            "expression": {
                                                                                "and": [
                                                                                    {
                                                                                        "not": {
                                                                                            "contains": [
                                                                                                "@string(body('Parse_viva_engage_unified_group_owners'))",
                                                                                                "@items('Loop_through_owners_-_Viva_engage_group')?['ID']"
                                                                                            ]
                                                                                        }
                                                                                    }
                                                                                ]
                                                                            },
                                                                            "type": "If"
                                                                        }
                                                                    },
                                                                    "runAfter": {
                                                                        "Loop_through_members_-_Viva_engage_group": [
                                                                            "Succeeded"
                                                                        ]
                                                                    },
                                                                    "type": "Foreach"
                                                                },
                                                                "Parse_viva_engage_unified_group_JSON": {
                                                                    "runAfter": {
                                                                        "Get_viva_engage_unified_group": [
                                                                            "Succeeded"
                                                                        ]
                                                                    },
                                                                    "type": "ParseJson",
                                                                    "inputs": {
                                                                        "content": "@body('Get_viva_engage_unified_group')",
                                                                        "schema": {
                                                                            "properties": {
                                                                                "@@odata.context": {
                                                                                    "type": "string"
                                                                                },
                                                                                "value": {
                                                                                    "items": {
                                                                                        "properties": {
                                                                                            "classification": {
                                                                                                "type": [
                                                                                                    "string",
                                                                                                    "null"
                                                                                                ]
                                                                                            },
                                                                                            "createdDateTime": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "creationOptions": {
                                                                                                "items": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "type": "array"
                                                                                            },
                                                                                            "deletedDateTime": {
                                                                                            },
                                                                                            "description": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "displayName": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "expirationDateTime": {
                                                                                            },
                                                                                            "groupTypes": {
                                                                                                "items": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "type": "array"
                                                                                            },
                                                                                            "id": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "isAssignableToRole": {
                                                                                            },
                                                                                            "mail": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "mailEnabled": {
                                                                                                "type": "boolean"
                                                                                            },
                                                                                            "mailNickname": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "membershipRule": {
                                                                                            },
                                                                                            "membershipRuleProcessingState": {
                                                                                            },
                                                                                            "onPremisesDomainName": {
                                                                                            },
                                                                                            "onPremisesLastSyncDateTime": {
                                                                                            },
                                                                                            "onPremisesNetBiosName": {
                                                                                            },
                                                                                            "onPremisesProvisioningErrors": {
                                                                                                "type": "array"
                                                                                            },
                                                                                            "onPremisesSamAccountName": {
                                                                                            },
                                                                                            "onPremisesSecurityIdentifier": {
                                                                                            },
                                                                                            "onPremisesSyncEnabled": {
                                                                                            },
                                                                                            "preferredDataLocation": {
                                                                                            },
                                                                                            "preferredLanguage": {
                                                                                            },
                                                                                            "proxyAddresses": {
                                                                                                "items": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "type": "array"
                                                                                            },
                                                                                            "renewedDateTime": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "resourceBehaviorOptions": {
                                                                                                "items": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "type": "array"
                                                                                            },
                                                                                            "resourceProvisioningOptions": {
                                                                                                "type": "array"
                                                                                            },
                                                                                            "securityEnabled": {
                                                                                                "type": "boolean"
                                                                                            },
                                                                                            "securityIdentifier": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "theme": {
                                                                                            },
                                                                                            "visibility": {
                                                                                                "type": "string"
                                                                                            }
                                                                                        },
                                                                                        "required": [
                                                                                            "id",
                                                                                            "deletedDateTime",
                                                                                            "classification",
                                                                                            "createdDateTime",
                                                                                            "creationOptions",
                                                                                            "description",
                                                                                            "displayName",
                                                                                            "expirationDateTime",
                                                                                            "groupTypes",
                                                                                            "isAssignableToRole",
                                                                                            "mail",
                                                                                            "mailEnabled",
                                                                                            "mailNickname",
                                                                                            "membershipRule",
                                                                                            "membershipRuleProcessingState",
                                                                                            "onPremisesDomainName",
                                                                                            "onPremisesLastSyncDateTime",
                                                                                            "onPremisesNetBiosName",
                                                                                            "onPremisesSamAccountName",
                                                                                            "onPremisesSecurityIdentifier",
                                                                                            "onPremisesSyncEnabled",
                                                                                            "preferredDataLocation",
                                                                                            "preferredLanguage",
                                                                                            "proxyAddresses",
                                                                                            "renewedDateTime",
                                                                                            "resourceBehaviorOptions",
                                                                                            "resourceProvisioningOptions",
                                                                                            "securityEnabled",
                                                                                            "securityIdentifier",
                                                                                            "theme",
                                                                                            "visibility",
                                                                                            "onPremisesProvisioningErrors"
                                                                                        ],
                                                                                        "type": "object"
                                                                                    },
                                                                                    "type": "array"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        }
                                                                    }
                                                                },
                                                                "Parse_viva_engage_unified_group_owners": {
                                                                    "runAfter": {
                                                                        "Get_viva_engage_unified_group_owners": [
                                                                            "Succeeded"
                                                                        ]
                                                                    },
                                                                    "type": "ParseJson",
                                                                    "inputs": {
                                                                        "content": "@body('Get_viva_engage_unified_group_owners')",
                                                                        "schema": {
                                                                            "properties": {
                                                                                "@@odata.context": {
                                                                                    "type": "string"
                                                                                },
                                                                                "value": {
                                                                                    "items": {
                                                                                        "properties": {
                                                                                            "@@odata.type": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "accountEnabled": {
                                                                                                "type": "boolean"
                                                                                            },
                                                                                            "ageGroup": {
                                                                                            },
                                                                                            "assignedLicenses": {
                                                                                                "items": {
                                                                                                    "properties": {
                                                                                                        "disabledPlans": {
                                                                                                            "type": "array"
                                                                                                        },
                                                                                                        "skuId": {
                                                                                                            "type": "string"
                                                                                                        }
                                                                                                    },
                                                                                                    "required": [
                                                                                                        "disabledPlans",
                                                                                                        "skuId"
                                                                                                    ],
                                                                                                    "type": "object"
                                                                                                },
                                                                                                "type": "array"
                                                                                            },
                                                                                            "assignedPlans": {
                                                                                                "items": {
                                                                                                    "properties": {
                                                                                                        "assignedDateTime": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "capabilityStatus": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "service": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "servicePlanId": {
                                                                                                            "type": "string"
                                                                                                        }
                                                                                                    },
                                                                                                    "required": [
                                                                                                        "assignedDateTime",
                                                                                                        "capabilityStatus",
                                                                                                        "service",
                                                                                                        "servicePlanId"
                                                                                                    ],
                                                                                                    "type": "object"
                                                                                                },
                                                                                                "type": "array"
                                                                                            },
                                                                                            "businessPhones": {
                                                                                                "items": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "type": "array"
                                                                                            },
                                                                                            "city": {
                                                                                            },
                                                                                            "companyName": {
                                                                                            },
                                                                                            "consentProvidedForMinor": {
                                                                                            },
                                                                                            "country": {
                                                                                                "type": [
                                                                                                    "string",
                                                                                                    "null"
                                                                                                ]
                                                                                            },
                                                                                            "createdDateTime": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "creationType": {
                                                                                            },
                                                                                            "deletedDateTime": {
                                                                                            },
                                                                                            "department": {
                                                                                            },
                                                                                            "deviceKeys": {
                                                                                                "type": "array"
                                                                                            },
                                                                                            "displayName": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "employeeId": {
                                                                                            },
                                                                                            "externalUserState": {
                                                                                            },
                                                                                            "externalUserStateChangeDateTime": {
                                                                                            },
                                                                                            "faxNumber": {
                                                                                            },
                                                                                            "givenName": {
                                                                                                "type": [
                                                                                                    "string",
                                                                                                    "null"
                                                                                                ]
                                                                                            },
                                                                                            "id": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "identities": {
                                                                                                "items": {
                                                                                                    "properties": {
                                                                                                        "issuer": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "issuerAssignedId": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "signInType": {
                                                                                                            "type": "string"
                                                                                                        }
                                                                                                    },
                                                                                                    "required": [
                                                                                                        "signInType",
                                                                                                        "issuer",
                                                                                                        "issuerAssignedId"
                                                                                                    ],
                                                                                                    "type": "object"
                                                                                                },
                                                                                                "type": "array"
                                                                                            },
                                                                                            "imAddresses": {
                                                                                                "items": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "type": "array"
                                                                                            },
                                                                                            "isResourceAccount": {
                                                                                            },
                                                                                            "jobTitle": {
                                                                                            },
                                                                                            "legalAgeGroupClassification": {
                                                                                            },
                                                                                            "mail": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "mailNickname": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "mobilePhone": {
                                                                                                "type": [
                                                                                                    "string",
                                                                                                    "null"
                                                                                                ]
                                                                                            },
                                                                                            "officeLocation": {
                                                                                            },
                                                                                            "onPremisesDistinguishedName": {
                                                                                            },
                                                                                            "onPremisesDomainName": {
                                                                                            },
                                                                                            "onPremisesExtensionAttributes": {
                                                                                                "properties": {
                                                                                                    "extensionAttribute1": {
                                                                                                    },
                                                                                                    "extensionAttribute10": {
                                                                                                    },
                                                                                                    "extensionAttribute11": {
                                                                                                    },
                                                                                                    "extensionAttribute12": {
                                                                                                    },
                                                                                                    "extensionAttribute13": {
                                                                                                    },
                                                                                                    "extensionAttribute14": {
                                                                                                    },
                                                                                                    "extensionAttribute15": {
                                                                                                    },
                                                                                                    "extensionAttribute2": {
                                                                                                    },
                                                                                                    "extensionAttribute3": {
                                                                                                    },
                                                                                                    "extensionAttribute4": {
                                                                                                    },
                                                                                                    "extensionAttribute5": {
                                                                                                    },
                                                                                                    "extensionAttribute6": {
                                                                                                    },
                                                                                                    "extensionAttribute7": {
                                                                                                    },
                                                                                                    "extensionAttribute8": {
                                                                                                    },
                                                                                                    "extensionAttribute9": {
                                                                                                    }
                                                                                                },
                                                                                                "type": "object"
                                                                                            },
                                                                                            "onPremisesImmutableId": {
                                                                                            },
                                                                                            "onPremisesLastSyncDateTime": {
                                                                                            },
                                                                                            "onPremisesProvisioningErrors": {
                                                                                                "type": "array"
                                                                                            },
                                                                                            "onPremisesSamAccountName": {
                                                                                            },
                                                                                            "onPremisesSecurityIdentifier": {
                                                                                            },
                                                                                            "onPremisesSyncEnabled": {
                                                                                            },
                                                                                            "onPremisesUserPrincipalName": {
                                                                                            },
                                                                                            "otherMails": {
                                                                                                "items": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "type": "array"
                                                                                            },
                                                                                            "passwordPolicies": {
                                                                                            },
                                                                                            "passwordProfile": {
                                                                                            },
                                                                                            "postalCode": {
                                                                                            },
                                                                                            "preferredDataLocation": {
                                                                                            },
                                                                                            "preferredLanguage": {
                                                                                                "type": [
                                                                                                    "string",
                                                                                                    "null"
                                                                                                ]
                                                                                            },
                                                                                            "provisionedPlans": {
                                                                                                "items": {
                                                                                                    "properties": {
                                                                                                        "capabilityStatus": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "provisioningStatus": {
                                                                                                            "type": "string"
                                                                                                        },
                                                                                                        "service": {
                                                                                                            "type": "string"
                                                                                                        }
                                                                                                    },
                                                                                                    "required": [
                                                                                                        "capabilityStatus",
                                                                                                        "provisioningStatus",
                                                                                                        "service"
                                                                                                    ],
                                                                                                    "type": "object"
                                                                                                },
                                                                                                "type": "array"
                                                                                            },
                                                                                            "proxyAddresses": {
                                                                                                "items": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "type": "array"
                                                                                            },
                                                                                            "refreshTokensValidFromDateTime": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "showInAddressList": {
                                                                                            },
                                                                                            "signInSessionsValidFromDateTime": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "state": {
                                                                                            },
                                                                                            "streetAddress": {
                                                                                            },
                                                                                            "surname": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "usageLocation": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "userPrincipalName": {
                                                                                                "type": "string"
                                                                                            },
                                                                                            "userType": {
                                                                                                "type": "string"
                                                                                            }
                                                                                        },
                                                                                        "required": [
                                                                                            "@@odata.type",
                                                                                            "id"
                                                                                        ],
                                                                                        "type": "object"
                                                                                    },
                                                                                    "type": "array"
                                                                                }
                                                                            },
                                                                            "type": "object"
                                                                        }
                                                                    }
                                                                },
                                                                "Set_VivaEngageURL_variable": {
                                                                    "runAfter": {
                                                                        "Loop_through_owners_-_Viva_engage_group": [
                                                                            "Succeeded"
                                                                        ]
                                                                    },
                                                                    "type": "SetVariable",
                                                                    "inputs": {
                                                                        "name": "VivaEngageURL",
                                                                        "value": "https://engage.cloud.microsoft/main/groups/@{body('Parse_Viva_Engage_community_JSON')?['id']}"
                                                                    }
                                                                },
                                                                "Create_Viva_engage_community": {
                                                                    "type": "Http",
                                                                    "inputs": {
                                                                        "uri": "@{variables('GraphURL')}/employeeExperience/communities",
                                                                        "method": "POST",
                                                                        "headers": {
                                                                            "content-type": "application/json"
                                                                        },
                                                                        "body": {
                                                                            "displayName": "@{triggerBody()?['SpaceDisplayName']}",
                                                                            "description": "@{triggerBody()?['Description']}",
                                                                            "privacy": "@{triggerBody()?['Visibility']?['Value']}",
                                                                            "owners@odata.bind": "@variables('OwnersGraph')"
                                                                        },
                                                                        "authentication": {
                                                                            "type": "ActiveDirectoryOAuth",
                                                                            "tenant": "@{variables('TenantID')}",
                                                                            "audience": "https://graph.microsoft.com",
                                                                            "clientId": "@{body('Get_Client_ID')?['value']}",
                                                                            "pfx": "@{body('Get_Certificate')?['value']}",
                                                                            "password": "@{null}"
                                                                        }
                                                                    },
                                                                    "runtimeConfiguration": {
                                                                        "contentTransfer": {
                                                                            "transferMode": "Chunked"
                                                                        }
                                                                    }
                                                                },
                                                                "Wait_for_viva_engage_community_to_provision": {
                                                                    "runAfter": {
                                                                        "Create_Viva_engage_community": [
                                                                            "Succeeded"
                                                                        ]
                                                                    },
                                                                    "type": "Wait",
                                                                    "inputs": {
                                                                        "interval": {
                                                                            "count": 2,
                                                                            "unit": "Minute"
                                                                        }
                                                                    }
                                                                },
                                                                "Parse_create_Viva_Engage_community_JSON": {
                                                                    "runAfter": {
                                                                        "Wait_for_viva_engage_community_to_provision": [
                                                                            "Succeeded"
                                                                        ]
                                                                    },
                                                                    "type": "ParseJson",
                                                                    "inputs": {
                                                                        "content": "@body('Create_Viva_engage_community')",
                                                                        "schema": {
                                                                            "type": "object",
                                                                            "properties": {
                                                                                "@@odata.context": {
                                                                                    "type": "string"
                                                                                },
                                                                                "id": {
                                                                                    "type": "string"
                                                                                },
                                                                                "createdDateTime": {
                                                                                    "type": "string"
                                                                                },
                                                                                "lastActionDateTime": {
                                                                                    "type": "string"
                                                                                },
                                                                                "status": {
                                                                                    "type": "string"
                                                                                },
                                                                                "statusDetail": {},
                                                                                "resourceLocation": {
                                                                                    "type": [
                                                                                        "string",
                                                                                        "null"
                                                                                    ]
                                                                                },
                                                                                "operationType": {
                                                                                    "type": "string"
                                                                                },
                                                                                "resourceId": {
                                                                                    "type": [
                                                                                        "string",
                                                                                        "null"
                                                                                    ]
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                },
                                                                "Get_Viva_Engage_community": {
                                                                    "runAfter": {
                                                                        "Until": [
                                                                            "Succeeded"
                                                                        ]
                                                                    },
                                                                    "type": "Http",
                                                                    "inputs": {
                                                                        "uri": "@{variables('GraphURL')}/employeeexperience/communities/@{variables('CommunityID')}",
                                                                        "method": "GET",
                                                                        "headers": {
                                                                            "content-type": "application/json"
                                                                        },
                                                                        "authentication": {
                                                                            "type": "ActiveDirectoryOAuth",
                                                                            "tenant": "@{variables('TenantID')}",
                                                                            "audience": "https://graph.microsoft.com",
                                                                            "clientId": "@{body('Get_Client_ID')?['value']}",
                                                                            "pfx": "@{body('Get_Certificate')?['value']}",
                                                                            "password": "@{null}"
                                                                        }
                                                                    },
                                                                    "runtimeConfiguration": {
                                                                        "contentTransfer": {
                                                                            "transferMode": "Chunked"
                                                                        }
                                                                    }
                                                                },
                                                                "Parse_Viva_Engage_community_JSON": {
                                                                    "runAfter": {
                                                                        "Get_Viva_Engage_community": [
                                                                            "Succeeded"
                                                                        ]
                                                                    },
                                                                    "type": "ParseJson",
                                                                    "inputs": {
                                                                        "content": "@body('Get_Viva_Engage_community')",
                                                                        "schema": {
                                                                            "type": "object",
                                                                            "properties": {
                                                                                "@@odata.context": {
                                                                                    "type": "string"
                                                                                },
                                                                                "@@microsoft.graph.tips": {
                                                                                    "type": "string"
                                                                                },
                                                                                "id": {
                                                                                    "type": "string"
                                                                                },
                                                                                "displayName": {
                                                                                    "type": "string"
                                                                                },
                                                                                "description": {
                                                                                    "type": "string"
                                                                                },
                                                                                "privacy": {
                                                                                    "type": "string"
                                                                                },
                                                                                "groupId": {
                                                                                    "type": "string"
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                },
                                                                "Until": {
                                                                    "actions": {
                                                                        "Get_create_community_operation": {
                                                                            "type": "Http",
                                                                            "inputs": {
                                                                                "uri": "https://graph.microsoft.com/v1.0/employeeExperience/engagementAsyncOperations('@{body('Parse_create_Viva_Engage_community_JSON')?['id']}')",
                                                                                "method": "GET",
                                                                                "headers": {
                                                                                    "content-type": "application/json"
                                                                                },
                                                                                "authentication": {
                                                                                    "type": "ActiveDirectoryOAuth",
                                                                                    "tenant": "@{variables('TenantID')}",
                                                                                    "audience": "https://graph.microsoft.com",
                                                                                    "clientId": "@{body('Get_Client_ID')?['value']}",
                                                                                    "pfx": "@{body('Get_Certificate')?['value']}",
                                                                                    "password": "@{null}"
                                                                                }
                                                                            },
                                                                            "runtimeConfiguration": {
                                                                                "contentTransfer": {
                                                                                    "transferMode": "Chunked"
                                                                                }
                                                                            }
                                                                        },
                                                                        "Parse_create_community_operation_JSON": {
                                                                            "runAfter": {
                                                                                "Get_create_community_operation": [
                                                                                    "Succeeded"
                                                                                ]
                                                                            },
                                                                            "type": "ParseJson",
                                                                            "inputs": {
                                                                                "content": "@body('Get_create_community_operation')",
                                                                                "schema": {
                                                                                    "type": "object",
                                                                                    "properties": {
                                                                                        "@@odata.context": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "id": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "createdDateTime": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "lastActionDateTime": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "status": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "statusDetail": {},
                                                                                        "resourceLocation": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "operationType": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "resourceId": {
                                                                                            "type": "string"
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        },
                                                                        "Check_if_community_has_been_created": {
                                                                            "actions": {
                                                                                "Set_CommunityID_variable": {
                                                                                    "type": "SetVariable",
                                                                                    "inputs": {
                                                                                        "name": "CommunityID",
                                                                                        "value": "@body('Parse_create_community_operation_JSON')?['resourceId']"
                                                                                    }
                                                                                },
                                                                                "Set_IsCommunityCreated_variable": {
                                                                                    "runAfter": {
                                                                                        "Set_CommunityID_variable": [
                                                                                            "Succeeded"
                                                                                        ]
                                                                                    },
                                                                                    "type": "SetVariable",
                                                                                    "inputs": {
                                                                                        "name": "IsCommunityCreated",
                                                                                        "value": true
                                                                                    }
                                                                                }
                                                                            },
                                                                            "runAfter": {
                                                                                "Parse_create_community_operation_JSON": [
                                                                                    "Succeeded"
                                                                                ]
                                                                            },
                                                                            "else": {
                                                                                "actions": {
                                                                                    "Wait_for_operation_to_complete": {
                                                                                        "type": "Wait",
                                                                                        "inputs": {
                                                                                            "interval": {
                                                                                                "count": 2,
                                                                                                "unit": "Minute"
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            },
                                                                            "expression": {
                                                                                "and": [
                                                                                    {
                                                                                        "equals": [
                                                                                            "@body('Parse_create_community_operation_JSON')?['status']",
                                                                                            "succeeded"
                                                                                        ]
                                                                                    }
                                                                                ]
                                                                            },
                                                                            "type": "If"
                                                                        }
                                                                    },
                                                                    "runAfter": {
                                                                        "Parse_create_Viva_Engage_community_JSON": [
                                                                            "Succeeded"
                                                                        ]
                                                                    },
                                                                    "expression": "@equals(variables('IsCommunityCreated'),true)",
                                                                    "limit": {
                                                                        "count": 60,
                                                                        "timeout": "PT1H"
                                                                    },
                                                                    "type": "Until"
                                                                }
                                                            },
                                                            "type": "Scope"
                                                        }
                                                    },
                                                    "else": {
                                                        "actions": {
                                                            "Terminate": {
                                                                "runAfter": {
                                                                    "Update_status_to_creation_failed_-_invalid_space_type": [
                                                                        "Succeeded"
                                                                    ]
                                                                },
                                                                "type": "Terminate",
                                                                "inputs": {
                                                                    "runStatus": "Failed",
                                                                    "runError": {
                                                                        "message": "Invalid Space Type"
                                                                    }
                                                                }
                                                            },
                                                            "Update_status_to_creation_failed_-_invalid_space_type": {
                                                                "runAfter": {
                                                                },
                                                                "type": "ApiConnection",
                                                                "inputs": {
                                                                    "body": {
                                                                        "Status": {
                                                                            "Value": "Space Creation Failed"
                                                                        },
                                                                        "StatusReason": "Invalid provisioning type.",
                                                                        "Title": "@triggerBody()?['Title']"
                                                                    },
                                                                    "host": {
                                                                        "connection": {
                                                                            "name": "@parameters('$connections')['sharepointonline']['connectionId']"
                                                                        }
                                                                    },
                                                                    "method": "patch",
                                                                    "path": "[concat('/datasets/@{encodeURIComponent(encodeURIComponent(',variables('singlequote'),parameters('requestsSiteUrl'),variables('singlequote'),'))}/tables/@{encodeURIComponent(encodeURIComponent(',variables('singlequote'),parameters('requestsListId'),variables('singlequote'),'))}/items/@{encodeURIComponent(triggerBody()?[',variables('singlequote'),'ID',variables('singlequote'),'])}')]"
                                                                }
                                                            }
                                                        }
                                                    },
                                                    "expression": {
                                                        "and": [
                                                            {
                                                                "equals": [
                                                                    "@triggerBody()?['SpaceTypeInternal']",
                                                                    "Viva Engage Community"
                                                                ]
                                                            }
                                                        ]
                                                    },
                                                    "type": "If"
                                                }
                                            }
                                        },
                                        "expression": {
                                            "or": [
                                                {
                                                    "equals": [
                                                        "@triggerBody()?['SpaceTypeInternal']",
                                                        "Team Site"
                                                    ]
                                                },
                                                {
                                                    "equals": [
                                                        "@triggerBody()?['SpaceTypeInternal']",
                                                        "Communication Site"
                                                    ]
                                                },
                                                {
                                                    "equals": [
                                                        "@triggerBody()?['SpaceTypeInternal']",
                                                        "Hub Site"
                                                    ]
                                                }
                                            ]
                                        },
                                        "type": "If"
                                    }
                                }
                            },
                            "expression": {
                                "or": [
                                    {
                                        "equals": [
                                            "@triggerBody()?['SpaceTypeInternal']",
                                            "Office 365 Group"
                                        ]
                                    },
                                    {
                                        "equals": [
                                            "@triggerBody()?['SpaceTypeInternal']",
                                            "Microsoft Teams Team"
                                        ]
                                    }
                                ]
                            },
                            "type": "If"
                        },
                        "Configure_space": {
                            "runAfter": {
                                "Store_expiration_date": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ApiConnection",
                            "inputs": {
                                "body": {
                                    "properties": {
                                        "parameters": {
                                            "Members": "@{outputs('Create_Members_string')}",
                                            "Owners": "@{outputs('Create_Owners_string')}",
                                            "RetentionLabel": "@triggerBody()?['RetentionLabelName']",
                                            "SiteUrl": "@triggerBody()?['SiteURL']",
                                            "TimeZoneId": "@{triggerBody()?['TimeZoneId']}",
                                            "Visitors": "@{outputs('Create_Visitors_string')}",
                                            "applyPnPTemplate": "@{triggerBody()?['ApplyPnPTemplate']}",
                                            "classification": "@triggerBody()?['Classification']",
                                            "defaultExternalSharingSetting": "@variables('DefaultExternalSharingSetting')",
                                            "disableDocSync": "@variables('DisableDocumentSync')",
                                            "enableAllowAccessRequests": "@variables('EnableAllowAccessRequests')",
                                            "externalSharing": "@triggerBody()?['ExternalSharingRequired']",
                                            "featuresToActivate": "@variables('FeaturesToActivate')",
                                            "hubSiteId": "@triggerBody()?['HubSite']",
                                            "joinHub": "@{triggerBody()?['JoinHub']}",
                                            "lcid": "@{triggerBody()?['LCID']}",
                                            "pnpTemplateURL": "@triggerBody()?['PnPTemplateURL']",
                                            "siteTemplateTitle": "@triggerBody()?['SiteTemplateTitle']",
                                            "spaceType": "@triggerBody()?['SpaceType']?['Value']",
                                            "storageQuota": "@variables('StorageQuota')",
                                            "storageQuotaWarning": "@variables('StorageQuotaWarning')",
                                            "syncHubPermissions": "@variables('SyncHubPermissions')",
                                            "themeName": "@triggerBody()?['ThemeName']",
                                            "visibility": "@triggerBody()?['Visibility']?['Value']",
                                            "siteDesignId": "@triggerBody()?['SiteTemplate']"
                                        }
                                    }
                                },
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azureautomation']['connectionId']"
                                    }
                                },
                                "method": "put",
                                "path": "[concat('/subscriptions/@{encodeURIComponent(''',parameters('subscriptionId'),''')}/resourceGroups/@{encodeURIComponent(''',parameters('resourceGroupName'),''')}/providers/Microsoft.Automation/automationAccounts/@{encodeURIComponent(''',parameters('automationAccountName'),''')}/jobs')]",
                                "queries": {
                                    "runbookName": "ConfigureSpace",
                                    "wait": true,
                                    "x-ms-api-version": "2015-10-31"
                                }
                            }
                        },
                        "Create_Members_string": {
                            "runAfter": {
                                "Create_Owners_string": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Compose",
                            "inputs": "@join(variables('MemberUPNs'),',')"
                        },
                        "Create_Owners_string": {
                            "runAfter": {
                                "Set_MembersOwnersCount_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Compose",
                            "inputs": "@join(variables('OwnerUPNs'),',')"
                        },
                        "Create_Visitors_string": {
                            "runAfter": {
                                "Create_Members_string": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Compose",
                            "inputs": "@join(variables('Visitors'),',')"
                        },
                        "Get_Certificate": {
                            "runAfter": {
                                "Get_Client_Secret": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ApiConnection",
                            "inputs": {
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['keyvault']['connectionId']"
                                    }
                                },
                                "method": "get",
                                "path": "[concat('/secrets/@{encodeURIComponent(',variables('singlequote'),parameters('certName'),variables('singlequote'),')}/value')]"
                            }
                        },
                        "Get_Client_ID": {
                            "runAfter": {
                                "Initialize_CommunityID_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ApiConnection",
                            "inputs": {
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['keyvault']['connectionId']"
                                    }
                                },
                                "method": "get",
                                "path": "/secrets/@{encodeURIComponent('appid')}/value"
                            },
                            "description": "Get Azure ad app client id from key vault.",
                            "runtimeConfiguration": {
                                "secureData": {
                                    "properties": [
                                        "inputs",
                                        "outputs"
                                    ]
                                }
                            }
                        },
                        "Get_Client_Secret": {
                            "runAfter": {
                                "Get_Client_ID": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ApiConnection",
                            "inputs": {
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['keyvault']['connectionId']"
                                    }
                                },
                                "method": "get",
                                "path": "/secrets/@{encodeURIComponent('appsecret')}/value"
                            },
                            "description": "Get Azure ad app client id from key vault.",
                            "runtimeConfiguration": {
                                "secureData": {
                                    "properties": [
                                        "inputs",
                                        "outputs"
                                    ]
                                }
                            }
                        },
                        "Get_Settings": {
                            "actions": {
                                "For_each_setting": {
                                    "foreach": "@body('Get_settings_items')?['value']",
                                    "actions": {
                                        "Switch": {
                                            "runAfter": {
                                            },
                                            "cases": {
                                                "Case_CompanyName": {
                                                    "case": "CompanyName",
                                                    "actions": {
                                                        "Set_variable": {
                                                            "runAfter": {
                                                            },
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "CompanyName",
                                                                "value": "@items('For_each_setting')?['Value']"
                                                            }
                                                        }
                                                    }
                                                },
                                                "Case_DefaultExternalSharingSetting": {
                                                    "case": "DefaultExternalSharingSetting",
                                                    "actions": {
                                                        "Set_DefaultExternalSharingSetting_variable": {
                                                            "runAfter": {},
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "DefaultExternalSharingSetting",
                                                                "value": "@{items('For_each_setting')?['ExternalSharingSetting']?['Value']}"
                                                            }
                                                        }
                                                    }
                                                },
                                                "Case_DefaultStorageQuota": {
                                                    "case": "DefaultStorageQuota",
                                                    "actions": {
                                                        "Set_StorageQuota_variable": {
                                                            "runAfter": {},
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "StorageQuota",
                                                                "value": "@int(items('For_each_setting')?['Value'])"
                                                            }
                                                        }
                                                    }
                                                },
                                                "Case_DefaultStorageQuotaWarning": {
                                                    "case": "DefaultStorageQuotaWarning",
                                                    "actions": {
                                                        "Set_StorageQuotaWarning_variable": {
                                                            "runAfter": {},
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "StorageQuotaWarning",
                                                                "value": "@int(items('For_each_setting')?['Value'])"
                                                            }
                                                        }
                                                    }
                                                },
                                                "Case_DisableDocumentSync": {
                                                    "case": "DisableDocumentSync",
                                                    "actions": {
                                                        "Set_DisableDocumentSync_variable": {
                                                            "runAfter": {},
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "DisableDocumentSync",
                                                                "value": "@bool(items('For_each_setting')?['Value'])"
                                                            }
                                                        }
                                                    }
                                                },
                                                "Case_EmailAccentColor": {
                                                    "case": "EmailAccentColor",
                                                    "actions": {
                                                        "Set_EmailAccentColor_variable": {
                                                            "runAfter": {
                                                            },
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "EmailAccentColor",
                                                                "value": "@items('For_each_setting')?['Value']"
                                                            }
                                                        }
                                                    }
                                                },
                                                "Case_EnableAllowAccessRequests": {
                                                    "case": "EnableAllowAccessRequests",
                                                    "actions": {
                                                        "Set_EnableAllowAccessRequests_variable": {
                                                            "runAfter": {},
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "EnableAllowAccessRequests",
                                                                "value": "@bool(items('For_each_setting')?['Value'])"
                                                            }
                                                        }
                                                    }
                                                },
                                                "Case_EnableHubSitePermissionsSync": {
                                                    "case": "EnableHubSitePermissionsSync",
                                                    "actions": {
                                                        "Set_SyncHubPermissions_variable": {
                                                            "runAfter": {},
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "SyncHubPermissions",
                                                                "value": "@bool(items('For_each_setting')?['Value'])"
                                                            }
                                                        }
                                                    }
                                                },
                                                "Case_FeaturesToActivate": {
                                                    "case": "FeaturesToActivate",
                                                    "actions": {
                                                        "Set_FeaturesToActivate_variable": {
                                                            "runAfter": {},
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "FeaturesToActivate",
                                                                "value": "@{items('For_each_setting')?['Value']}"
                                                            }
                                                        }
                                                    }
                                                },
                                                "Case_LogoPath": {
                                                    "case": "LogoPath",
                                                    "actions": {
                                                        "Set_LogoPath_variable": {
                                                            "runAfter": {
                                                            },
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "LogoPath",
                                                                "value": "@items('For_each_setting')?['Value']"
                                                            }
                                                        }
                                                    }
                                                },
                                                "Case_Sensitivity_Labels": {
                                                    "case": "EnableSensitivityLabels",
                                                    "actions": {
                                                        "Set_EnableSensitivityLabels_variable": {
                                                            "runAfter": {},
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "EnableSensitivityLabels",
                                                                "value": "@bool(items('For_each_setting')?['Value'])"
                                                            }
                                                        }
                                                    }
                                                },
                                                "Case_TeamsWelcomeMessage": {
                                                    "case": "TeamsWelcomeMessage",
                                                    "actions": {
                                                        "Set_TeamsWelcomeMessage_variable": {
                                                            "runAfter": {},
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "TeamsWelcomeMessage",
                                                                "value": "@{items('For_each_setting')?['Value']}"
                                                            }
                                                        }
                                                    }
                                                },
                                                "Case_UseNamingConventions": {
                                                    "case": "UseNamingConventions",
                                                    "actions": {
                                                        "Set_UseNamingConventions_variable": {
                                                            "runAfter": {},
                                                            "type": "SetVariable",
                                                            "inputs": {
                                                                "name": "UseNamingConventions",
                                                                "value": "@bool(items('For_each_setting')?['Value'])"
                                                            }
                                                        }
                                                    }
                                                }
                                            },
                                            "default": {
                                                "actions": {}
                                            },
                                            "expression": "@items('For_each_setting')?['Title']",
                                            "type": "Switch"
                                        }
                                    },
                                    "runAfter": {
                                        "Get_settings_items": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "Foreach"
                                },
                                "Get_settings_items": {
                                    "runAfter": {
                                    },
                                    "type": "ApiConnection",
                                    "inputs": {
                                        "host": {
                                            "connection": {
                                                "name": "@parameters('$connections')['sharepointonline']['connectionId']"
                                            }
                                        },
                                        "method": "get",
                                        "path": "[concat('/datasets/@{encodeURIComponent(encodeURIComponent(',variables('singlequote'),parameters('requestsSiteUrl'),variables('singlequote'),'))}/tables/@{encodeURIComponent(encodeURIComponent(',variables('singlequote'),parameters('requestsSettingsListId'),variables('singlequote'),'))}/items')]"
                                    }
                                }
                            },
                            "runAfter": {
                                "Get_service_account_user_profile": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Scope"
                        },
                        "Get_service_account_user_profile": {
                            "runAfter": {
                                "Get_Certificate": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ApiConnection",
                            "inputs": {
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['office365users']['connectionId']"
                                    }
                                },
                                "method": "get",
                                "path": "/codeless/v1.0/users/@{encodeURIComponent(variables('ServiceAccountUPN'))}"
                            }
                        },
                        "Initialize_BetaGraphURL_variable": {
                            "runAfter": {
                                "Initialize_GraphURL_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "BetaGraphURL",
                                        "type": "string",
                                        "value": "https://graph.microsoft.com/beta"
                                    }
                                ]
                            }
                        },
                        "Initialize_ChannelID_variable": {
                            "runAfter": {
                                "Initialize_GroupCreatedDateTime_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "ChannelID",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_CompanyName_variable": {
                            "runAfter": {
                                "Initialize_LogoPath_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "CompanyName",
                                        "type": "String"
                                    }
                                ]
                            }
                        },
                        "Initialize_DefaultExternalSharingSetting_variable": {
                            "runAfter": {
                                "Initialize_EnableAllowAccessRequests_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "DefaultExternalSharingSetting",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_DisableDocumentSync_variable": {
                            "runAfter": {
                                "Initialize_SyncHubPermissions_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "DisableDocumentSync",
                                        "type": "boolean",
                                        "value": "@false"
                                    }
                                ]
                            }
                        },
                        "Initialize_EmailAccentColor_variable": {
                            "runAfter": {
                                "Initialize_Visitors_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "EmailAccentColor",
                                        "type": "String"
                                    }
                                ]
                            }
                        },
                        "Initialize_EnableAllowAccessRequests_variable": {
                            "runAfter": {
                                "Initialize_EnableSensitivityLabels_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "EnableAllowAccessRequests",
                                        "type": "boolean",
                                        "value": "@false"
                                    }
                                ]
                            }
                        },
                        "Initialize_EnableSensitivityLabels_variable": {
                            "runAfter": {
                                "Initialize_SiteTemplateRequestBody_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "EnableSensitivityLabels",
                                        "type": "boolean",
                                        "value": "@false"
                                    }
                                ]
                            }
                        },
                        "Initialize_FeaturesToActivate_variable": {
                            "runAfter": {
                                "Initialize_DisableDocumentSync_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "FeaturesToActivate",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_GraphURL_variable": {
                            "runAfter": {
                                "Initialize_TenantID_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "GraphURL",
                                        "type": "String",
                                        "value": "https://graph.microsoft.com/v1.0"
                                    }
                                ]
                            }
                        },
                        "Initialize_GroupCreatedDateTime_variable": {
                            "runAfter": {
                                "Initialize_GroupID_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "GroupCreatedDateTime",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_GroupID_variable": {
                            "runAfter": {
                                "Initialize_TeamID_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "GroupID",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_Guests_variable": {
                            "runAfter": {
                                "Initialize_TenantName_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "Guests",
                                        "type": "Array"
                                    }
                                ]
                            },
                            "description": "Used to build a collection of guests from the Read,Edit and Full Control columns and send the invitation email."
                        },
                        "Initialize_LogoPath_variable": {
                            "runAfter": {
                                "Initialize_EmailAccentColor_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "LogoPath",
                                        "type": "String"
                                    }
                                ]
                            }
                        },
                        "Initialize_MemberIDs_variable": {
                            "runAfter": {
                                "Initialize_OwnerIDs_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "MemberIDs",
                                        "type": "array"
                                    }
                                ]
                            }
                        },
                        "Initialize_MemberUPNs_variable": {
                            "runAfter": {
                                "Initialize_OwnerUPNs_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "MemberUPNs",
                                        "type": "array"
                                    }
                                ]
                            }
                        },
                        "Initialize_MembersGraph_variable": {
                            "runAfter": {
                                "Initialize_OwnersGraph_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "MembersGraph",
                                        "type": "Array"
                                    }
                                ]
                            }
                        },
                        "Initialize_MembersOwnersCount": {
                            "runAfter": {
                                "Initialize_SiteCreationBody_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "MembersOwnersCount",
                                        "type": "integer"
                                    }
                                ]
                            }
                        },
                        "Initialize_MembersRequestBody_variable": {
                            "runAfter": {
                                "Initialize_MemberUPNs_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "MembersRequestBody",
                                        "type": "String",
                                        "value": "{\"Description\":\"JSON description\",\"Title\":\"JSON 123\"}"
                                    }
                                ]
                            }
                        },
                        "Initialize_Members_variable": {
                            "runAfter": {
                                "Initialize_Owners_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "Members",
                                        "type": "Array"
                                    }
                                ]
                            }
                        },
                        "Initialize_OwnerIDs_variable": {
                            "runAfter": {
                                "Initialize_MembersGraph_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "OwnerIDs",
                                        "type": "array"
                                    }
                                ]
                            }
                        },
                        "Initialize_OwnerUPNs_variable": {
                            "runAfter": {
                                "Initialize_MemberIDs_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "OwnerUPNs",
                                        "type": "array"
                                    }
                                ]
                            }
                        },
                        "Initialize_OwnersGraph_variable": {
                            "runAfter": {
                                "Initialize_Members_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "OwnersGraph",
                                        "type": "Array"
                                    }
                                ]
                            }
                        },
                        "Initialize_Owners_variable": {
                            "runAfter": {
                                "Initialize_BetaGraphURL_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "Owners",
                                        "type": "Array"
                                    }
                                ]
                            }
                        },
                        "Initialize_QuoteMark_variable": {
                            "runAfter": {
                                "Initialize_UseNamingConventions_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "QuoteMark",
                                        "type": "string",
                                        "value": "\""
                                    }
                                ]
                            }
                        },
                        "Initialize_ServiceAccountUPN_variable": {
                            "runAfter": {
                                "Initialize_Guests_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "ServiceAccountUPN",
                                        "type": "string",
                                        "value": "[parameters('serviceAccountUPN')]"
                                    }
                                ]
                            }
                        },
                        "Initialize_SiteCreationBody_variable": {
                            "runAfter": {
                                "Initialize_TeamsWelcomeMessage_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "SiteCreationBody",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_SiteExists_variable": {
                            "runAfter": {
                                "Update_status_to_Space_Creation": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "SiteExists",
                                        "type": "Boolean",
                                        "value": "@false"
                                    }
                                ]
                            }
                        },
                        "Initialize_SiteTemplateRequestBody_variable": {
                            "runAfter": {
                                "Initialize_QuoteMark_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "SiteTemplateRequestBody",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_StorageQuotaWarning_variable": {
                            "runAfter": {
                                "Initialize_StorageQuota_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "StorageQuotaWarning",
                                        "type": "integer"
                                    }
                                ]
                            }
                        },
                        "Initialize_StorageQuota_variable": {
                            "runAfter": {
                                "Initialize_DefaultExternalSharingSetting_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "StorageQuota",
                                        "type": "integer"
                                    }
                                ]
                            }
                        },
                        "Initialize_SyncHubPermissions_variable": {
                            "runAfter": {
                                "Initialize_StorageQuotaWarning_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "SyncHubPermissions",
                                        "type": "boolean",
                                        "value": "@false"
                                    }
                                ]
                            }
                        },
                        "Initialize_TeamID_variable": {
                            "runAfter": {
                                "Initialize_TeamURL_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TeamID",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_TeamURL_variable": {
                            "runAfter": {
                                "Initialize_TeamsTemplateOperation_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TeamURL",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_TeamsTemplateOperation_variable": {
                            "runAfter": {
                                "Initialize_ServiceAccountUPN_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TeamsTemplateOperation",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_TeamsWelcomeMessage_variable": {
                            "runAfter": {
                                "Initialize_FeaturesToActivate_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TeamsWelcomeMessage",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_TemplateVisibility_variable": {
                            "runAfter": {
                                "Initialize_ChannelID_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TemplateVisibility",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_TenantID_variable": {
                            "runAfter": {
                                "Initialize_SiteExists_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TenantID",
                                        "type": "String",
                                        "value": "[parameters('tenantId')]"
                                    }
                                ]
                            }
                        },
                        "Initialize_TenantName_variable": {
                            "runAfter": {
                                "Initialize_WebTemplate_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "TenantName",
                                        "type": "String",
                                        "value": "[parameters('tenantName')]"
                                    }
                                ]
                            }
                        },
                        "Initialize_UseNamingConventions_variable": {
                            "runAfter": {
                                "Initialize_VivaEngageURL_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "UseNamingConventions",
                                        "type": "boolean",
                                        "value": "@false"
                                    }
                                ]
                            }
                        },
                        "Initialize_Visitors_variable": {
                            "runAfter": {
                                "Initialize_MembersRequestBody_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "Visitors",
                                        "type": "Array"
                                    }
                                ]
                            }
                        },
                        "Initialize_VivaEngageURL_variable": {
                            "runAfter": {
                                "Initialize_TemplateVisibility_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "VivaEngageURL",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Initialize_WebTemplate_variable": {
                            "runAfter": {
                                "Initialize_CompanyName_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "WebTemplate",
                                        "type": "String",
                                        "value": "@{if(equals(triggerBody()?['SpaceTypeInternal'],'Team Site'),'STS#3','SITEPAGEPUBLISHING#0')}"
                                    }
                                ]
                            }
                        },
                        "Initialize_IsCommunityCreated_variable": {
                            "runAfter": {
                                "Initialize_MembersOwnersCount": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "IsCommunityCreated",
                                        "type": "boolean",
                                        "value": false
                                    }
                                ]
                            }
                        },
                        "Initialize_CommunityID_variable": {
                            "runAfter": {
                                "Initialize_IsCommunityCreated_variable": [
                                    "Succeeded"
                                ]
                            },
                            "type": "InitializeVariable",
                            "inputs": {
                                "variables": [
                                    {
                                        "name": "CommunityID",
                                        "type": "string"
                                    }
                                ]
                            }
                        },
                        "Invite_guests": {
                            "actions": {
                                "Check_if_external_sharing_is_required": {
                                    "actions": {
                                        "Check_Guests_column_is_populated": {
                                            "actions": {
                                                "Loop_through_Guests_-_invite": {
                                                    "foreach": "@body('Parse_Guests_JSON')",
                                                    "actions": {
                                                        "Append_guest_to_MembersGraph_variable": {
                                                            "runAfter": {
                                                                "Append_guest_to_Members_variable": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "AppendToArrayVariable",
                                                            "inputs": {
                                                                "name": "MembersGraph",
                                                                "value": "https://graph.microsoft.com/v1.0/users/@{items('Loop_through_Guests_-_invite')['GuestId']}\n"
                                                            }
                                                        },
                                                        "Append_guest_to_Members_variable": {
                                                            "runAfter": {
                                                            },
                                                            "type": "AppendToArrayVariable",
                                                            "inputs": {
                                                                "name": "Members",
                                                                "value": "@items('Loop_through_Guests_-_invite')['GuestEmail']"
                                                            }
                                                        },
                                                        "Append_guests_to_Guests_variable": {
                                                            "runAfter": {
                                                                "Append_guest_to_MembersGraph_variable": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "AppendToArrayVariable",
                                                            "inputs": {
                                                                "name": "Guests",
                                                                "value": {
                                                                    "GuestEmail": "@{items('Loop_through_Guests_-_invite')['GuestEmail']}",
                                                                    "InviteRedeemUrl": "@{items('Loop_through_Guests_-_invite')['InviteRedeemUrl']}"
                                                                }
                                                            }
                                                        }
                                                    },
                                                    "runAfter": {
                                                        "Parse_Guests_JSON": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Foreach"
                                                },
                                                "Parse_Guests_JSON": {
                                                    "runAfter": {
                                                        "Process_Guests": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ParseJson",
                                                    "inputs": {
                                                        "content": "@body('Process_Guests')",
                                                        "schema": {
                                                            "items": {
                                                                "properties": {
                                                                    "GuestEmail": {
                                                                        "type": "string"
                                                                    },
                                                                    "GuestId": {
                                                                        "type": "string"
                                                                    },
                                                                    "InviteRedeemUrl": {
                                                                        "type": "string"
                                                                    }
                                                                },
                                                                "required": [
                                                                    "GuestEmail",
                                                                    "GuestId",
                                                                    "InviteRedeemUrl"
                                                                ],
                                                                "type": "object"
                                                            },
                                                            "type": "array"
                                                        }
                                                    }
                                                },
                                                "Process_Guests": {
                                                    "runAfter": {
                                                    },
                                                    "type": "Workflow",
                                                    "inputs": {
                                                        "body": {
                                                            "CompanyName": "@variables('CompanyName')",
                                                            "EmailAccentColor": "@variables('EmailAccentColor')",
                                                            "Guests": "@triggerBody()?['Guests']",
                                                            "LogoPath": "@variables('LogoPath')",
                                                            "SiteTitle": "@triggerBody()?['Title']",
                                                            "SiteUrl": "@{if(equals(triggerBody()?['SpaceType']?['Value'],'Microsoft Teams Team'),variables('TeamURL'),triggerBody()?['SiteURL'])}"
                                                        },
                                                        "host": {
                                                            "triggerName": "manual",
                                                            "workflow": {
                                                                "id": "[concat('/subscriptions/',parameters('subscriptionId'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Logic/workflows/ProcessGuests')]"
                                                            }
                                                        }
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "equals": [
                                                            "@empty(triggerBody()?['Guests'])",
                                                            false
                                                        ]
                                                    }
                                                ]
                                            },
                                            "type": "If"
                                        },
                                        "Check_space_type_-_invite_guests": {
                                            "actions": {
                                                "Check_Guests_JSON_is_not_null": {
                                                    "actions": {
                                                        "Loop_through_guests_in_Guests_JSON": {
                                                            "foreach": "@body('Parse_Guests_JSON')",
                                                            "actions": {
                                                                "Add_guest_members_to_group": {
                                                                    "runAfter": {
                                                                    },
                                                                    "type": "Http",
                                                                    "inputs": {
                                                                        "authentication": {
                                                                            "audience": "https://graph.microsoft.com",
                                                                            "clientId": "@body('Get_Client_ID')?['value']",
                                                                            "password": "@null",
                                                                            "pfx": "@body('Get_Certificate')?['value']",
                                                                            "tenant": "@variables('TenantID')",
                                                                            "type": "ActiveDirectoryOAuth"
                                                                        },
                                                                        "body": {
                                                                            "@@odata.id": "https://graph.microsoft.com/v1.0/directoryObjects/@{items('Loop_through_guests_in_Guests_JSON')['GuestId']}"
                                                                        },
                                                                        "headers": {
                                                                            "content-type": "application/json"
                                                                        },
                                                                        "method": "POST",
                                                                        "uri": "@{variables('GraphURL')}/groups/@{body('Parse_Group_JSON')?['id']}/members/$ref"
                                                                    }
                                                                }
                                                            },
                                                            "runAfter": {
                                                            },
                                                            "type": "Foreach"
                                                        }
                                                    },
                                                    "runAfter": {
                                                    },
                                                    "expression": {
                                                        "and": [
                                                            {
                                                                "not": {
                                                                    "equals": [
                                                                        "@body('Parse_Guests_JSON')",
                                                                        "@null"
                                                                    ]
                                                                }
                                                            }
                                                        ]
                                                    },
                                                    "type": "If"
                                                }
                                            },
                                            "runAfter": {
                                                "Check_Guests_column_is_populated": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "expression": {
                                                "or": [
                                                    {
                                                        "equals": [
                                                            "@triggerBody()?['SpaceTypeInternal']",
                                                            "Office 365 Group"
                                                        ]
                                                    },
                                                    {
                                                        "equals": [
                                                            "@triggerBody()?['SpaceTypeInternal']",
                                                            "Microsoft Teams Team"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "type": "If"
                                        }
                                    },
                                    "runAfter": {
                                    },
                                    "expression": {
                                        "and": [
                                            {
                                                "equals": [
                                                    "@triggerBody()?['ExternalSharing']",
                                                    true
                                                ]
                                            },
                                            {
                                                "not": {
                                                    "equals": [
                                                        "@triggerBody()?['SpaceTypeInternal']",
                                                        "Viva Engage Community"
                                                    ]
                                                }
                                            }
                                        ]
                                    },
                                    "type": "If"
                                }
                            },
                            "runAfter": {
                                "Set_external_sharing": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Scope"
                        },
                        "Loop_through_Members": {
                            "foreach": "@triggerBody()?['Members']",
                            "actions": {
                                "Append_to_MemberIDs_variable": {
                                    "runAfter": {
                                        "Append_to_Members_variable": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "AppendToArrayVariable",
                                    "inputs": {
                                        "name": "MemberIDs",
                                        "value": "@body('Get_member_user_profile')?['id']"
                                    }
                                },
                                "Append_to_MemberUPNs_variable": {
                                    "runAfter": {
                                        "Append_to_MembersGraph_variable": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "AppendToArrayVariable",
                                    "inputs": {
                                        "name": "MemberUPNs",
                                        "value": "@items('Loop_through_Members')?['Email']"
                                    }
                                },
                                "Append_to_MembersGraph_variable": {
                                    "runAfter": {
                                        "Get_member_user_profile": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "AppendToArrayVariable",
                                    "inputs": {
                                        "name": "MembersGraph",
                                        "value": "https://graph.microsoft.com/v1.0/users/@{body('Get_member_user_profile')?['id']}"
                                    }
                                },
                                "Append_to_Members_variable": {
                                    "runAfter": {
                                        "Append_to_MemberUPNs_variable": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "AppendToArrayVariable",
                                    "inputs": {
                                        "name": "Members",
                                        "value": {
                                            "ID": "@{body('Get_member_user_profile')?['id']}",
                                            "MemberUPN": "@{items('Loop_through_Members')?['Email']}"
                                        }
                                    }
                                },
                                "Get_member_user_profile": {
                                    "runAfter": {
                                    },
                                    "type": "ApiConnection",
                                    "inputs": {
                                        "host": {
                                            "connection": {
                                                "name": "@parameters('$connections')['office365users']['connectionId']"
                                            }
                                        },
                                        "method": "get",
                                        "path": "/codeless/v1.0/users/@{encodeURIComponent(items('Loop_through_Members')?['Email'])}"
                                    }
                                }
                            },
                            "runAfter": {
                                "Check_if_space_exists": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Foreach"
                        },
                        "Loop_through_Owners": {
                            "foreach": "@triggerBody()?['Owners']",
                            "actions": {
                                "Append_to_OwnerIDs_variable": {
                                    "runAfter": {
                                        "Append_to_Owners_variable": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "AppendToArrayVariable",
                                    "inputs": {
                                        "name": "OwnerIDs",
                                        "value": "@body('Get_owner_user_profile')?['id']"
                                    }
                                },
                                "Append_to_OwnerUPNs_variable": {
                                    "runAfter": {
                                        "Append_to_OwnersGraph_variable": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "AppendToArrayVariable",
                                    "inputs": {
                                        "name": "OwnerUPNs",
                                        "value": "@items('Loop_through_Owners')?['Email']"
                                    }
                                },
                                "Append_to_OwnersGraph_variable": {
                                    "runAfter": {
                                        "Get_owner_user_profile": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "AppendToArrayVariable",
                                    "inputs": {
                                        "name": "OwnersGraph",
                                        "value": "https://graph.microsoft.com/v1.0/users/@{body('Get_owner_user_profile')?['id']}"
                                    }
                                },
                                "Append_to_Owners_variable": {
                                    "runAfter": {
                                        "Append_to_OwnerUPNs_variable": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "AppendToArrayVariable",
                                    "inputs": {
                                        "name": "Owners",
                                        "value": {
                                            "ID": "@{body('Get_owner_user_profile')?['id']}",
                                            "OwnerUPN": "@{items('Loop_through_Owners')?['Email']}"
                                        }
                                    }
                                },
                                "Check_if_space_is_a_Team_-_add_owners_as_members": {
                                    "actions": {
                                        "Append_Owners_to_MembersGraph_variable": {
                                            "runAfter": {
                                                "Append_Owners_to_Members_variable": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "AppendToArrayVariable",
                                            "inputs": {
                                                "name": "MembersGraph",
                                                "value": "https://graph.microsoft.com/v1.0/users/@{body('Get_owner_user_profile')?['id']}"
                                            }
                                        },
                                        "Append_Owners_to_Members_variable": {
                                            "runAfter": {
                                            },
                                            "type": "AppendToArrayVariable",
                                            "inputs": {
                                                "name": "Members",
                                                "value": "https://graph.microsoft.com/v1.0/users/@{body('Get_owner_user_profile')?['id']}"
                                            }
                                        }
                                    },
                                    "runAfter": {
                                        "Append_to_OwnerIDs_variable": [
                                            "Succeeded"
                                        ]
                                    },
                                    "expression": {
                                        "and": [
                                            {
                                                "equals": [
                                                    "@triggerBody()?['SpaceTypeInternal']",
                                                    "Microsoft Teams Team"
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If",
                                    "description": "Due to a bug when provisioning Teams via the MS Graph (owners cannot create Planner plans), owners must be added as members first."
                                },
                                "Get_owner_user_profile": {
                                    "runAfter": {
                                    },
                                    "type": "ApiConnection",
                                    "inputs": {
                                        "host": {
                                            "connection": {
                                                "name": "@parameters('$connections')['office365users']['connectionId']"
                                            }
                                        },
                                        "method": "get",
                                        "path": "/codeless/v1.0/users/@{encodeURIComponent(items('Loop_through_Owners')?['Email'])}"
                                    }
                                }
                            },
                            "runAfter": {
                                "Check_if_space_exists": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Foreach"
                        },
                        "Loop_through_guests": {
                            "foreach": "@variables('Guests')",
                            "actions": {
                                "Check_if_guest_is_new": {
                                    "actions": {
                                        "Send_guest_invitation_email": {
                                            "runAfter": {
                                            },
                                            "type": "ApiConnection",
                                            "inputs": {
                                                "body": {
                                                    "Body": "<!doctype html>\n<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:o=\"urn:schemas-microsoft-com:office:office\">\n    <head>\n        <!-- NAME: 1 COLUMN -->\n        <!--[if gte mso 15]>\n        <xml>\n            <o:OfficeDocumentSettings>\n            <o:AllowPNG/>\n            <o:PixelsPerInch>96</o:PixelsPerInch>\n            </o:OfficeDocumentSettings>\n        </xml>\n        <![endif]-->\n        <meta charset=\"UTF-8\">\n        <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n        <title>@{variables('CompanyName')} Collaboration Invitation</title>\n        \n    <style type=\"text/css\">\n\t\tp{\n\t\t\tmargin:10px 0;\n\t\t\tpadding:0;\n\t\t}\n\t\ttable{\n\t\t\tborder-collapse:collapse;\n\t\t}\n\t\th1,h2,h3,h4,h5,h6{\n\t\t\tdisplay:block;\n\t\t\tmargin:0;\n\t\t\tpadding:0;\n\t\t}\n\t\timg,a img{\n\t\t\tborder:0;\n\t\t\theight:auto;\n\t\t\toutline:none;\n\t\t\ttext-decoration:none;\n\t\t}\n\t\tbody,#bodyTable,#bodyCell{\n\t\t\theight:100%;\n\t\t\tmargin:0;\n\t\t\tpadding:0;\n\t\t\twidth:100%;\n\t\t}\n\t\t.mcnPreviewText{\n\t\t\tdisplay:none !important;\n\t\t}\n\t\t#outlook a{\n\t\t\tpadding:0;\n\t\t}\n\t\timg{\n\t\t\t-ms-interpolation-mode:bicubic;\n\t\t}\n\t\ttable{\n\t\t\tmso-table-lspace:0pt;\n\t\t\tmso-table-rspace:0pt;\n\t\t}\n\t\t.ReadMsgBody{\n\t\t\twidth:100%;\n\t\t}\n\t\t.ExternalClass{\n\t\t\twidth:100%;\n\t\t}\n\t\tp,a,li,td,blockquote{\n\t\t\tmso-line-height-rule:exactly;\n\t\t}\n\t\ta[href^=tel],a[href^=sms]{\n\t\t\tcolor:inherit;\n\t\t\tcursor:default;\n\t\t\ttext-decoration:none;\n\t\t}\n\t\tp,a,li,td,body,table,blockquote{\n\t\t\t-ms-text-size-adjust:100%;\n\t\t\t-webkit-text-size-adjust:100%;\n\t\t}\n\t\t.ExternalClass,.ExternalClass p,.ExternalClass td,.ExternalClass div,.ExternalClass span,.ExternalClass font{\n\t\t\tline-height:100%;\n\t\t}\n\t\ta[x-apple-data-detectors]{\n\t\t\tcolor:inherit !important;\n\t\t\ttext-decoration:none !important;\n\t\t\tfont-size:inherit !important;\n\t\t\tfont-family:inherit !important;\n\t\t\tfont-weight:inherit !important;\n\t\t\tline-height:inherit !important;\n\t\t}\n\t\t#bodyCell{\n\t\t\tpadding:10px;\n\t\t}\n\t\t.templateContainer{\n\t\t\tmax-width:600px !important;\n\t\t}\n\t\ta.mcnButton{\n\t\t\tdisplay:block;\n\t\t}\n\t\t.mcnImage,.mcnRetinaImage{\n\t\t\tvertical-align:bottom;\n\t\t}\n\t\t.mcnTextContent{\n\t\t\tword-break:break-word;\n\t\t}\n\t\t.mcnTextContent img{\n\t\t\theight:auto !important;\n\t\t}\n\t\t.mcnDividerBlock{\n\t\t\ttable-layout:fixed !important;\n\t\t}\n\t/*\n\t@tab Page\n\t@section Background Style\n\t@tip Set the background color and top border for your email. You may want to choose colors that match your company's branding.\n\t*/\n\t\tbody,#bodyTable{\n\t\t\t/*@editable*/background-color:#FAFAFA;\n\t\t}\n\t/*\n\t@tab Page\n\t@section Background Style\n\t@tip Set the background color and top border for your email. You may want to choose colors that match your company's branding.\n\t*/\n\t\t#bodyCell{\n\t\t\t/*@editable*/border-top:0;\n\t\t}\n\t/*\n\t@tab Page\n\t@section Email Border\n\t@tip Set the border for your email.\n\t*/\n\t\t.templateContainer{\n\t\t\t/*@editable*/border:0;\n\t\t}\n\t/*\n\t@tab Page\n\t@section Heading 1\n\t@tip Set the styling for all first-level headings in your emails. These should be the largest of your headings.\n\t@style heading 1\n\t*/\n\t\th1{\n\t\t\t/*@editable*/color:#202020;\n\t\t\t/*@editable*/font-family:Helvetica;\n\t\t\t/*@editable*/font-size:26px;\n\t\t\t/*@editable*/font-style:normal;\n\t\t\t/*@editable*/font-weight:bold;\n\t\t\t/*@editable*/line-height:125%;\n\t\t\t/*@editable*/letter-spacing:normal;\n\t\t\t/*@editable*/text-align:left;\n\t\t}\n\t/*\n\t@tab Page\n\t@section Heading 2\n\t@tip Set the styling for all second-level headings in your emails.\n\t@style heading 2\n\t*/\n\t\th2{\n\t\t\t/*@editable*/color:#202020;\n\t\t\t/*@editable*/font-family:Helvetica;\n\t\t\t/*@editable*/font-size:22px;\n\t\t\t/*@editable*/font-style:normal;\n\t\t\t/*@editable*/font-weight:bold;\n\t\t\t/*@editable*/line-height:125%;\n\t\t\t/*@editable*/letter-spacing:normal;\n\t\t\t/*@editable*/text-align:left;\n\t\t}\n\t/*\n\t@tab Page\n\t@section Heading 3\n\t@tip Set the styling for all third-level headings in your emails.\n\t@style heading 3\n\t*/\n\t\th3{\n\t\t\t/*@editable*/color:#202020;\n\t\t\t/*@editable*/font-family:Helvetica;\n\t\t\t/*@editable*/font-size:20px;\n\t\t\t/*@editable*/font-style:normal;\n\t\t\t/*@editable*/font-weight:bold;\n\t\t\t/*@editable*/line-height:125%;\n\t\t\t/*@editable*/letter-spacing:normal;\n\t\t\t/*@editable*/text-align:left;\n\t\t}\n\t/*\n\t@tab Page\n\t@section Heading 4\n\t@tip Set the styling for all fourth-level headings in your emails. These should be the smallest of your headings.\n\t@style heading 4\n\t*/\n\t\th4{\n\t\t\t/*@editable*/color:#202020;\n\t\t\t/*@editable*/font-family:Helvetica;\n\t\t\t/*@editable*/font-size:18px;\n\t\t\t/*@editable*/font-style:normal;\n\t\t\t/*@editable*/font-weight:bold;\n\t\t\t/*@editable*/line-height:125%;\n\t\t\t/*@editable*/letter-spacing:normal;\n\t\t\t/*@editable*/text-align:left;\n\t\t}\n\t/*\n\t@tab Preheader\n\t@section Preheader Style\n\t@tip Set the background color and borders for your email's preheader area.\n\t*/\n\t\t#templatePreheader{\n\t\t\t/*@editable*/background-color:#FAFAFA;\n\t\t\t/*@editable*/background-image:none;\n\t\t\t/*@editable*/background-repeat:no-repeat;\n\t\t\t/*@editable*/background-position:center;\n\t\t\t/*@editable*/background-size:cover;\n\t\t\t/*@editable*/border-top:0;\n\t\t\t/*@editable*/border-bottom:0;\n\t\t\t/*@editable*/padding-top:9px;\n\t\t\t/*@editable*/padding-bottom:9px;\n\t\t}\n\t/*\n\t@tab Preheader\n\t@section Preheader Text\n\t@tip Set the styling for your email's preheader text. Choose a size and color that is easy to read.\n\t*/\n\t\t#templatePreheader .mcnTextContent,#templatePreheader .mcnTextContent p{\n\t\t\t/*@editable*/color:#656565;\n\t\t\t/*@editable*/font-family:Helvetica;\n\t\t\t/*@editable*/font-size:12px;\n\t\t\t/*@editable*/line-height:150%;\n\t\t\t/*@editable*/text-align:left;\n\t\t}\n\t/*\n\t@tab Preheader\n\t@section Preheader Link\n\t@tip Set the styling for your email's preheader links. Choose a color that helps them stand out from your text.\n\t*/\n\t\t#templatePreheader .mcnTextContent a,#templatePreheader .mcnTextContent p a{\n\t\t\t/*@editable*/color:#656565;\n\t\t\t/*@editable*/font-weight:normal;\n\t\t\t/*@editable*/text-decoration:underline;\n\t\t}\n\t/*\n\t@tab Header\n\t@section Header Style\n\t@tip Set the background color and borders for your email's header area.\n\t*/\n\t\t#templateHeader{\n\t\t\t/*@editable*/background-color:#FFFFFF;\n\t\t\t/*@editable*/background-image:none;\n\t\t\t/*@editable*/background-repeat:no-repeat;\n\t\t\t/*@editable*/background-position:center;\n\t\t\t/*@editable*/background-size:cover;\n\t\t\t/*@editable*/border-top:0;\n\t\t\t/*@editable*/border-bottom:0;\n\t\t\t/*@editable*/padding-top:9px;\n\t\t\t/*@editable*/padding-bottom:0;\n\t\t}\n\t/*\n\t@tab Header\n\t@section Header Text\n\t@tip Set the styling for your email's header text. Choose a size and color that is easy to read.\n\t*/\n\t\t#templateHeader .mcnTextContent,#templateHeader .mcnTextContent p{\n\t\t\t/*@editable*/color:#202020;\n\t\t\t/*@editable*/font-family:Helvetica;\n\t\t\t/*@editable*/font-size:16px;\n\t\t\t/*@editable*/line-height:150%;\n\t\t\t/*@editable*/text-align:left;\n\t\t}\n\t/*\n\t@tab Header\n\t@section Header Link\n\t@tip Set the styling for your email's header links. Choose a color that helps them stand out from your text.\n\t*/\n\t\t#templateHeader .mcnTextContent a,#templateHeader .mcnTextContent p a{\n\t\t\t/*@editable*/color:#007C89;\n\t\t\t/*@editable*/font-weight:normal;\n\t\t\t/*@editable*/text-decoration:underline;\n\t\t}\n\t/*\n\t@tab Body\n\t@section Body Style\n\t@tip Set the background color and borders for your email's body area.\n\t*/\n\t\t#templateBody{\n\t\t\t/*@editable*/background-color:#FFFFFF;\n\t\t\t/*@editable*/background-image:none;\n\t\t\t/*@editable*/background-repeat:no-repeat;\n\t\t\t/*@editable*/background-position:center;\n\t\t\t/*@editable*/background-size:cover;\n\t\t\t/*@editable*/border-top:0;\n\t\t\t/*@editable*/border-bottom:2px solid #EAEAEA;\n\t\t\t/*@editable*/padding-top:0;\n\t\t\t/*@editable*/padding-bottom:9px;\n\t\t}\n\t/*\n\t@tab Body\n\t@section Body Text\n\t@tip Set the styling for your email's body text. Choose a size and color that is easy to read.\n\t*/\n\t\t#templateBody .mcnTextContent,#templateBody .mcnTextContent p{\n\t\t\t/*@editable*/color:#202020;\n\t\t\t/*@editable*/font-family:Helvetica;\n\t\t\t/*@editable*/font-size:16px;\n\t\t\t/*@editable*/line-height:150%;\n\t\t\t/*@editable*/text-align:left;\n\t\t}\n\t/*\n\t@tab Body\n\t@section Body Link\n\t@tip Set the styling for your email's body links. Choose a color that helps them stand out from your text.\n\t*/\n\t\t#templateBody .mcnTextContent a,#templateBody .mcnTextContent p a{\n\t\t\t/*@editable*/color:#007C89;\n\t\t\t/*@editable*/font-weight:normal;\n\t\t\t/*@editable*/text-decoration:underline;\n\t\t}\n\t/*\n\t@tab Footer\n\t@section Footer Style\n\t@tip Set the background color and borders for your email's footer area.\n\t*/\n\t\t#templateFooter{\n\t\t\t/*@editable*/background-color:#ffffff;\n\t\t\t/*@editable*/background-image:none;\n\t\t\t/*@editable*/background-repeat:no-repeat;\n\t\t\t/*@editable*/background-position:center;\n\t\t\t/*@editable*/background-size:cover;\n\t\t\t/*@editable*/border-top:0;\n\t\t\t/*@editable*/border-bottom:0;\n\t\t\t/*@editable*/padding-top:9px;\n\t\t\t/*@editable*/padding-bottom:9px;\n\t\t}\n\t/*\n\t@tab Footer\n\t@section Footer Text\n\t@tip Set the styling for your email's footer text. Choose a size and color that is easy to read.\n\t*/\n\t\t#templateFooter .mcnTextContent,#templateFooter .mcnTextContent p{\n\t\t\t/*@editable*/color:#e74d4d;\n\t\t\t/*@editable*/font-family:Helvetica;\n\t\t\t/*@editable*/font-size:12px;\n\t\t\t/*@editable*/line-height:150%;\n\t\t\t/*@editable*/text-align:center;\n\t\t}\n\t/*\n\t@tab Footer\n\t@section Footer Link\n\t@tip Set the styling for your email's footer links. Choose a color that helps them stand out from your text.\n\t*/\n\t\t#templateFooter .mcnTextContent a,#templateFooter .mcnTextContent p a{\n\t\t\t/*@editable*/color:#656565;\n\t\t\t/*@editable*/font-weight:normal;\n\t\t\t/*@editable*/text-decoration:underline;\n\t\t}\n\t@media only screen and (min-width:768px){\n\t\t.templateContainer{\n\t\t\twidth:600px !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\tbody,table,td,p,a,li,blockquote{\n\t\t\t-webkit-text-size-adjust:none !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\tbody{\n\t\t\twidth:100% !important;\n\t\t\tmin-width:100% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t#bodyCell{\n\t\t\tpadding-top:10px !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnRetinaImage{\n\t\t\tmax-width:100% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnImage{\n\t\t\twidth:100% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnCartContainer,.mcnCaptionTopContent,.mcnRecContentContainer,.mcnCaptionBottomContent,.mcnTextContentContainer,.mcnBoxedTextContentContainer,.mcnImageGroupContentContainer,.mcnCaptionLeftTextContentContainer,.mcnCaptionRightTextContentContainer,.mcnCaptionLeftImageContentContainer,.mcnCaptionRightImageContentContainer,.mcnImageCardLeftTextContentContainer,.mcnImageCardRightTextContentContainer,.mcnImageCardLeftImageContentContainer,.mcnImageCardRightImageContentContainer{\n\t\t\tmax-width:100% !important;\n\t\t\twidth:100% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnBoxedTextContentContainer{\n\t\t\tmin-width:100% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnImageGroupContent{\n\t\t\tpadding:9px !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnCaptionLeftContentOuter .mcnTextContent,.mcnCaptionRightContentOuter .mcnTextContent{\n\t\t\tpadding-top:9px !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnImageCardTopImageContent,.mcnCaptionBottomContent:last-child .mcnCaptionBottomImageContent,.mcnCaptionBlockInner .mcnCaptionTopContent:last-child .mcnTextContent{\n\t\t\tpadding-top:18px !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnImageCardBottomImageContent{\n\t\t\tpadding-bottom:9px !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnImageGroupBlockInner{\n\t\t\tpadding-top:0 !important;\n\t\t\tpadding-bottom:0 !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnImageGroupBlockOuter{\n\t\t\tpadding-top:9px !important;\n\t\t\tpadding-bottom:9px !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnTextContent,.mcnBoxedTextContentColumn{\n\t\t\tpadding-right:18px !important;\n\t\t\tpadding-left:18px !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnImageCardLeftImageContent,.mcnImageCardRightImageContent{\n\t\t\tpadding-right:18px !important;\n\t\t\tpadding-bottom:0 !important;\n\t\t\tpadding-left:18px !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcpreview-image-uploader{\n\t\t\tdisplay:none !important;\n\t\t\twidth:100% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t/*\n\t@tab Mobile Styles\n\t@section Heading 1\n\t@tip Make the first-level headings larger in size for better readability on small screens.\n\t*/\n\t\th1{\n\t\t\t/*@editable*/font-size:22px !important;\n\t\t\t/*@editable*/line-height:125% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t/*\n\t@tab Mobile Styles\n\t@section Heading 2\n\t@tip Make the second-level headings larger in size for better readability on small screens.\n\t*/\n\t\th2{\n\t\t\t/*@editable*/font-size:20px !important;\n\t\t\t/*@editable*/line-height:125% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t/*\n\t@tab Mobile Styles\n\t@section Heading 3\n\t@tip Make the third-level headings larger in size for better readability on small screens.\n\t*/\n\t\th3{\n\t\t\t/*@editable*/font-size:18px !important;\n\t\t\t/*@editable*/line-height:125% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t/*\n\t@tab Mobile Styles\n\t@section Heading 4\n\t@tip Make the fourth-level headings larger in size for better readability on small screens.\n\t*/\n\t\th4{\n\t\t\t/*@editable*/font-size:16px !important;\n\t\t\t/*@editable*/line-height:150% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t/*\n\t@tab Mobile Styles\n\t@section Boxed Text\n\t@tip Make the boxed text larger in size for better readability on small screens. We recommend a font size of at least 16px.\n\t*/\n\t\t.mcnBoxedTextContentContainer .mcnTextContent,.mcnBoxedTextContentContainer .mcnTextContent p{\n\t\t\t/*@editable*/font-size:14px !important;\n\t\t\t/*@editable*/line-height:150% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t/*\n\t@tab Mobile Styles\n\t@section Preheader Visibility\n\t@tip Set the visibility of the email's preheader on small screens. You can hide it to save space.\n\t*/\n\t\t#templatePreheader{\n\t\t\t/*@editable*/display:block !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t/*\n\t@tab Mobile Styles\n\t@section Preheader Text\n\t@tip Make the preheader text larger in size for better readability on small screens.\n\t*/\n\t\t#templatePreheader .mcnTextContent,#templatePreheader .mcnTextContent p{\n\t\t\t/*@editable*/font-size:14px !important;\n\t\t\t/*@editable*/line-height:150% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t/*\n\t@tab Mobile Styles\n\t@section Header Text\n\t@tip Make the header text larger in size for better readability on small screens.\n\t*/\n\t\t#templateHeader .mcnTextContent,#templateHeader .mcnTextContent p{\n\t\t\t/*@editable*/font-size:16px !important;\n\t\t\t/*@editable*/line-height:150% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t/*\n\t@tab Mobile Styles\n\t@section Body Text\n\t@tip Make the body text larger in size for better readability on small screens. We recommend a font size of at least 16px.\n\t*/\n\t\t#templateBody .mcnTextContent,#templateBody .mcnTextContent p{\n\t\t\t/*@editable*/font-size:16px !important;\n\t\t\t/*@editable*/line-height:150% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t/*\n\t@tab Mobile Styles\n\t@section Footer Text\n\t@tip Make the footer content text larger in size for better readability on small screens.\n\t*/\n\t\t#templateFooter .mcnTextContent,#templateFooter .mcnTextContent p{\n\t\t\t/*@editable*/font-size:14px !important;\n\t\t\t/*@editable*/line-height:150% !important;\n\t\t}\n\n}</style></head>\n    <body>\n        <!--*|IF:MC_PREVIEW_TEXT|*-->\n        <!--[if !gte mso 9]><!----><span class=\"mcnPreviewText\" style=\"display:none; font-size:0px; line-height:0px; max-height:0px; max-width:0px; opacity:0; overflow:hidden; visibility:hidden; mso-hide:all;\">Your invite to collaborate with @{variables('CompanyName')}.</span><!--<![endif]-->\n        <!--*|END:IF|*-->\n        <center>\n            <table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" height=\"100%\" width=\"100%\" id=\"bodyTable\">\n                <tr>\n                    <td align=\"center\" valign=\"top\" id=\"bodyCell\">\n                        <!-- BEGIN TEMPLATE // -->\n                        <!--[if (gte mso 9)|(IE)]>\n                        <table align=\"center\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"600\" style=\"width:600px;\">\n                        <tr>\n                        <td align=\"center\" valign=\"top\" width=\"600\" style=\"width:600px;\">\n                        <![endif]-->\n                        <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"templateContainer\">\n                            <tr>\n                                <td valign=\"top\" id=\"templatePreheader\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"mcnTextBlock\" style=\"min-width:100%;\">\n    <tbody class=\"mcnTextBlockOuter\">\n        <tr>\n            <td valign=\"top\" class=\"mcnTextBlockInner\" style=\"padding-top:9px;\">\n              \t<!--[if mso]>\n\t\t\t\t<table align=\"left\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"100%\" style=\"width:100%;\">\n\t\t\t\t<tr>\n\t\t\t\t<![endif]-->\n\t\t\t    \n\t\t\t\t<!--[if mso]>\n\t\t\t\t<td valign=\"top\" width=\"600\" style=\"width:600px;\">\n\t\t\t\t<![endif]-->\n                <table align=\"left\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"max-width:100%; min-width:100%;\" width=\"100%\" class=\"mcnTextContentContainer\">\n                    <tbody><tr>\n                        \n                        <td valign=\"top\" class=\"mcnTextContent\" style=\"padding: 0px 18px 9px; text-align: center;\">\n                        \n                            <a href=\"*|ARCHIVE|*\" target=\"_blank\">View this email in your browser</a>\n                        </td>\n                    </tr>\n                </tbody></table>\n\t\t\t\t<!--[if mso]>\n\t\t\t\t</td>\n\t\t\t\t<![endif]-->\n                \n\t\t\t\t<!--[if mso]>\n\t\t\t\t</tr>\n\t\t\t\t</table>\n\t\t\t\t<![endif]-->\n            </td>\n        </tr>\n    </tbody>\n</table></td>\n                            </tr>\n                            <tr>\n                                <td valign=\"top\" id=\"templateHeader\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"mcnImageBlock\" style=\"min-width:100%;\">\n    <tbody class=\"mcnImageBlockOuter\">\n            <tr>\n                <td valign=\"top\" style=\"padding:9px\" class=\"mcnImageBlockInner\">\n                    <table align=\"left\" width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"mcnImageContentContainer\" style=\"min-width:100%;\">\n                        <tbody><tr>\n                            <td class=\"mcnImageContent\" valign=\"top\" style=\"padding-right: 9px; padding-left: 9px; padding-top: 0; padding-bottom: 0; text-align:center;\">\n                                \n                                    \n                                        <img align=\"center\" alt=\"\" src=\"https://gallery.mailchimp.com/771466f1ed81264f95c5bb3cc/images/d912558e-cba3-4020-9e79-20b6bb7dbe19.png\" width=\"278\" style=\"max-width:278px; padding-bottom: 0; display: inline !important; vertical-align: bottom;\" class=\"mcnImage\">\n                                    \n                                \n                            </td>\n                        </tr>\n                    </tbody></table>\n                </td>\n            </tr>\n    </tbody>\n</table>\n\n<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"mcnBoxedTextBlock\" style=\"min-width:100%;\">\n    <!--[if gte mso 9]>\n\t<table align=\"center\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"100%\">\n\t<![endif]-->\n\t<tbody class=\"mcnBoxedTextBlockOuter\">\n        <tr>\n            <td valign=\"top\" class=\"mcnBoxedTextBlockInner\">\n                \n\t\t\t\t<!--[if gte mso 9]>\n\t\t\t\t<td align=\"center\" valign=\"top\" \">\n\t\t\t\t<![endif]-->\n                <table align=\"left\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"min-width:100%;\" class=\"mcnBoxedTextContentContainer\">\n                    <tbody><tr>\n                        \n                        <td style=\"padding-top:9px; padding-left:18px; padding-bottom:9px; padding-right:18px;\">\n                        \n                            <table border=\"0\" cellspacing=\"0\" class=\"mcnTextContentContainer\" width=\"100%\" style=\"min-width: 100% !important;background-color:#edebe9\">\n                                <tbody><tr>\n                                    <td valign=\"top\" class=\"mcnTextContent\" style=\"padding: 18px;color:#323130;font-family: Helvetica;font-size: 14px;font-weight: normal;text-align: center;\">\n                                        <span style=\"font-size:19px\"><strong>@{variables('CompanyName')}<br><br> Office 365 Access Invitation</strong></span><br>\n<br>\nYou've been invited as to collaborate with @{variables('CompanyName')}using @{if(equals(triggerBody()?['SpaceType']?['Value'],'Microsoft Teams Team'),'Microsoft Teams','Office 365')} by:<br><br><h4 style=\"text-align: center;font-weight: normal;color:#323130\">@{triggerBody()?['Author']?['DisplayName']}</h3><br>\nYou may receive another e-mail from us, you can use either of these to gain access.<br>\nClick the button below to accept the invite and gain access to:\n<br><br>\n    <table border=\"0\" bgcolor=\"#FFFFFF\" cellspacing=\"0\" cellpadding=\"0\" width=\"280\" style=\"margin-left:auto;margin-right:auto\">\n        <tbody><tr>\n            <td width=\"10\"></td>\n            <td align=\"center\" style=\"padding:20px 0\" width=\"260\">\n   <table width=\"100\" height=\"100\" style=\"color:#000000;table-layout:fixed\">\n\t\t\t\t<tr>\n\t\t\t\t<td align=\"center\" style=\"height:100px;background-color:@{if(equals(triggerBody()?['SpaceType']?['Value'],'Microsoft Teams Team'),'#5558A6',variables('EmailAccentColor'))};color:#ffffff;font-size:30px\">@{if(equals(indexOf(triggerBody()?['Title'],' '),-1),toUpper(substring(triggerBody()?['Title'],0,1)),toUpper(replace(concat(substring(triggerBody()?['Title'],0,1),substring(triggerBody()?['Title'],indexOf(triggerBody()?['Title'],' '),2)),' ','')))}</td>\n\t\t\t\t</tr>\n\t\t\t   </table>\n                </td>\n                </td>\n            <td width=\"10\"></td>\n        </tr>\n        <tr>\n            <td width=\"10\"></td>\n            <td align=\"center\" style=\"max-width:260px;padding-bottom:10px;overflow:hidden\" width=\"260\">\n                <h3 style=\"text-align:center;color:#323130;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;font-weight:600;margin:0\">@{triggerBody()?['Title']}</h3>\n            </td>\n            <td width=\"10\"></td>\n        </tr>\n        <tr>\n            <td width=\"10\"></td>\n            <td align=\"center\" style=\"border-top:1px solid #e2e7ec;color:#323130;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;font-size:14px;line-height:20px;padding:10px 0 20px;max-width:260px;max-height:60px;overflow:hidden\" width=\"260\">@{triggerBody()?['Description']}\n            </td>\n            <td width=\"10\"></td>\n        </tr>\n    </tbody></table>\n                            </td>\n                                </tr>\n                            </tbody></table>\n                        </td>\n                    </tr>\n                </tbody></table>\n\t\t\t\t<!--[if gte mso 9]>\n\t\t\t\t</td>\n\t\t\t\t<![endif]-->\n                \n\t\t\t\t<!--[if gte mso 9]>\n                </tr>\n                </table>\n\t\t\t\t<![endif]-->\n            </td>\n        </tr>\n    </tbody>\n</table><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"mcnButtonBlock\" style=\"min-width:100%;\">\n    <tbody class=\"mcnButtonBlockOuter\">\n        <tr>\n            <td style=\"padding-top:0; padding-right:18px; padding-bottom:18px; padding-left:18px;\" valign=\"top\" align=\"center\" class=\"mcnButtonBlockInner\">\n                <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"mcnButtonContentContainer\" style=\"border-collapse: separate !important;border-radius: 4px;background-color: @{if(equals(triggerBody()?['SpaceType']?['Value'],'Microsoft Teams Team'),'#5558A6',variables('EmailAccentColor'))}\">\n                    <tbody>\n                        <tr>\n                            <td align=\"center\" valign=\"middle\" class=\"mcnButtonContent\" style=\"font-family: Arial; font-size: 16px; padding: 18px;\">\n                                <a class=\"mcnButton \" title=\"Get Started\" href=\"@{items('Loop_through_guests')?['InviteRedeemUrl']}\" target=\"_blank\" style=\"font-weight: bold;letter-spacing: normal;line-height: 100%;text-align: center;text-decoration: none;color: #FFFFFF;\">@{if(equals(triggerBody()?['SpaceType']?['Value'],'Microsoft Teams Team'),'Open Microsoft Teams','Get Started')}</a>\n                            </td>\n                        </tr>\n                    </tbody>\n                </table>\n            </td>\n        </tr>\n    </tbody>\n</table><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"mcnTextBlock\" style=\"min-width:100%;\">\n    <tbody class=\"mcnTextBlockOuter\">\n        <tr>\n            <td valign=\"top\" class=\"mcnTextBlockInner\" style=\"padding-top:9px;\">\n              \t<!--[if mso]>\n\t\t\t\t<table align=\"left\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"100%\" style=\"width:100%;\">\n\t\t\t\t<tr>\n\t\t\t\t<![endif]-->\n\t\t\t    \n\t\t\t\t<!--[if mso]>\n\t\t\t\t<td valign=\"top\" width=\"600\" style=\"width:600px;\">\n\t\t\t\t<![endif]-->\n                <table align=\"left\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"max-width:100%; min-width:100%;\" width=\"100%\" class=\"mcnTextContentContainer\">\n                    <tbody><tr>\n                        \n                        <td valign=\"top\" class=\"mcnTextContent\" style=\"padding-top:0; padding-right:18px; padding-bottom:9px; padding-left:18px;\">\n                        \n                            <div style=\"text-align: center;\"><span style=\"font-size:12px\"><u>Return to the above link at any time for access.</u></span></div>\n\n                        </td>\n                    </tr>\n                </tbody></table>\n\t\t\t\t<!--[if mso]>\n\t\t\t\t</td>\n\t\t\t\t<![endif]-->\n                \n\t\t\t\t<!--[if mso]>\n\t\t\t\t</tr>\n\t\t\t\t</table>\n\t\t\t\t<![endif]-->\n            </td>\n        </tr>\n    </tbody>\n</table></td>\n                            </tr>\n                            <tr>\n                                <td valign=\"top\" id=\"templateBody\"></td>\n                            </tr>\n                            <tr>\n                                <td valign=\"top\" id=\"templateFooter\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"mcnTextBlock\" style=\"min-width:100%;\">\n    <tbody class=\"mcnTextBlockOuter\">\n        <tr>\n            <td valign=\"top\" class=\"mcnTextBlockInner\" style=\"padding-top:9px;\">\n              \t<!--[if mso]>\n\t\t\t\t<table align=\"left\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"100%\" style=\"width:100%;\">\n\t\t\t\t<tr>\n\t\t\t\t<![endif]-->\n\t\t\t    \n\t\t\t\t<!--[if mso]>\n\t\t\t\t<td valign=\"top\" width=\"600\" style=\"width:600px;\">\n\t\t\t\t<![endif]-->\n                <table align=\"left\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" style=\"max-width:100%; min-width:100%;\" width=\"100%\" class=\"mcnTextContentContainer\">\n                    <tbody><tr>\n                        \n                        <td valign=\"top\" class=\"mcnTextContent\" style=\"padding: 0px 18px 9px;color: #000000;\">\n                        \n                            <div style=\"text-align: left;float:left\">\n<div style=\"text-align: center;\"><span style=\"font-size:12px\">This email has been sent on behalf of the @{variables('CompanyName')} organization. Please act on this email only if you trust the @{variables('CompanyName')} organization. This email may have advertising content. You can <a href=\"https://nam06.safelinks.protection.outlook.com/?url=https%3A%2F%2Finvitations.microsoft.com%3A443%2Funsubscribe%2F%3Ftenant%3D2ad170f9-a447-4362-8ef9-a01c2ba2cc0e%26rowId%3D0de9209f-be20-40f9-99c0-68da2639120b%26hash%3DGckpTMDc0zasjEeOqYgbSd9j%252fnjxjeKmik5ezDuwPPQ%253d%26email%3DYWxlY2xhckBtaWNyb3NvZnQuY29t%26ver%3D3.0&amp;data=02%7C01%7CAlex.Clark%40microsoft.com%7C643fdcfe8171453ab2fd08d70c902249%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636991685519514497&amp;sdata=n7XK%2BIeQ2lGtDnfIykDOWoWuaII%2BiuZ6au3fzdDC8yI%3D&amp;reserved=0\" originalsrc=\"https://invitations.microsoft.com:443/unsubscribe/?tenant=2ad170f9-a447-4362-8ef9-a01c2ba2cc0e&amp;rowId=0de9209f-be20-40f9-99c0-68da2639120b&amp;hash=GckpTMDc0zasjEeOqYgbSd9j%2fnjxjeKmik5ezDuwPPQ%3d&amp;email=YWxlY2xhckBtaWNyb3NvZnQuY29t&amp;ver=3.0\" shash=\"n5qTOSvfTQ4Q+AMRH8JnSPryk5Kfuw0RD+wCq3tSYaCr9BoP733ndm8Hqf6pYRfAoHXbEBHz1i2MzE8naLMSNA++OxWyuD4nqOTB6H8raXHdefX/gClgTlWUT2PazGyyPpxhk8ia86HAsLUm/VD1ZbFrAUBSYokcTIJiSdxFJfE=\">unsubscribe</a> from future invitations from the Contoso organization at any time. See <a href=\"https://nam06.safelinks.protection.outlook.com/?url=http%3A%2F%2Fgo.microsoft.com%2Ffwlink%2F%3FLinkId%3D521839&amp;data=02%7C01%7CAlex.Clark%40microsoft.com%7C643fdcfe8171453ab2fd08d70c902249%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636991685519524492&amp;sdata=bIzpBaoLGW3XnhZtWl1Sa8X08VuyATccCwf3%2BRbkOtA%3D&amp;reserved=0\" originalsrc=\"http://go.microsoft.com/fwlink/?LinkId=521839\" shash=\"MiAK7c/bJKEgyhEQOljxyUUNSttA6SGpy+uLLlbTmJWqwJSOBjGpxVdvKM3lu9WYUfa2oZKPbBDGrMa84SzXLIoa6AtZ6PEcO50qhfFCdmOicH3iI1c2LwL0SEjN4GEfnuE9Md1IrLIv2ngA1UiOL3yO9ycdo35VFxHenD/PyiE=\">Microsoft organization privacy statement</a> to learn more about how Microsoft handles your data.</span></div>\n<br>\n<br><div style=\"float:left\">\nFacilitated by : Microsoft Corporation, One Microsoft Way, Redmond, WA 98052&nbsp;</div>\n<img src=\"https://img-prod-cms-rt-microsoft-com.akamaized.net/cms/api/am/imageFileData/RE1Mu3b?ver=5c31\" style=\"float:right\" width=\"100px\">\n                        </div></td>\n                    </tr>\n                </tbody></table>\n\t\t\t\t<!--[if mso]>\n\t\t\t\t</td>\n\t\t\t\t<![endif]-->\n                \n\t\t\t\t<!--[if mso]>\n\t\t\t\t</tr>\n\t\t\t\t</table>\n\t\t\t\t<![endif]-->\n            </td>\n        </tr>\n    </tbody>\n</table></td>\n                            </tr>\n                        </table>\n                        <!--[if (gte mso 9)|(IE)]>\n                        </td>\n                        </tr>\n                        </table>\n                        <![endif]-->\n                        <!-- // END TEMPLATE -->\n                    </td>\n                </tr>\n            </table>\n        </center>\n    </body>\n</html>\n",
                                                    "IsHtml": true,
                                                    "Subject": "@{variables('CompanyName')} Collaboration Invitation",
                                                    "To": "@{items('loop_through_guests')?['GuestEmail']}"
                                                },
                                                "host": {
                                                    "connection": {
                                                        "name": "@parameters('$connections')['office365']['connectionId']"
                                                    }
                                                },
                                                "method": "post",
                                                "path": "/Mail"
                                            }
                                        }
                                    },
                                    "runAfter": {
                                    },
                                    "expression": {
                                        "and": [
                                            {
                                                "equals": [
                                                    "@empty(items('loop_through_guests')?['InviteRedeemUrl'])",
                                                    "@false"
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If"
                                }
                            },
                            "runAfter": {
                                "Post_space_created_adaptive_card": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Foreach"
                        },
                        "Parse_Owners_JSON": {
                            "runAfter": {
                                "Create_Visitors_string": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ParseJson",
                            "inputs": {
                                "content": "@variables('Owners')",
                                "schema": {
                                    "items": {
                                        "properties": {
                                            "ID": {
                                                "type": "string"
                                            },
                                            "OwnerUPN": {
                                                "type": "string"
                                            }
                                        },
                                        "required": [
                                            "ID",
                                            "OwnerUPN"
                                        ],
                                        "type": "object"
                                    },
                                    "type": "array"
                                }
                            }
                        },
                        "Post_space_created_adaptive_card": {
                            "runAfter": {
                                "Update_status_to_Space_Created": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ApiConnection",
                            "inputs": {
                                "body": {
                                    "messageBody": "{\n    \"type\": \"AdaptiveCard\",\n    \"body\": [\n        {\n            \"type\": \"Container\",\n            \"style\": \"emphasis\",\n            \"items\": [\n                {\n                    \"type\": \"ColumnSet\",\n                    \"columns\": [\n                        {\n                            \"type\": \"Column\",\n                            \"items\": [\n                                {\n                                    \"type\": \"Image\",\n                                    \"weight\": \"Bolder\",\n                                    \"text\": \"**Space Request**\",\n                                    \"url\": \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAACXBIWXMAAC4jAAAuIwF4pT92AAAH6ElEQVR4nO2ce6xdRRWHv9vb1lqkFUObUixa6gPT+OARCrFotUisWI2AWm2qxMZHxJoaEwMJCcREY/jPRNRYqoEgpWKaFuILjQiIDdTYhhZa02B5VUtftEJL0d7+/GPdyz1nzt7nsffM6cI7X7LTzuzZa699fntm9sysuQOSyPhh3Ml2INNMFsQZWRBnZEGckQVxRhbEGVkQZ2RBnJEFcUYWxBlZEGdkQZyRBXFGFsQZWRBnZEGcMb7P9/sI8H5gGnAEeAhYDxzrsx/tOLk+SurHcY2kLSrmGUnXSxrsky+ufRxQ2iXcQeBu7K3rxOPAYuAfKR0qwJWPqQW5H3hfD+X3AucAz6dxpxBXPqbs1FdS/KB/BNYAvwaGgnPTgVUJfQpZiTcfE7WF4yQdCtrh/ZIWBOXmlLTb56Ruq736mOphlwbOn5D0npKykyQ9HZT/SSK/3PuYqslaGKRvBbaUlD0G/CjImx3boQJc+phKkNcG6d93KP+vIP2aiL6U4dLHVIIcD9Jv6lA+fLjw+hS49DGVIDuC9IoO5T8epA9G9KUMnz4m6jBnqpU7SspeW1D2k4n8cu9jyoHhelrfqr8BNwOPAmcBXwYuC8o8Sfcd5gA2LpiBjbifA/YB/3HkY28kfAMnSNpW8Ga1Y7/su7+T7U9I+o2kZyUNBTaek/SgpOVd2BkvaWsFH9/She1KR8qR+n+xN7YXDmNTE2VcDmwE1gEfBs6ktR+cDswHbgG2A19tY+94h/sVcQj4Z4/XdE8ipedJ2tXjmzfCMUlXF9j8fkV7krShwN58SU9VtHdUNrCM/tulEOOSDg9zWNITkvZ2KPe1BpsbOpR9ctjm8TZltkg6Zdjewkg+fkmRf7/YYsyQdKTA8QOSvivpUklThstOlHSxbJ1hZ8kDXyRpZcm5eyR9UdLshvufIenTkn5Wcs0vJJ0n6aWIPs5XxN8wtiAbCxxeK2lah+sGJd1U8sAhJyQt68KXD6j7ZrOOj4dkc13uBLmqwNlberTx9S5+vHN7sDdFrZOCKXz8Xo82+iLIpsDJbRXtrGnz4y2pYG9OG3uxfDwoaaCirSSCnFXwsBdUtDVFxZ3zlhr+rSqwF9vHz9fw75Uj1jhkaZDeBvy1oq1/0zrVDXBjRXsA19G68hfbx0UVbTURS5BwbeGumvbuDdIvAvfUsLcfm+5o5Oc17IEt8zby5pr2gHiCTMJG5iPHEzXtHQ3S22l9w3tlf5DeXdPeIZqfOcp0fKxAucXY5J6wCb/DNe2dCNJ1xQDzLSYPADMZfWZXgsQOiXk5SM+JYHNqkO52RriMIVprXW28xvZup7mWTAPeW8PeRFqny/fUsJcMr4I8D/wuyLuxhr1vYf3cCC8Aj9SwlwyvggCsDdKXAu+qYGcAuCHIWw28VMWp1KQOJa3DVGzdYXJD3l6s6Qm/wtrxJyyavZG5WJyuOzzXkMNYqGcj07EB3Tu7uH4qNp4JxViNUzHAdw0Z4V7gQwX5PwZ+ADwW5J8BXIOthZ8enNuNDeD6EWZUiVeDIJOxKY53lJx/GBNlCHgr9jU2oaDcEeB84O8JfIzGq0GQEW4DllW89iFsnd09/d7SVpXLgCk1rp8AfAz4A+0/CD4IzMOavddhX2J7gc3Ypp70xJgyTnzUCW4IWVFyj8tloUPteFzdhRbVOjw3WZOwDv2SkvM7ga1YR70H66hnYKFBc4ePRnYBC4CnG/IGgZ8Cn+vBrweBJaQKBUqteMVjvKTNJW/qbyVd2YWNRZLWNVw3Mzg/qOIYgG7YI+mNKZ7daw35Fa2bMF/GPmVv7dHWV7CacHOQvxb4VEH5ncBfsJp0GlZD311QbgflX37VSaFyzWNlwRu5Q9KsiPdYVHCPgyoPoL5I1oeE3BD7+b3VkJm0Lhw9A7yNuBv3H6V5tL8PqwXhppyQh4ELG9JHgTfQulxQGW9TJ98uyFtAXDHm0jr18lk6iwHw0SA9GWtGo+FJkFnA8iDvO8TfpP+ZIL0VG590wz7gh0HegroONeJJkDBqYzdwfYL7nB2ke/1ICIMtTqvhSwueBLkiSK9PdJ/BIN1rsEPYX0wqLFURL4KcSmsoUbhAFYswYOL1PV4fClp3bb4JL4KcT/O82j5sRJyCsPO+qsfr5wXpuhE2TXgR5LwgHfWtC/hlkF6ITdt3wzjg2iAv6tq8l9nebcCdjMZOhYtOMdmIjW1mNeStAS7o4trbsFngEYawhbJ49HEE7un4QsGo+36V/62TabI9JCGr/t9H6v3kzxTHeq3GRvIHsNrwduBqWj9vn8IGmC/EdMpLk3Uy2EyxIOHgtIzHiCwG+OnUTwZ1ViABToniRcBYFiTERSTKWG6yQr6J9QvLsfivo1hM8DFsL8npwE2pnciCjPIisGH4ADgX69xHRvZL+uFEbrJGeXb438XAJuyP0OxidHr9QD+cyDVklKVYlHzjnNosbOC3gvq7wroiCzJKu8iToiiWJOQmyxlZkGI2YZ347f2+cRakmUew0KALsfWYZVh46bp+OTCWBRlo+P8D2J/6m0frHvv7gCuxtfPGve0Tkzg1hicX78PCTr+BBeZ1y8XYFrnZWKBcuIW7FmNZkCuw6MMqu6lOxfY83k2cPfSvMJYFcclY7kNckgVxRhbEGVkQZ2RBnJEFcUYWxBlZEGdkQZyRBXFGFsQZWRBnZEGckQVxRhbEGVkQZ/wPGKORe/+IGzsAAAAASUVORK5CYII=\",\n                                    \"width\": \"60px\",\n                                    \"height\": \"60px\"\n                                }\n                            ],\n                            \"width\": \"60px\",\n                            \"minHeight\": \"60px\"\n                        },\n                        {\n                            \"type\": \"Column\",\n                            \"items\": [\n                                {\n                                    \"type\": \"Container\",\n                                    \"items\": [\n                                        {\n                                            \"type\": \"TextBlock\",\n                                            \"text\": \"Provision Assist\",\n                                            \"wrap\": true,\n                                            \"size\": \"ExtraLarge\",\n                                            \"weight\": \"Bolder\",\n                                            \"horizontalAlignment\": \"Left\"\n                                        }\n                                    ],\n                                    \"style\": \"default\",\n                                    \"verticalContentAlignment\": \"Bottom\"\n                                }\n                            ],\n                            \"width\": \"stretch\",\n                            \"horizontalAlignment\": \"Center\",\n                            \"verticalContentAlignment\": \"Bottom\"\n                        }\n                    ]\n                },\n                {\n                    \"type\": \"Container\",\n                    \"style\": \"good\",\n                    \"items\": [\n                        {\n                            \"type\": \"TextBlock\",\n                            \"text\": \"Space Created\",\n                            \"wrap\": true,\n                            \"size\": \"Large\"\n                        }\n                    ]\n                }\n            ],\n            \"bleed\": true,\n            \"backgroundImage\": {\n                \"url\": \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA+gAAABkCAIAAACaW42NAAAACXBIWXMAAA9hAAAPYQGoP6dpAAACIUlEQVR4nO3WsQ3AIADAsNLXkbibExghkn1Bxowx1wcAALztvx0AAACcGXcAAAgw7gAAEGDcAQAgwLgDAECAcQcAgADjDgAAAcYdAAACjDsAAAQYdwAACDDuAAAQYNwBACDAuAMAQIBxBwCAAOMOAAABxh0AAAKMOwAABBh3AAAIMO4AABBg3AEAIMC4AwBAgHEHAIAA4w4AAAHGHQAAAow7AAAEGHcAAAgw7gAAEGDcAQAgwLgDAECAcQcAgADjDgAAAcYdAAACjDsAAAQYdwAACDDuAAAQYNwBACDAuAMAQIBxBwCAAOMOAAABxh0AAAKMOwAABBh3AAAIMO4AABBg3AEAIMC4AwBAgHEHAIAA4w4AAAHGHQAAAow7AAAEGHcAAAgw7gAAEGDcAQAgwLgDAECAcQcAgADjDgAAAcYdAAACjDsAAAQYdwAACDDuAAAQYNwBACDAuAMAQIBxBwCAAOMOAAABxh0AAAKMOwAABBh3AAAIMO4AABBg3AEAIMC4AwBAgHEHAIAA4w4AAAHGHQAAAow7AAAEGHcAAAgw7gAAEGDcAQAgwLgDAECAcQcAgADjDgAAAcYdAAACjDsAAAQYdwAACDDuAAAQYNwBACDAuAMAQIBxBwCAAOMOAAABxh0AAAKMOwAABBh3AAAIMO4AABBg3AEAIMC4AwBAgHEHAIAA4w4AAAHGHQAAAow7AAAEGHcAAAgw7gAAELAB7VMB0pYASVwAAAAASUVORK5CYII=\"\n            }\n        },\n        {\n            \"type\": \"Container\",\n            \"items\": [\n                {\n                    \"type\": \"ColumnSet\",\n                    \"columns\": [\n                        {\n                            \"type\": \"Column\",\n                            \"items\": [\n                                {\n                                    \"type\": \"TextBlock\",\n                                    \"size\": \"ExtraLarge\",\n                                    \"text\": \"@{triggerBody()?['Title']}\",\n                                    \"wrap\": true\n                                }\n                            ],\n                            \"width\": \"stretch\"\n                        }\n                    ]\n                },\n                {\n                    \"type\": \"TextBlock\",\n                    \"text\": \"Your '@{triggerBody()?['SpaceType']?['Value']}' - '@{triggerBody()?['Title']}' has been created and is now ready for use.\",\n                    \"wrap\": true,\n                    \"weight\": \"Bolder\"\n                },\n                {\n                    \"type\": \"TextBlock\",\n                    \"text\": \"Click the button below to access it.\",\n                    \"wrap\": true\n                },\n                {\n                    \"type\": \"ActionSet\",\n                    \"actions\": [\n                        {\n                            \"type\": \"Action.OpenUrl\",\n                            \"title\": \"Open\",\n                            \"url\": \"@{if(equals(triggerBody()?['SpaceType']?['Value'],'Microsoft Teams Team'),variables('TeamURL'),if(equals(triggerBody()?['SpaceType']?['Value'],'Viva Engage Community'),variables('VivaEngageURL'),triggerBody()?['SiteURL']))}\"\n                        }\n                    ]\n                }\n            ]\n        }\n    ],\n    \"$schema\": \"http://adaptivecards.io/schemas/adaptive-card.json\",\n    \"version\": \"1.3\",\n    \"fallbackText\": \"This card requires Adaptive Cards v1.2 support to be rendered properly.\"\n}",
                                    "recipient": {
                                        "summary": "Provision Assist - Space Created",
                                        "to": "@triggerBody()?['Author']?['Email']"
                                    }
                                },
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['teams']['connectionId']"
                                    }
                                },
                                "method": "post",
                                "path": "/flowbot/actions/adaptivecard/recipienttypes/user"
                            }
                        },
                        "Process_Owners_and_Members": {
                            "actions": {
                                "Check_if_space_meets_criteria_to_process_owners_and_members": {
                                    "actions": {
                                        "Check_TeamsTemplateOperation_value": {
                                            "actions": {
                                                "Get_create_team_operation": {
                                                    "runAfter": {
                                                        "Parse_create_team_JSON": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Http",
                                                    "inputs": {
                                                        "authentication": {
                                                            "audience": "https://graph.microsoft.com",
                                                            "clientId": "@body('Get_Client_ID')?['value']",
                                                            "password": "@null",
                                                            "pfx": "@body('Get_Certificate')?['value']",
                                                            "tenant": "@variables('TenantID')",
                                                            "type": "ActiveDirectoryOAuth"
                                                        },
                                                        "headers": {
                                                            "content-type": "application/json"
                                                        },
                                                        "method": "GET",
                                                        "uri": "@{variables('GraphURL')}@{body('Parse_create_team_JSON')?['Location']}"
                                                    }
                                                },
                                                "Get_created_team": {
                                                    "runAfter": {
                                                        "Parse_team_operation_JSON": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Http",
                                                    "inputs": {
                                                        "authentication": {
                                                            "audience": "https://graph.microsoft.com",
                                                            "clientId": "@body('Get_Client_ID')?['value']",
                                                            "password": "@null",
                                                            "pfx": "@body('Get_Certificate')?['value']",
                                                            "tenant": "@variables('TenantID')",
                                                            "type": "ActiveDirectoryOAuth"
                                                        },
                                                        "headers": {
                                                            "content-type": "application/json"
                                                        },
                                                        "method": "GET",
                                                        "uri": "@{variables('GraphURL')}/teams/@{body('Parse_team_operation_JSON')?['targetResourceId']}"
                                                    }
                                                },
                                                "Parse_create_team_JSON": {
                                                    "runAfter": {},
                                                    "type": "ParseJson",
                                                    "inputs": {
                                                        "content": "@if(equals(variables('TeamsTemplateOperation'),'template'),outputs('Create_team_from_group')['headers'],outputs('Clone_team')['headers'])",
                                                        "schema": {
                                                            "properties": {
                                                                "Cache-Control": {
                                                                    "type": "string"
                                                                },
                                                                "Content-Length": {
                                                                    "type": "string"
                                                                },
                                                                "Content-Type": {
                                                                    "type": "string"
                                                                },
                                                                "Date": {
                                                                    "type": "string"
                                                                },
                                                                "Location": {
                                                                    "type": "string"
                                                                },
                                                                "Strict-Transport-Security": {
                                                                    "type": "string"
                                                                },
                                                                "client-request-id": {
                                                                    "type": "string"
                                                                },
                                                                "request-id": {
                                                                    "type": "string"
                                                                },
                                                                "x-ms-ags-diagnostic": {
                                                                    "type": "string"
                                                                }
                                                            },
                                                            "type": "object"
                                                        }
                                                    },
                                                    "description": "Ought to check template operation is also equal to clone and handle if empty."
                                                },
                                                "Parse_created_team_JSON": {
                                                    "runAfter": {
                                                        "Get_created_team": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ParseJson",
                                                    "inputs": {
                                                        "content": "@body('Get_created_team')",
                                                        "schema": {
                                                            "properties": {
                                                                "@@odata.context": {
                                                                    "type": "string"
                                                                },
                                                                "classification": {},
                                                                "description": {
                                                                    "type": [
                                                                        "string",
                                                                        "null"
                                                                    ]
                                                                },
                                                                "discoverySettings": {
                                                                    "properties": {
                                                                        "showInTeamsSearchAndSuggestions": {
                                                                            "type": "boolean"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "displayName": {
                                                                    "type": "string"
                                                                },
                                                                "funSettings": {
                                                                    "properties": {
                                                                        "allowCustomMemes": {
                                                                            "type": "boolean"
                                                                        },
                                                                        "allowGiphy": {
                                                                            "type": "boolean"
                                                                        },
                                                                        "allowStickersAndMemes": {
                                                                            "type": "boolean"
                                                                        },
                                                                        "giphyContentRating": {
                                                                            "type": "string"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "guestSettings": {
                                                                    "properties": {
                                                                        "allowCreateUpdateChannels": {
                                                                            "type": "boolean"
                                                                        },
                                                                        "allowDeleteChannels": {
                                                                            "type": "boolean"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "id": {
                                                                    "type": "string"
                                                                },
                                                                "internalId": {
                                                                    "type": "string"
                                                                },
                                                                "isArchived": {
                                                                    "type": "boolean"
                                                                },
                                                                "memberSettings": {
                                                                    "properties": {
                                                                        "allowAddRemoveApps": {
                                                                            "type": "boolean"
                                                                        },
                                                                        "allowCreatePrivateChannels": {
                                                                            "type": "boolean"
                                                                        },
                                                                        "allowCreateUpdateChannels": {
                                                                            "type": "boolean"
                                                                        },
                                                                        "allowCreateUpdateRemoveConnectors": {
                                                                            "type": "boolean"
                                                                        },
                                                                        "allowCreateUpdateRemoveTabs": {
                                                                            "type": "boolean"
                                                                        },
                                                                        "allowDeleteChannels": {
                                                                            "type": "boolean"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "messagingSettings": {
                                                                    "properties": {
                                                                        "allowChannelMentions": {
                                                                            "type": "boolean"
                                                                        },
                                                                        "allowOwnerDeleteMessages": {
                                                                            "type": "boolean"
                                                                        },
                                                                        "allowTeamMentions": {
                                                                            "type": "boolean"
                                                                        },
                                                                        "allowUserDeleteMessages": {
                                                                            "type": "boolean"
                                                                        },
                                                                        "allowUserEditMessages": {
                                                                            "type": "boolean"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                },
                                                                "specialization": {},
                                                                "visibility": {},
                                                                "webUrl": {
                                                                    "type": "string"
                                                                }
                                                            },
                                                            "type": "object"
                                                        }
                                                    }
                                                },
                                                "Parse_team_operation_JSON": {
                                                    "runAfter": {
                                                        "Get_create_team_operation": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ParseJson",
                                                    "inputs": {
                                                        "content": "@body('Get_create_team_operation')",
                                                        "schema": {
                                                            "properties": {
                                                                "@@odata.context": {
                                                                    "type": "string"
                                                                },
                                                                "Value": {
                                                                    "type": "string"
                                                                },
                                                                "attemptsCount": {
                                                                    "type": "integer"
                                                                },
                                                                "createdDateTime": {
                                                                    "type": "string"
                                                                },
                                                                "error": {},
                                                                "id": {
                                                                    "type": "string"
                                                                },
                                                                "lastActionDateTime": {
                                                                    "type": "string"
                                                                },
                                                                "operationType": {
                                                                    "type": "string"
                                                                },
                                                                "status": {
                                                                    "type": "string"
                                                                },
                                                                "targetResourceId": {
                                                                    "type": "string"
                                                                },
                                                                "targetResourceLocation": {
                                                                    "type": "string"
                                                                }
                                                            },
                                                            "type": "object"
                                                        }
                                                    }
                                                },
                                                "Set_GroupID_variable_-_team": {
                                                    "runAfter": {
                                                        "Set_TeamID_variable": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "GroupID",
                                                        "value": "@body('Parse_created_team_JSON')?['id']"
                                                    }
                                                },
                                                "Set_TeamID_variable": {
                                                    "runAfter": {
                                                        "Parse_created_team_JSON": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "TeamID",
                                                        "value": "@body('Parse_created_team_JSON')?['id']"
                                                    }
                                                }
                                            },
                                            "runAfter": {},
                                            "expression": {
                                                "and": [
                                                    {
                                                        "and": [
                                                            {
                                                                "equals": [
                                                                    "@triggerBody()?['SpaceTypeInternal']",
                                                                    "Microsoft Teams Team"
                                                                ]
                                                            }
                                                        ]
                                                    },
                                                    {
                                                        "or": [
                                                            {
                                                                "equals": [
                                                                    "@variables('TeamsTemplateOperation')",
                                                                    "template"
                                                                ]
                                                            },
                                                            {
                                                                "equals": [
                                                                    "@variables('TeamsTemplateOperation')",
                                                                    "clone"
                                                                ]
                                                            }
                                                        ]
                                                    }
                                                ]
                                            },
                                            "type": "If",
                                            "description": "Checking create team operation and parsing JSON only required for teams created from templates or cloned teams. Otherwise the JSON output from teamifying the group will be used."
                                        },
                                        "Check_we_are_cloning_a_team_or_processing_owners_and_members": {
                                            "actions": {
                                                "Add_Members_and_Owners": {
                                                    "actions": {
                                                        "Get_group_members": {
                                                            "runAfter": {
                                                                "Get_group_owners": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "Http",
                                                            "inputs": {
                                                                "authentication": {
                                                                    "audience": "https://graph.microsoft.com",
                                                                    "clientId": "@body('Get_Client_ID')?['value']",
                                                                    "password": "@null",
                                                                    "pfx": "@body('Get_Certificate')?['value']",
                                                                    "tenant": "@variables('TenantID')",
                                                                    "type": "ActiveDirectoryOAuth"
                                                                },
                                                                "headers": {
                                                                    "content-type": "application/json"
                                                                },
                                                                "method": "GET",
                                                                "uri": "@{variables('GraphURL')}/groups/@{variables('GroupID')}/members"
                                                            }
                                                        },
                                                        "Get_group_owners": {
                                                            "runAfter": {},
                                                            "type": "Http",
                                                            "inputs": {
                                                                "authentication": {
                                                                    "audience": "https://graph.microsoft.com",
                                                                    "clientId": "@body('Get_Client_ID')?['value']",
                                                                    "password": "@null",
                                                                    "pfx": "@body('Get_Certificate')?['value']",
                                                                    "tenant": "@variables('TenantID')",
                                                                    "type": "ActiveDirectoryOAuth"
                                                                },
                                                                "headers": {
                                                                    "content-type": "application/json"
                                                                },
                                                                "method": "GET",
                                                                "uri": "@{variables('GraphURL')}/groups/@{variables('GroupID')}/owners"
                                                            }
                                                        },
                                                        "Loop_through_MemberIDs_array": {
                                                            "foreach": "@variables('MemberIDs')",
                                                            "actions": {
                                                                "Check_if_member_does_not_already_exist_in_the_group": {
                                                                    "actions": {
                                                                        "Add_member_to_group": {
                                                                            "runAfter": {},
                                                                            "type": "Http",
                                                                            "inputs": {
                                                                                "authentication": {
                                                                                    "audience": "https://graph.microsoft.com",
                                                                                    "clientId": "@body('Get_Client_ID')?['value']",
                                                                                    "password": "@null",
                                                                                    "pfx": "@body('Get_Certificate')?['value']",
                                                                                    "tenant": "@variables('TenantID')",
                                                                                    "type": "ActiveDirectoryOAuth"
                                                                                },
                                                                                "body": {
                                                                                    "@@odata.id": "https://graph.microsoft.com/v1.0/users/@{items('Loop_through_MemberIDs_array')}"
                                                                                },
                                                                                "headers": {
                                                                                    "content-type": "application/json"
                                                                                },
                                                                                "method": "POST",
                                                                                "uri": "@{variables('GraphURL')}/groups/@{variables('GroupID')}/members/$ref"
                                                                            }
                                                                        }
                                                                    },
                                                                    "runAfter": {},
                                                                    "expression": {
                                                                        "and": [
                                                                            {
                                                                                "not": {
                                                                                    "contains": [
                                                                                        "@string(body('Get_group_owners'))",
                                                                                        "@items('Loop_through_MemberIDs_array')"
                                                                                    ]
                                                                                }
                                                                            },
                                                                            {
                                                                                "not": {
                                                                                    "contains": [
                                                                                        "@string(body('Get_group_members'))",
                                                                                        "@items('Loop_through_MemberIDs_array')"
                                                                                    ]
                                                                                }
                                                                            }
                                                                        ]
                                                                    },
                                                                    "type": "If",
                                                                    "description": "Check if member is not added to the group at this stage or this will fail."
                                                                }
                                                            },
                                                            "runAfter": {
                                                                "Parse_group_members_JSON": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "Foreach",
                                                            "runtimeConfiguration": {
                                                                "concurrency": {
                                                                    "repetitions": 1
                                                                }
                                                            }
                                                        },
                                                        "Loop_through_OwnerIDs_array": {
                                                            "foreach": "@variables('OwnerIDs')",
                                                            "actions": {
                                                                "Check_if_owner_does_not_already_exist_in_the_group": {
                                                                    "actions": {
                                                                        "Add_owner_to_group": {
                                                                            "runAfter": {},
                                                                            "type": "Http",
                                                                            "inputs": {
                                                                                "authentication": {
                                                                                    "audience": "https://graph.microsoft.com",
                                                                                    "clientId": "@body('Get_Client_ID')?['value']",
                                                                                    "password": "@null",
                                                                                    "pfx": "@body('Get_Certificate')?['value']",
                                                                                    "tenant": "@variables('TenantID')",
                                                                                    "type": "ActiveDirectoryOAuth"
                                                                                },
                                                                                "body": {
                                                                                    "@@odata.id": "https://graph.microsoft.com/v1.0/users/@{items('Loop_through_OwnerIDs_array')}"
                                                                                },
                                                                                "headers": {
                                                                                    "content-type": "application/json"
                                                                                },
                                                                                "method": "POST",
                                                                                "uri": "@{variables('GraphURL')}/groups/@{variables('GroupID')}/owners/$ref"
                                                                            }
                                                                        },
                                                                        "Delay_while_owner_is_added": {
                                                                            "runAfter": {
                                                                                "Add_owner_to_group": [
                                                                                    "Succeeded"
                                                                                ]
                                                                            },
                                                                            "type": "Wait",
                                                                            "inputs": {
                                                                                "interval": {
                                                                                    "count": 1,
                                                                                    "unit": "Minute"
                                                                                }
                                                                            }
                                                                        }
                                                                    },
                                                                    "runAfter": {},
                                                                    "expression": {
                                                                        "and": [
                                                                            {
                                                                                "not": {
                                                                                    "contains": [
                                                                                        "@string(body('Get_group_owners'))",
                                                                                        "@items('Loop_through_OwnerIDs_array')"
                                                                                    ]
                                                                                }
                                                                            }
                                                                        ]
                                                                    },
                                                                    "type": "If"
                                                                }
                                                            },
                                                            "runAfter": {
                                                                "Loop_through_MemberIDs_array": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "Foreach"
                                                        },
                                                        "Parse_group_members_JSON": {
                                                            "runAfter": {
                                                                "Parse_group_owners_JSON": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "ParseJson",
                                                            "inputs": {
                                                                "content": "@body('Get_group_members')",
                                                                "schema": {
                                                                    "properties": {
                                                                        "@@microsoft.graph.tips": {
                                                                            "type": "string"
                                                                        },
                                                                        "@@odata.context": {
                                                                            "type": "string"
                                                                        },
                                                                        "value": {
                                                                            "items": {
                                                                                "properties": {
                                                                                    "@@odata.type": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "businessPhones": {
                                                                                        "type": "array"
                                                                                    },
                                                                                    "displayName": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "givenName": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "id": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "jobTitle": {},
                                                                                    "mail": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "mobilePhone": {},
                                                                                    "officeLocation": {},
                                                                                    "preferredLanguage": {},
                                                                                    "surname": {},
                                                                                    "userPrincipalName": {
                                                                                        "type": "string"
                                                                                    }
                                                                                },
                                                                                "required": [
                                                                                    "@@odata.type",
                                                                                    "id",
                                                                                    "businessPhones",
                                                                                    "displayName",
                                                                                    "givenName",
                                                                                    "jobTitle",
                                                                                    "mail",
                                                                                    "mobilePhone",
                                                                                    "officeLocation",
                                                                                    "preferredLanguage",
                                                                                    "surname",
                                                                                    "userPrincipalName"
                                                                                ],
                                                                                "type": "object"
                                                                            },
                                                                            "type": "array"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                }
                                                            }
                                                        },
                                                        "Parse_group_owners_JSON": {
                                                            "runAfter": {
                                                                "Get_group_members": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "ParseJson",
                                                            "inputs": {
                                                                "content": "@body('Get_group_owners')",
                                                                "schema": {
                                                                    "properties": {
                                                                        "@@odata.context": {
                                                                            "type": "string"
                                                                        },
                                                                        "value": {
                                                                            "items": {
                                                                                "properties": {
                                                                                    "@@odata.type": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "accountEnabled": {
                                                                                        "type": "boolean"
                                                                                    },
                                                                                    "ageGroup": {
                                                                                    },
                                                                                    "assignedLicenses": {
                                                                                        "items": {
                                                                                            "properties": {
                                                                                                "disabledPlans": {
                                                                                                    "type": "array"
                                                                                                },
                                                                                                "skuId": {
                                                                                                    "type": "string"
                                                                                                }
                                                                                            },
                                                                                            "required": [
                                                                                                "disabledPlans",
                                                                                                "skuId"
                                                                                            ],
                                                                                            "type": "object"
                                                                                        },
                                                                                        "type": "array"
                                                                                    },
                                                                                    "assignedPlans": {
                                                                                        "items": {
                                                                                            "properties": {
                                                                                                "assignedDateTime": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "capabilityStatus": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "service": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "servicePlanId": {
                                                                                                    "type": "string"
                                                                                                }
                                                                                            },
                                                                                            "required": [
                                                                                                "assignedDateTime",
                                                                                                "capabilityStatus",
                                                                                                "service",
                                                                                                "servicePlanId"
                                                                                            ],
                                                                                            "type": "object"
                                                                                        },
                                                                                        "type": "array"
                                                                                    },
                                                                                    "businessPhones": {
                                                                                        "items": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "type": "array"
                                                                                    },
                                                                                    "city": {
                                                                                    },
                                                                                    "companyName": {
                                                                                    },
                                                                                    "consentProvidedForMinor": {
                                                                                    },
                                                                                    "country": {
                                                                                        "type": [
                                                                                            "string",
                                                                                            "null"
                                                                                        ]
                                                                                    },
                                                                                    "createdDateTime": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "creationType": {
                                                                                    },
                                                                                    "deletedDateTime": {
                                                                                    },
                                                                                    "department": {
                                                                                    },
                                                                                    "deviceKeys": {
                                                                                        "type": "array"
                                                                                    },
                                                                                    "displayName": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "employeeId": {
                                                                                    },
                                                                                    "externalUserState": {
                                                                                    },
                                                                                    "externalUserStateChangeDateTime": {
                                                                                    },
                                                                                    "faxNumber": {
                                                                                    },
                                                                                    "givenName": {
                                                                                        "type": [
                                                                                            "string",
                                                                                            "null"
                                                                                        ]
                                                                                    },
                                                                                    "id": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "identities": {
                                                                                        "items": {
                                                                                            "properties": {
                                                                                                "issuer": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "issuerAssignedId": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "signInType": {
                                                                                                    "type": "string"
                                                                                                }
                                                                                            },
                                                                                            "required": [
                                                                                                "signInType",
                                                                                                "issuer",
                                                                                                "issuerAssignedId"
                                                                                            ],
                                                                                            "type": "object"
                                                                                        },
                                                                                        "type": "array"
                                                                                    },
                                                                                    "imAddresses": {
                                                                                        "items": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "type": "array"
                                                                                    },
                                                                                    "isResourceAccount": {
                                                                                    },
                                                                                    "jobTitle": {
                                                                                    },
                                                                                    "legalAgeGroupClassification": {
                                                                                    },
                                                                                    "mail": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "mailNickname": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "mobilePhone": {
                                                                                        "type": [
                                                                                            "string",
                                                                                            "null"
                                                                                        ]
                                                                                    },
                                                                                    "officeLocation": {
                                                                                    },
                                                                                    "onPremisesDistinguishedName": {
                                                                                    },
                                                                                    "onPremisesDomainName": {
                                                                                    },
                                                                                    "onPremisesExtensionAttributes": {
                                                                                        "properties": {
                                                                                            "extensionAttribute1": {
                                                                                            },
                                                                                            "extensionAttribute10": {
                                                                                            },
                                                                                            "extensionAttribute11": {
                                                                                            },
                                                                                            "extensionAttribute12": {
                                                                                            },
                                                                                            "extensionAttribute13": {
                                                                                            },
                                                                                            "extensionAttribute14": {
                                                                                            },
                                                                                            "extensionAttribute15": {
                                                                                            },
                                                                                            "extensionAttribute2": {
                                                                                            },
                                                                                            "extensionAttribute3": {
                                                                                            },
                                                                                            "extensionAttribute4": {
                                                                                            },
                                                                                            "extensionAttribute5": {
                                                                                            },
                                                                                            "extensionAttribute6": {
                                                                                            },
                                                                                            "extensionAttribute7": {
                                                                                            },
                                                                                            "extensionAttribute8": {
                                                                                            },
                                                                                            "extensionAttribute9": {
                                                                                            }
                                                                                        },
                                                                                        "type": "object"
                                                                                    },
                                                                                    "onPremisesImmutableId": {
                                                                                    },
                                                                                    "onPremisesLastSyncDateTime": {
                                                                                    },
                                                                                    "onPremisesProvisioningErrors": {
                                                                                        "type": "array"
                                                                                    },
                                                                                    "onPremisesSamAccountName": {
                                                                                    },
                                                                                    "onPremisesSecurityIdentifier": {
                                                                                    },
                                                                                    "onPremisesSyncEnabled": {
                                                                                    },
                                                                                    "onPremisesUserPrincipalName": {
                                                                                    },
                                                                                    "otherMails": {
                                                                                        "items": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "type": "array"
                                                                                    },
                                                                                    "passwordPolicies": {
                                                                                    },
                                                                                    "passwordProfile": {
                                                                                    },
                                                                                    "postalCode": {
                                                                                    },
                                                                                    "preferredDataLocation": {
                                                                                    },
                                                                                    "preferredLanguage": {
                                                                                        "type": [
                                                                                            "string",
                                                                                            "null"
                                                                                        ]
                                                                                    },
                                                                                    "provisionedPlans": {
                                                                                        "items": {
                                                                                            "properties": {
                                                                                                "capabilityStatus": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "provisioningStatus": {
                                                                                                    "type": "string"
                                                                                                },
                                                                                                "service": {
                                                                                                    "type": "string"
                                                                                                }
                                                                                            },
                                                                                            "required": [
                                                                                                "capabilityStatus",
                                                                                                "provisioningStatus",
                                                                                                "service"
                                                                                            ],
                                                                                            "type": "object"
                                                                                        },
                                                                                        "type": "array"
                                                                                    },
                                                                                    "proxyAddresses": {
                                                                                        "items": {
                                                                                            "type": "string"
                                                                                        },
                                                                                        "type": "array"
                                                                                    },
                                                                                    "refreshTokensValidFromDateTime": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "showInAddressList": {
                                                                                    },
                                                                                    "signInSessionsValidFromDateTime": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "state": {
                                                                                    },
                                                                                    "streetAddress": {
                                                                                    },
                                                                                    "surname": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "usageLocation": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "userPrincipalName": {
                                                                                        "type": "string"
                                                                                    },
                                                                                    "userType": {
                                                                                        "type": "string"
                                                                                    }
                                                                                },
                                                                                "required": [
                                                                                    "@@odata.type",
                                                                                    "id"
                                                                                ],
                                                                                "type": "object"
                                                                            },
                                                                            "type": "array"
                                                                        }
                                                                    },
                                                                    "type": "object"
                                                                }
                                                            }
                                                        },
                                                        "Remove_template_team_owners": {
                                                            "actions": {
                                                                "Check_if_we_are_cloning_a_team": {
                                                                    "actions": {
                                                                        "Loop_through_template_team_owners": {
                                                                            "foreach": "@body('Parse_group_owners_JSON')?['value']",
                                                                            "actions": {
                                                                                "Check_if_template_team_owner_was_not_found_in_specified_owners": {
                                                                                    "actions": {
                                                                                        "Remove_template_team_owner_from_team": {
                                                                                            "runAfter": {},
                                                                                            "type": "Http",
                                                                                            "inputs": {
                                                                                                "authentication": {
                                                                                                    "audience": "https://graph.microsoft.com",
                                                                                                    "clientId": "@body('Get_Client_ID')?['value']",
                                                                                                    "password": "@null",
                                                                                                    "pfx": "@body('Get_Certificate')?['value']",
                                                                                                    "tenant": "@variables('TenantID')",
                                                                                                    "type": "ActiveDirectoryOAuth"
                                                                                                },
                                                                                                "headers": {
                                                                                                    "content-type": "application/json"
                                                                                                },
                                                                                                "method": "DELETE",
                                                                                                "uri": "@{variables('GraphURL')}/groups/@{body('Parse_created_team_JSON')?['id']}/owners/@{items('Loop_through_template_team_owners')?['id']}/$ref"
                                                                                            }
                                                                                        }
                                                                                    },
                                                                                    "runAfter": {},
                                                                                    "expression": {
                                                                                        "and": [
                                                                                            {
                                                                                                "not": {
                                                                                                    "contains": [
                                                                                                        "@string(variables('OwnersGraph'))",
                                                                                                        "@items('Loop_through_template_team_owners')?['id']"
                                                                                                    ]
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    },
                                                                                    "type": "If"
                                                                                }
                                                                            },
                                                                            "runAfter": {},
                                                                            "type": "Foreach"
                                                                        }
                                                                    },
                                                                    "runAfter": {},
                                                                    "expression": {
                                                                        "and": [
                                                                            {
                                                                                "equals": [
                                                                                    "@variables('TeamsTemplateOperation')",
                                                                                    "clone"
                                                                                ]
                                                                            }
                                                                        ]
                                                                    },
                                                                    "type": "If"
                                                                }
                                                            },
                                                            "runAfter": {
                                                                "Loop_through_OwnerIDs_array": [
                                                                    "Succeeded"
                                                                ]
                                                            },
                                                            "type": "Scope",
                                                            "description": "When cloning teams, the owners of the source team will be cloned. We need to remove these owners."
                                                        }
                                                    },
                                                    "runAfter": {},
                                                    "type": "Scope"
                                                }
                                            },
                                            "runAfter": {
                                                "Check_TeamsTemplateOperation_value": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "expression": {
                                                "or": [
                                                    {
                                                        "equals": [
                                                            "@variables('TeamsTemplateOperation')",
                                                            "clone"
                                                        ]
                                                    },
                                                    {
                                                        "greater": [
                                                            "@variables('MembersOwnersCount')",
                                                            20
                                                        ]
                                                    }
                                                ]
                                            },
                                            "type": "If",
                                            "description": "Adding Members and Owners is only required if we have cloned an existing team."
                                        }
                                    },
                                    "runAfter": {},
                                    "expression": {
                                        "or": [
                                            {
                                                "equals": [
                                                    "@triggerBody()?['SpaceTypeInternal']",
                                                    "Microsoft Teams Team"
                                                ]
                                            },
                                            {
                                                "greater": [
                                                    "@variables('MembersOwnersCount')",
                                                    20
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If",
                                    "description": "Execute these actions only if the space type contains more than 20 combined members/owners or is a Microsoft Teams Team."
                                }
                            },
                            "runAfter": {
                                "Check_space_type": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Scope"
                        },
                        "Process_Team": {
                            "actions": {
                                "Post_Welcome_Message": {
                                    "actions": {
                                        "Check_if_space_is_a_team_-_post_welcome_message": {
                                            "actions": {
                                                "Add_service_account_to_group_-_post_welcome_message": {
                                                    "runAfter": {},
                                                    "type": "Http",
                                                    "inputs": {
                                                        "authentication": {
                                                            "audience": "https://graph.microsoft.com",
                                                            "clientId": "@body('Get_Client_ID')?['value']",
                                                            "password": "@null",
                                                            "pfx": "@body('Get_Certificate')?['value']",
                                                            "tenant": "@variables('TenantID')",
                                                            "type": "ActiveDirectoryOAuth"
                                                        },
                                                        "body": {
                                                            "@@odata.id": "https://graph.microsoft.com/v1.0/users/@{body('Get_service_account_user_profile')?['id']}"
                                                        },
                                                        "method": "POST",
                                                        "uri": "@{variables('GraphURL')}/groups/@{variables('GroupID')}/owners/$ref"
                                                    },
                                                    "description": "Add service account to the group (team) so we can post the welcome message. We will remove the service account after."
                                                },
                                                "Post_welcome_message_to_general_channel": {
                                                    "runAfter": {
                                                        "Wait_for_owner_to_be_added_-_post_welcome_message": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "ApiConnection",
                                                    "inputs": {
                                                        "body": {
                                                            "body": {
                                                                "content": "<p>Welcome to your new Team<br>\n<br>\nThank you for using Provision Assist.<br>\n<br>\nYour team is now ready for use, you can now start adding Members, Owners, posting channel messages and lots more.<br>\n<br>\nFor helpful tips on getting started with Microsoft Teams please visit the <a href=\"https://support.office.com/en-sg/teams\">help center</a> .</p>",
                                                                "contentType": "html"
                                                            }
                                                        },
                                                        "host": {
                                                            "connection": {
                                                                "name": "@parameters('$connections')['teams']['connectionId']"
                                                            }
                                                        },
                                                        "method": "post",
                                                        "path": "/v3/beta/teams/@{encodeURIComponent(variables('GroupID'))}/channels/@{encodeURIComponent(variables('ChannelID'))}/messages"
                                                    }
                                                },
                                                "Remove_service_account_from_group_-_post_welcome_message": {
                                                    "runAfter": {
                                                        "Post_welcome_message_to_general_channel": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Http",
                                                    "inputs": {
                                                        "authentication": {
                                                            "audience": "https://graph.microsoft.com",
                                                            "clientId": "@body('Get_Client_ID')?['value']",
                                                            "password": "@null",
                                                            "pfx": "@body('Get_Certificate')?['value']",
                                                            "tenant": "@variables('TenantID')",
                                                            "type": "ActiveDirectoryOAuth"
                                                        },
                                                        "method": "DELETE",
                                                        "uri": "@{variables('GraphURL')}/groups/@{variables('GroupID')}/owners/@{body('Get_service_account_user_profile')?['id']}/$ref"
                                                    }
                                                },
                                                "Wait_for_owner_to_be_added_-_post_welcome_message": {
                                                    "runAfter": {
                                                        "Add_service_account_to_group_-_post_welcome_message": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "Wait",
                                                    "inputs": {
                                                        "interval": {
                                                            "count": 2,
                                                            "unit": "Minute"
                                                        }
                                                    }
                                                }
                                            },
                                            "runAfter": {},
                                            "expression": {
                                                "and": [
                                                    {
                                                        "equals": [
                                                            "@triggerBody()?['SpaceTypeInternal']",
                                                            "Microsoft Teams Team"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "type": "If"
                                        }
                                    },
                                    "runAfter": {
                                        "Set_Team_Variables": [
                                            "Succeeded"
                                        ]
                                    },
                                    "type": "Scope"
                                },
                                "Set_Team_Variables": {
                                    "actions": {
                                        "Check_if_space_is_a_team_-_set_team_variables": {
                                            "actions": {
                                                "Set_ChannelID_variable": {
                                                    "runAfter": {
                                                        "Set_TeamURL_variable": [
                                                            "Succeeded"
                                                        ]
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "ChannelID",
                                                        "value": "@{If(or(equals(variables('TeamsTemplateOperation'),'template'),equals(variables('TeamsTemplateOperation'),'clone')),body('Parse_created_team_JSON')?['internalId'],body('Parse_teamify_JSON')?['internalId'])}"
                                                    }
                                                },
                                                "Set_TeamURL_variable": {
                                                    "runAfter": {
                                                    },
                                                    "type": "SetVariable",
                                                    "inputs": {
                                                        "name": "TeamURL",
                                                        "value": "@{if(or(equals(variables('TeamsTemplateOperation'),'template'),equals(variables('TeamsTemplateOperation'),'clone')),body('Parse_created_team_JSON')?['webUrl'],body('Parse_teamify_JSON')?['webUrl'])}"
                                                    }
                                                }
                                            },
                                            "runAfter": {
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "equals": [
                                                            "@triggerBody()?['SpaceTypeInternal']",
                                                            "Microsoft Teams Team"
                                                        ]
                                                    }
                                                ]
                                            },
                                            "type": "If"
                                        }
                                    },
                                    "runAfter": {},
                                    "type": "Scope"
                                }
                            },
                            "runAfter": {
                                "Process_Owners_and_Members": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Scope"
                        },
                        "Send_space_created_email": {
                            "runAfter": {
                                "Loop_through_guests": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ApiConnection",
                            "inputs": {
                                "body": {
                                    "Body": "<!doctype html>\n<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:o=\"urn:schemas-microsoft-com:office:office\">\n    <head>\n        <!-- NAME: 1 COLUMN -->\n        <!--[if gte mso 15]>\n        <xml>\n            <o:OfficeDocumentSettings>\n            <o:AllowPNG/>\n            <o:PixelsPerInch>96</o:PixelsPerInch>\n            </o:OfficeDocumentSettings>\n        </xml>\n        <![endif]-->\n        <meta charset=\"UTF-8\">\n        <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n        <title>Space Created</title>\n        \n    <style type=\"text/css\">\n\t\tp{\n\t\t\tmargin:10px 0;\n\t\t\tpadding:0;\n\t\t}\n\t\ttable{\n\t\t\tborder-collapse:collapse;\n\t\t}\n\t\th1,h2,h3,h4,h5,h6{\n\t\t\tdisplay:block;\n\t\t\tmargin:0;\n\t\t\tpadding:0;\n\t\t}\n\t\timg,a img{\n\t\t\tborder:0;\n\t\t\theight:auto;\n\t\t\toutline:none;\n\t\t\ttext-decoration:none;\n\t\t}\n\t\tbody,#bodyTable,#bodyCell{\n\t\t\theight:100%;\n\t\t\tmargin:0;\n\t\t\tpadding:0;\n\t\t\twidth:100%;\n\t\t}\n\t\t.mcnPreviewText{\n\t\t\tdisplay:none !important;\n\t\t}\n\t\t#outlook a{\n\t\t\tpadding:0;\n\t\t}\n\t\timg{\n\t\t\t-ms-interpolation-mode:bicubic;\n\t\t}\n\t\ttable{\n\t\t\tmso-table-lspace:0pt;\n\t\t\tmso-table-rspace:0pt;\n\t\t}\n\t\t.ReadMsgBody{\n\t\t\twidth:100%;\n\t\t}\n\t\t.ExternalClass{\n\t\t\twidth:100%;\n\t\t}\n\t\tp,a,li,td,blockquote{\n\t\t\tmso-line-height-rule:exactly;\n\t\t}\n\t\ta[href^=tel],a[href^=sms]{\n\t\t\tcolor:inherit;\n\t\t\tcursor:default;\n\t\t\ttext-decoration:none;\n\t\t}\n\t\tp,a,li,td,body,table,blockquote{\n\t\t\t-ms-text-size-adjust:100%;\n\t\t\t-webkit-text-size-adjust:100%;\n\t\t}\n\t\t.ExternalClass,.ExternalClass p,.ExternalClass td,.ExternalClass div,.ExternalClass span,.ExternalClass font{\n\t\t\tline-height:100%;\n\t\t}\n\t\ta[x-apple-data-detectors]{\n\t\t\tcolor:inherit !important;\n\t\t\ttext-decoration:none !important;\n\t\t\tfont-size:inherit !important;\n\t\t\tfont-family:inherit !important;\n\t\t\tfont-weight:inherit !important;\n\t\t\tline-height:inherit !important;\n\t\t}\n\t\t#bodyCell{\n\t\t\tpadding:10px;\n\t\t}\n\t\t.templateContainer{\n\t\t\tmax-width:600px !important;\n\t\t}\n\t\ta.mcnButton{\n\t\t\tdisplay:block;\n\t\t}\n\t\t.mcnImage,.mcnRetinaImage{\n\t\t\tvertical-align:bottom;\n\t\t}\n\t\t.mcnTextContent{\n\t\t\tword-break:break-word;\n\t\t}\n\t\t.mcnTextContent img{\n\t\t\theight:auto !important;\n\t\t}\n\t\t.mcnDividerBlock{\n\t\t\ttable-layout:fixed !important;\n\t\t}\n\t/*\n\t@tab Page\n\t@section Background Style\n\t@tip Set the background color and top border for your email. You may want to choose colors that match your company's branding.\n\t*/\n\t\tbody,#bodyTable{\n\t\t\t/*@editable*/background-color:#FAFAFA;\n\t\t}\n\t/*\n\t@tab Page\n\t@section Background Style\n\t@tip Set the background color and top border for your email. You may want to choose colors that match your company's branding.\n\t*/\n\t\t#bodyCell{\n\t\t\t/*@editable*/border-top:0;\n\t\t}\n\t/*\n\t@tab Page\n\t@section Email Border\n\t@tip Set the border for your email.\n\t*/\n\t\t.templateContainer{\n\t\t\t/*@editable*/border:0;\n\t\t}\n\t/*\n\t@tab Page\n\t@section Heading 1\n\t@tip Set the styling for all first-level headings in your emails. These should be the largest of your headings.\n\t@style heading 1\n\t*/\n\t\th1{\n\t\t\t/*@editable*/color:#202020;\n\t\t\t/*@editable*/font-family:Helvetica;\n\t\t\t/*@editable*/font-size:26px;\n\t\t\t/*@editable*/font-style:normal;\n\t\t\t/*@editable*/font-weight:bold;\n\t\t\t/*@editable*/line-height:125%;\n\t\t\t/*@editable*/letter-spacing:normal;\n\t\t\t/*@editable*/text-align:left;\n\t\t}\n\t/*\n\t@tab Page\n\t@section Heading 2\n\t@tip Set the styling for all second-level headings in your emails.\n\t@style heading 2\n\t*/\n\t\th2{\n\t\t\t/*@editable*/color:#202020;\n\t\t\t/*@editable*/font-family:Helvetica;\n\t\t\t/*@editable*/font-size:22px;\n\t\t\t/*@editable*/font-style:normal;\n\t\t\t/*@editable*/font-weight:bold;\n\t\t\t/*@editable*/line-height:125%;\n\t\t\t/*@editable*/letter-spacing:normal;\n\t\t\t/*@editable*/text-align:left;\n\t\t}\n\t/*\n\t@tab Page\n\t@section Heading 3\n\t@tip Set the styling for all third-level headings in your emails.\n\t@style heading 3\n\t*/\n\t\th3{\n\t\t\t/*@editable*/color:#202020;\n\t\t\t/*@editable*/font-family:Helvetica;\n\t\t\t/*@editable*/font-size:20px;\n\t\t\t/*@editable*/font-style:normal;\n\t\t\t/*@editable*/font-weight:bold;\n\t\t\t/*@editable*/line-height:125%;\n\t\t\t/*@editable*/letter-spacing:normal;\n\t\t\t/*@editable*/text-align:left;\n\t\t}\n\t/*\n\t@tab Page\n\t@section Heading 4\n\t@tip Set the styling for all fourth-level headings in your emails. These should be the smallest of your headings.\n\t@style heading 4\n\t*/\n\t\th4{\n\t\t\t/*@editable*/color:#202020;\n\t\t\t/*@editable*/font-family:Helvetica;\n\t\t\t/*@editable*/font-size:18px;\n\t\t\t/*@editable*/font-style:normal;\n\t\t\t/*@editable*/font-weight:bold;\n\t\t\t/*@editable*/line-height:125%;\n\t\t\t/*@editable*/letter-spacing:normal;\n\t\t\t/*@editable*/text-align:left;\n\t\t}\n\t/*\n\t@tab Preheader\n\t@section Preheader Style\n\t@tip Set the background color and borders for your email's preheader area.\n\t*/\n\t\t#templatePreheader{\n\t\t\t/*@editable*/background-color:#FAFAFA;\n\t\t\t/*@editable*/background-image:none;\n\t\t\t/*@editable*/background-repeat:no-repeat;\n\t\t\t/*@editable*/background-position:center;\n\t\t\t/*@editable*/background-size:cover;\n\t\t\t/*@editable*/border-top:0;\n\t\t\t/*@editable*/border-bottom:0;\n\t\t\t/*@editable*/padding-top:9px;\n\t\t\t/*@editable*/padding-bottom:9px;\n\t\t}\n\t/*\n\t@tab Preheader\n\t@section Preheader Text\n\t@tip Set the styling for your email's preheader text. Choose a size and color that is easy to read.\n\t*/\n\t\t#templatePreheader .mcnTextContent,#templatePreheader .mcnTextContent p{\n\t\t\t/*@editable*/color:#656565;\n\t\t\t/*@editable*/font-family:Helvetica;\n\t\t\t/*@editable*/font-size:12px;\n\t\t\t/*@editable*/line-height:150%;\n\t\t\t/*@editable*/text-align:left;\n\t\t}\n\t/*\n\t@tab Preheader\n\t@section Preheader Link\n\t@tip Set the styling for your email's preheader links. Choose a color that helps them stand out from your text.\n\t*/\n\t\t#templatePreheader .mcnTextContent a,#templatePreheader .mcnTextContent p a{\n\t\t\t/*@editable*/color:#656565;\n\t\t\t/*@editable*/font-weight:normal;\n\t\t\t/*@editable*/text-decoration:underline;\n\t\t}\n\t/*\n\t@tab Header\n\t@section Header Style\n\t@tip Set the background color and borders for your email's header area.\n\t*/\n\t\t#templateHeader{\n\t\t\t/*@editable*/background-color:#FFFFFF;\n\t\t\t/*@editable*/background-image:none;\n\t\t\t/*@editable*/background-repeat:no-repeat;\n\t\t\t/*@editable*/background-position:center;\n\t\t\t/*@editable*/background-size:cover;\n\t\t\t/*@editable*/border-top:0;\n\t\t\t/*@editable*/border-bottom:0;\n\t\t\t/*@editable*/padding-top:9px;\n\t\t\t/*@editable*/padding-bottom:0;\n\t\t}\n\t/*\n\t@tab Header\n\t@section Header Text\n\t@tip Set the styling for your email's header text. Choose a size and color that is easy to read.\n\t*/\n\t\t#templateHeader .mcnTextContent,#templateHeader .mcnTextContent p{\n\t\t\t/*@editable*/color:#202020;\n\t\t\t/*@editable*/font-family:Helvetica;\n\t\t\t/*@editable*/font-size:16px;\n\t\t\t/*@editable*/line-height:150%;\n\t\t\t/*@editable*/text-align:left;\n\t\t}\n\t/*\n\t@tab Header\n\t@section Header Link\n\t@tip Set the styling for your email's header links. Choose a color that helps them stand out from your text.\n\t*/\n\t\t#templateHeader .mcnTextContent a,#templateHeader .mcnTextContent p a{\n\t\t\t/*@editable*/color:#007C89;\n\t\t\t/*@editable*/font-weight:normal;\n\t\t\t/*@editable*/text-decoration:underline;\n\t\t}\n\t/*\n\t@tab Body\n\t@section Body Style\n\t@tip Set the background color and borders for your email's body area.\n\t*/\n\t\t#templateBody{\n\t\t\t/*@editable*/background-color:#FFFFFF;\n\t\t\t/*@editable*/background-image:none;\n\t\t\t/*@editable*/background-repeat:no-repeat;\n\t\t\t/*@editable*/background-position:center;\n\t\t\t/*@editable*/background-size:cover;\n\t\t\t/*@editable*/border-top:0;\n\t\t\t/*@editable*/border-bottom:2px solid #EAEAEA;\n\t\t\t/*@editable*/padding-top:0;\n\t\t\t/*@editable*/padding-bottom:9px;\n\t\t}\n\t/*\n\t@tab Body\n\t@section Body Text\n\t@tip Set the styling for your email's body text. Choose a size and color that is easy to read.\n\t*/\n\t\t#templateBody .mcnTextContent,#templateBody .mcnTextContent p{\n\t\t\t/*@editable*/color:#202020;\n\t\t\t/*@editable*/font-family:Helvetica;\n\t\t\t/*@editable*/font-size:16px;\n\t\t\t/*@editable*/line-height:150%;\n\t\t\t/*@editable*/text-align:left;\n\t\t}\n\t/*\n\t@tab Body\n\t@section Body Link\n\t@tip Set the styling for your email's body links. Choose a color that helps them stand out from your text.\n\t*/\n\t\t#templateBody .mcnTextContent a,#templateBody .mcnTextContent p a{\n\t\t\t/*@editable*/color:#007C89;\n\t\t\t/*@editable*/font-weight:normal;\n\t\t\t/*@editable*/text-decoration:underline;\n\t\t}\n\t/*\n\t@tab Footer\n\t@section Footer Style\n\t@tip Set the background color and borders for your email's footer area.\n\t*/\n\t\t#templateFooter{\n\t\t\t/*@editable*/background-color:#ffffff;\n\t\t\t/*@editable*/background-image:none;\n\t\t\t/*@editable*/background-repeat:no-repeat;\n\t\t\t/*@editable*/background-position:center;\n\t\t\t/*@editable*/background-size:cover;\n\t\t\t/*@editable*/border-top:0;\n\t\t\t/*@editable*/border-bottom:0;\n\t\t\t/*@editable*/padding-top:9px;\n\t\t\t/*@editable*/padding-bottom:9px;\n\t\t}\n\t/*\n\t@tab Footer\n\t@section Footer Text\n\t@tip Set the styling for your email's footer text. Choose a size and color that is easy to read.\n\t*/\n\t\t#templateFooter .mcnTextContent,#templateFooter .mcnTextContent p{\n\t\t\t/*@editable*/color:#e74d4d;\n\t\t\t/*@editable*/font-family:Helvetica;\n\t\t\t/*@editable*/font-size:12px;\n\t\t\t/*@editable*/line-height:150%;\n\t\t\t/*@editable*/text-align:center;\n\t\t}\n\t/*\n\t@tab Footer\n\t@section Footer Link\n\t@tip Set the styling for your email's footer links. Choose a color that helps them stand out from your text.\n\t*/\n\t\t#templateFooter .mcnTextContent a,#templateFooter .mcnTextContent p a{\n\t\t\t/*@editable*/color:#656565;\n\t\t\t/*@editable*/font-weight:normal;\n\t\t\t/*@editable*/text-decoration:underline;\n\t\t}\n\t@media only screen and (min-width:768px){\n\t\t.templateContainer{\n\t\t\twidth:600px !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\tbody,table,td,p,a,li,blockquote{\n\t\t\t-webkit-text-size-adjust:none !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\tbody{\n\t\t\twidth:100% !important;\n\t\t\tmin-width:100% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t#bodyCell{\n\t\t\tpadding-top:10px !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnRetinaImage{\n\t\t\tmax-width:100% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnImage{\n\t\t\twidth:100% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnCartContainer,.mcnCaptionTopContent,.mcnRecContentContainer,.mcnCaptionBottomContent,.mcnTextContentContainer,.mcnBoxedTextContentContainer,.mcnImageGroupContentContainer,.mcnCaptionLeftTextContentContainer,.mcnCaptionRightTextContentContainer,.mcnCaptionLeftImageContentContainer,.mcnCaptionRightImageContentContainer,.mcnImageCardLeftTextContentContainer,.mcnImageCardRightTextContentContainer,.mcnImageCardLeftImageContentContainer,.mcnImageCardRightImageContentContainer{\n\t\t\tmax-width:100% !important;\n\t\t\twidth:100% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnBoxedTextContentContainer{\n\t\t\tmin-width:100% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnImageGroupContent{\n\t\t\tpadding:9px !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnCaptionLeftContentOuter .mcnTextContent,.mcnCaptionRightContentOuter .mcnTextContent{\n\t\t\tpadding-top:9px !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnImageCardTopImageContent,.mcnCaptionBottomContent:last-child .mcnCaptionBottomImageContent,.mcnCaptionBlockInner .mcnCaptionTopContent:last-child .mcnTextContent{\n\t\t\tpadding-top:18px !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnImageCardBottomImageContent{\n\t\t\tpadding-bottom:9px !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnImageGroupBlockInner{\n\t\t\tpadding-top:0 !important;\n\t\t\tpadding-bottom:0 !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnImageGroupBlockOuter{\n\t\t\tpadding-top:9px !important;\n\t\t\tpadding-bottom:9px !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnTextContent,.mcnBoxedTextContentColumn{\n\t\t\tpadding-right:18px !important;\n\t\t\tpadding-left:18px !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcnImageCardLeftImageContent,.mcnImageCardRightImageContent{\n\t\t\tpadding-right:18px !important;\n\t\t\tpadding-bottom:0 !important;\n\t\t\tpadding-left:18px !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t\t.mcpreview-image-uploader{\n\t\t\tdisplay:none !important;\n\t\t\twidth:100% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t/*\n\t@tab Mobile Styles\n\t@section Heading 1\n\t@tip Make the first-level headings larger in size for better readability on small screens.\n\t*/\n\t\th1{\n\t\t\t/*@editable*/font-size:22px !important;\n\t\t\t/*@editable*/line-height:125% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t/*\n\t@tab Mobile Styles\n\t@section Heading 2\n\t@tip Make the second-level headings larger in size for better readability on small screens.\n\t*/\n\t\th2{\n\t\t\t/*@editable*/font-size:20px !important;\n\t\t\t/*@editable*/line-height:125% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t/*\n\t@tab Mobile Styles\n\t@section Heading 3\n\t@tip Make the third-level headings larger in size for better readability on small screens.\n\t*/\n\t\th3{\n\t\t\t/*@editable*/font-size:18px !important;\n\t\t\t/*@editable*/line-height:125% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t/*\n\t@tab Mobile Styles\n\t@section Heading 4\n\t@tip Make the fourth-level headings larger in size for better readability on small screens.\n\t*/\n\t\th4{\n\t\t\t/*@editable*/font-size:16px !important;\n\t\t\t/*@editable*/line-height:150% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t/*\n\t@tab Mobile Styles\n\t@section Boxed Text\n\t@tip Make the boxed text larger in size for better readability on small screens. We recommend a font size of at least 16px.\n\t*/\n\t\t.mcnBoxedTextContentContainer .mcnTextContent,.mcnBoxedTextContentContainer .mcnTextContent p{\n\t\t\t/*@editable*/font-size:14px !important;\n\t\t\t/*@editable*/line-height:150% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t/*\n\t@tab Mobile Styles\n\t@section Preheader Visibility\n\t@tip Set the visibility of the email's preheader on small screens. You can hide it to save space.\n\t*/\n\t\t#templatePreheader{\n\t\t\t/*@editable*/display:block !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t/*\n\t@tab Mobile Styles\n\t@section Preheader Text\n\t@tip Make the preheader text larger in size for better readability on small screens.\n\t*/\n\t\t#templatePreheader .mcnTextContent,#templatePreheader .mcnTextContent p{\n\t\t\t/*@editable*/font-size:14px !important;\n\t\t\t/*@editable*/line-height:150% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t/*\n\t@tab Mobile Styles\n\t@section Header Text\n\t@tip Make the header text larger in size for better readability on small screens.\n\t*/\n\t\t#templateHeader .mcnTextContent,#templateHeader .mcnTextContent p{\n\t\t\t/*@editable*/font-size:16px !important;\n\t\t\t/*@editable*/line-height:150% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t/*\n\t@tab Mobile Styles\n\t@section Body Text\n\t@tip Make the body text larger in size for better readability on small screens. We recommend a font size of at least 16px.\n\t*/\n\t\t#templateBody .mcnTextContent,#templateBody .mcnTextContent p{\n\t\t\t/*@editable*/font-size:16px !important;\n\t\t\t/*@editable*/line-height:150% !important;\n\t\t}\n\n}\t@media only screen and (max-width: 480px){\n\t/*\n\t@tab Mobile Styles\n\t@section Footer Text\n\t@tip Make the footer content text larger in size for better readability on small screens.\n\t*/\n\t\t#templateFooter .mcnTextContent,#templateFooter .mcnTextContent p{\n\t\t\t/*@editable*/font-size:14px !important;\n\t\t\t/*@editable*/line-height:150% !important;\n\t\t}\n\n}</style></head>\n    <body>\n        <!--*|IF:MC_PREVIEW_TEXT|*-->\n        <!--[if !gte mso 9]><!----><span class=\"mcnPreviewText\" style=\"display:none; font-size:0px; line-height:0px; max-height:0px; max-width:0px; opacity:0; overflow:hidden; visibility:hidden; mso-hide:all;\">Space created</span><!--<![endif]-->\n        <!--*|END:IF|*-->\n        <center>\n            <table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" height=\"100%\" width=\"100%\" id=\"bodyTable\">\n                <tr>\n                    <td align=\"center\" valign=\"top\" id=\"bodyCell\">\n                        <!-- BEGIN TEMPLATE // -->\n                        <!--[if (gte mso 9)|(IE)]>\n                        <table align=\"center\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"600\" style=\"width:600px;\">\n                        <tr>\n                        <td align=\"center\" valign=\"top\" width=\"600\" style=\"width:600px;\">\n                        <![endif]-->\n                        <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"templateContainer\">\n                            <tr>\n                                <td valign=\"top\" id=\"templatePreheader\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"mcnTextBlock\" style=\"min-width:100%;\">\n    <tbody class=\"mcnTextBlockOuter\">\n        <tr>\n            <td valign=\"top\" class=\"mcnTextBlockInner\" style=\"padding-top:9px;\">\n              \t<!--[if mso]>\n\t\t\t\t<table align=\"left\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"100%\" style=\"width:100%;\">\n\t\t\t\t<tr>\n\t\t\t\t<![endif]-->\n\t\t\t    \n\t\t\t\t<!--[if mso]>\n\t\t\t\t<td valign=\"top\" width=\"600\" style=\"width:600px;\">\n\t\t\t\t<![endif]-->\n\t\t\t\t<!--[if mso]>\n\t\t\t\t</td>\n\t\t\t\t<![endif]-->\n                \n\t\t\t\t<!--[if mso]>\n\t\t\t\t</tr>\n\t\t\t\t</table>\n\t\t\t\t<![endif]-->\n            </td>\n        </tr>\n    </tbody>\n</table></td>\n                            </tr>\n                            <tr>\n                                <td valign=\"top\" id=\"templateHeader\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"mcnImageBlock\" style=\"min-width:100%;\">\n    <tbody class=\"mcnImageBlockOuter\">\n            <tr>\n                <td valign=\"top\" style=\"padding:9px\" class=\"mcnImageBlockInner\">\n                    <table align=\"left\" width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"mcnImageContentContainer\" style=\"min-width:100%;\">\n                        <tbody><tr>\n                            <td class=\"mcnImageContent\" valign=\"top\" style=\"padding-right: 9px; padding-left: 9px; padding-top: 0; padding-bottom: 0; text-align:center;\">\n                                \n                                    \n                                        <img align=\"center\" alt=\"\" src=\"@{variables('LogoPath')}\" width=\"278\" style=\"max-width:278px; padding-bottom: 0; display: inline !important; vertical-align: bottom;\" class=\"mcnImage\">\n                                    \n                                \n                            </td>\n                        </tr>\n                    </tbody></table>\n                </td>\n            </tr>\n    </tbody>\n</table><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"mcnBoxedTextBlock\" style=\"min-width:100%;\">\n    <!--[if gte mso 9]>\n\t<table align=\"center\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"100%\">\n\t<![endif]-->\n\t<tbody class=\"mcnBoxedTextBlockOuter\">\n        <tr>\n            <td valign=\"top\" class=\"mcnBoxedTextBlockInner\">\n                \n\t\t\t\t<!--[if gte mso 9]>\n\t\t\t\t<td align=\"center\" valign=\"top\" \">\n\t\t\t\t<![endif]-->\n                <table align=\"left\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"min-width:100%;\" class=\"mcnBoxedTextContentContainer\">\n                    <tbody><tr>\n                        \n                        <td style=\"padding-top:9px; padding-left:18px; padding-bottom:9px; padding-right:18px;\">\n                        \n                            <table border=\"0\" cellspacing=\"0\" class=\"mcnTextContentContainer\" width=\"100%\" style=\"min-width: 100% !important;background-color:@{variables('EmailAccentColor')};\">\n                                <tbody><tr>\n                                    <td valign=\"top\" class=\"mcnTextContent\" style=\"padding: 18px;color: #F2F2F2;font-family: Helvetica;font-size: 14px;font-weight: normal;text-align: center;\">\n                                        <h2 class=\"null\" style=\"text-align: center;\"><font color=\"#ffffff\">Provision Assist</font></h2>\n\n                                    </td>\n                                </tr>\n                            </tbody></table>\n                        </td>\n                    </tr>\n                </tbody></table>\n\t\t\t\t<!--[if gte mso 9]>\n\t\t\t\t</td>\n\t\t\t\t<![endif]-->\n                \n\t\t\t\t<!--[if gte mso 9]>\n                </tr>\n                </table>\n\t\t\t\t<![endif]-->\n            </td>\n        </tr>\n    </tbody>\n</table><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" class=\"mcnBoxedTextBlock\" style=\"min-width:100%;\">\n    <!--[if gte mso 9]>\n\t<table align=\"center\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"100%\">\n\t<![endif]-->\n\t<tbody class=\"mcnBoxedTextBlockOuter\">\n        <tr>\n            <td valign=\"top\" class=\"mcnBoxedTextBlockInner\">\n                \n\t\t\t\t<!--[if gte mso 9]>\n\t\t\t\t<td align=\"center\" valign=\"top\" \">\n\t\t\t\t<![endif]-->\n                <table align=\"left\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"min-width:100%;\" class=\"mcnBoxedTextContentContainer\">\n                    <tbody><tr>\n                        \n                        <td style=\"padding-top:9px; padding-left:18px; padding-bottom:9px; padding-right:18px;\">\n                        \n                            <table border=\"0\" cellspacing=\"0\" class=\"mcnTextContentContainer\" width=\"100%\" style=\"min-width:100% !important;\">\n                                <tbody><tr>\n                                    <td valign=\"top\" class=\"mcnTextContent\" style=\"padding: 18px;color: #000000;font-family: Helvetica;font-size: 14px;font-weight: normal;text-align: center;\">\n                                        <span style=\"font-size:19px\"><strong>Space Created - @{triggerBody()?['Title']}</strong></span><br>\n<br>\nYour @{triggerBody()?['SpaceType']?['Value']} - '@{triggerBody()?['Title']}' has been created and is now ready for use.<br><br>\nClick <a href=\"@{if(equals(triggerBody()?['SpaceType']?['Value'],'Microsoft Teams Team'),variables('TeamURL'),if(equals(triggerBody()?['SpaceType']?['Value'],'Viva Engage Community'),variables('VivaEngageURL'),triggerBody()?['SiteURL']))}\">here</a> to access it. \n<br><br>\nEnjoy collaborating!\n\n                                </td>\n                                </tr>\n                            </tbody></table>\n                        </td>\n                    </tr>\n                </tbody></table>\n\t\t\t\t<!--[if gte mso 9]>\n\t\t\t\t</td>\n\t\t\t\t<![endif]-->\n                \n\t\t\t\t<!--[if gte mso 9]>\n                </tr>\n                </table>\n\t\t\t\t<![endif]-->\n            </td>\n        </tr>\n    </tbody>\n</table></td>\n                            </tr>\n                  \n                         \n                        </table>\n                        <!--[if (gte mso 9)|(IE)]>\n                        </td>\n                        </tr>\n                        </table>\n                        <![endif]-->\n                        <!-- // END TEMPLATE -->\n                    </td>\n                </tr>\n            </table>\n        </center>\n    </body>\n</html>",
                                    "IsHtml": true,
                                    "Subject": "Provision Assist - Space Created",
                                    "To": "@triggerBody()?['Author']?['Email']"
                                },
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['office365']['connectionId']"
                                    }
                                },
                                "method": "post",
                                "path": "/Mail"
                            }
                        },
                        "Set_MembersOwnersCount_variable": {
                            "runAfter": {
                                "Loop_through_Members": [
                                    "Succeeded"
                                ],
                                "Loop_through_Owners": [
                                    "Succeeded"
                                ]
                            },
                            "type": "SetVariable",
                            "inputs": {
                                "name": "MembersOwnersCount",
                                "value": "@add(length(variables('MemberUPNs')),length(variables('OwnerUPNs')))"
                            }
                        },
                        "Set_external_sharing": {
                            "actions": {
                                "Check_if_external_sharing_is_not_required": {
                                    "actions": {
                                        "Disable_external_sharing": {
                                            "runAfter": {},
                                            "type": "Http",
                                            "inputs": {
                                                "authentication": {
                                                    "audience": "https://graph.microsoft.com",
                                                    "clientId": "@body('Get_Client_ID')?['value']",
                                                    "password": "@null",
                                                    "pfx": "@body('Get_Certificate')?['value']",
                                                    "tenant": "@variables('TenantID')",
                                                    "type": "ActiveDirectoryOAuth"
                                                },
                                                "body": {
                                                    "displayName": "Group.Unified.Guest",
                                                    "templateId": "08d542b9-071f-4e16-94b0-74abb372e3d9",
                                                    "values": [
                                                        {
                                                            "name": "AllowToAddGuests",
                                                            "value": "false"
                                                        }
                                                    ]
                                                },
                                                "method": "POST",
                                                "uri": "https://graph.microsoft.com/v1.0/groups/@{variables('GroupID')}/settings"
                                            }
                                        }
                                    },
                                    "runAfter": {},
                                    "expression": {
                                        "and": [
                                            {
                                                "equals": [
                                                    "@triggerBody()?['ExternalSharing']",
                                                    false
                                                ]
                                            },
                                            {
                                                "or": [
                                                    {
                                                        "equals": [
                                                            "@triggerBody()?['SpaceTypeInternal']",
                                                            "Office 365 Group"
                                                        ]
                                                    },
                                                    {
                                                        "equals": [
                                                            "@triggerBody()?['SpaceTypeInternal']",
                                                            "Microsoft Teams Team"
                                                        ]
                                                    }
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If",
                                    "description": "Disable external sharing on the group if it is not required."
                                }
                            },
                            "runAfter": {
                                "Apply_Site_Template": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Scope"
                        },
                        "Store_expiration_date": {
                            "actions": {
                                "Check_if_space_is_a_group_or_team": {
                                    "actions": {
                                        "Check_that_a_lifecycle_policy_exists": {
                                            "actions": {
                                                "Check_the_policy_covers_all_groups": {
                                                    "actions": {
                                                        "Update_request_with_expiration_date": {
                                                            "runAfter": {},
                                                            "type": "ApiConnection",
                                                            "inputs": {
                                                                "body": {
                                                                    "Description": "@triggerBody()?['Description']",
                                                                    "ExpirationDate": "@{addDays(body('Parse_group_JSON_-_expiration')?['createdDateTime'],first(body('Parse_lifecycle_policy_JSON')?['value'])?['groupLifetimeInDays'])}",
                                                                    "GroupId": "@variables('GroupID')",
                                                                    "Title": "@triggerBody()?['Title']"
                                                                },
                                                                "host": {
                                                                    "connection": {
                                                                        "name": "@parameters('$connections')['sharepointonline']['connectionId']"
                                                                    }
                                                                },
                                                                "method": "patch",
                                                                "path": "[concat('/datasets/@{encodeURIComponent(encodeURIComponent(',variables('singlequote'),parameters('requestsSiteUrl'),variables('singlequote'),'))}/tables/@{encodeURIComponent(encodeURIComponent(',variables('singlequote'),parameters('requestsListId'),variables('singlequote'),'))}/items/@{encodeURIComponent(triggerBody()?[',variables('singlequote'),'ID',variables('singlequote'),'])}')]"
                                                            }
                                                        }
                                                    },
                                                    "runAfter": {},
                                                    "expression": {
                                                        "and": [
                                                            {
                                                                "equals": [
                                                                    "@first(body('Parse_lifecycle_policy_JSON')?['value'])?['managedGroupTypes']",
                                                                    "All"
                                                                ]
                                                            }
                                                        ]
                                                    },
                                                    "type": "If",
                                                    "description": "Check the policy applies to All groups. If the policy applies to selected groups only, we will assume this policy should not apply to groups created through Provision Assist."
                                                }
                                            },
                                            "runAfter": {
                                                "Parse_lifecycle_policy_JSON": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "expression": {
                                                "and": [
                                                    {
                                                        "greater": [
                                                            "@length(body('Parse_lifecycle_policy_JSON')?['value'])",
                                                            0
                                                        ]
                                                    }
                                                ]
                                            },
                                            "type": "If",
                                            "description": "Check that a group expiration policy exists. We will only store the expiration date if a policy exists."
                                        },
                                        "Get_group": {
                                            "runAfter": {},
                                            "type": "Http",
                                            "inputs": {
                                                "authentication": {
                                                    "audience": "https://graph.microsoft.com",
                                                    "clientId": "@body('Get_Client_ID')?['value']",
                                                    "password": "@null",
                                                    "pfx": "@body('Get_Certificate')?['value']",
                                                    "tenant": "@variables('TenantID')",
                                                    "type": "ActiveDirectoryOAuth"
                                                },
                                                "method": "GET",
                                                "uri": "@{variables('GraphURL')}/groups/@{variables('GroupID')}"
                                            }
                                        },
                                        "Get_group_lifecycle_policy": {
                                            "runAfter": {
                                                "Parse_group_JSON_-_expiration": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "Http",
                                            "inputs": {
                                                "authentication": {
                                                    "audience": "https://graph.microsoft.com",
                                                    "clientId": "@body('Get_Client_ID')?['value']",
                                                    "password": "@null",
                                                    "pfx": "@body('Get_Certificate')?['value']",
                                                    "tenant": "@variables('TenantID')",
                                                    "type": "ActiveDirectoryOAuth"
                                                },
                                                "method": "GET",
                                                "uri": "@{variables('GraphURL')}/groupLifecyclePolicies"
                                            }
                                        },
                                        "Parse_group_JSON_-_expiration": {
                                            "runAfter": {
                                                "Get_group": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ParseJson",
                                            "inputs": {
                                                "content": "@body('Get_group')",
                                                "schema": {
                                                    "properties": {
                                                        "@@odata.context": {
                                                            "type": "string"
                                                        },
                                                        "classification": {},
                                                        "createdDateTime": {
                                                            "type": "string"
                                                        },
                                                        "creationOptions": {
                                                            "items": {
                                                                "type": "string"
                                                            },
                                                            "type": "array"
                                                        },
                                                        "deletedDateTime": {},
                                                        "description": {
                                                            "type": "string"
                                                        },
                                                        "displayName": {
                                                            "type": "string"
                                                        },
                                                        "expirationDateTime": {
                                                            "type": [
                                                                "string",
                                                                "null"
                                                            ]
                                                        },
                                                        "groupTypes": {
                                                            "items": {
                                                                "type": "string"
                                                            },
                                                            "type": "array"
                                                        },
                                                        "id": {
                                                            "type": "string"
                                                        },
                                                        "isAssignableToRole": {},
                                                        "mail": {
                                                            "type": "string"
                                                        },
                                                        "mailEnabled": {
                                                            "type": "boolean"
                                                        },
                                                        "mailNickname": {
                                                            "type": "string"
                                                        },
                                                        "membershipRule": {},
                                                        "membershipRuleProcessingState": {},
                                                        "onPremisesDomainName": {},
                                                        "onPremisesLastSyncDateTime": {},
                                                        "onPremisesNetBiosName": {},
                                                        "onPremisesProvisioningErrors": {
                                                            "type": "array"
                                                        },
                                                        "onPremisesSamAccountName": {},
                                                        "onPremisesSecurityIdentifier": {},
                                                        "onPremisesSyncEnabled": {},
                                                        "preferredDataLocation": {},
                                                        "preferredLanguage": {},
                                                        "proxyAddresses": {
                                                            "items": {
                                                                "type": "string"
                                                            },
                                                            "type": "array"
                                                        },
                                                        "renewedDateTime": {
                                                            "type": "string"
                                                        },
                                                        "resourceBehaviorOptions": {
                                                            "type": "array"
                                                        },
                                                        "resourceProvisioningOptions": {
                                                            "type": "array"
                                                        },
                                                        "securityEnabled": {
                                                            "type": "boolean"
                                                        },
                                                        "securityIdentifier": {
                                                            "type": "string"
                                                        },
                                                        "theme": {},
                                                        "visibility": {
                                                            "type": "string"
                                                        }
                                                    },
                                                    "type": "object"
                                                }
                                            }
                                        },
                                        "Parse_lifecycle_policy_JSON": {
                                            "runAfter": {
                                                "Get_group_lifecycle_policy": [
                                                    "Succeeded"
                                                ]
                                            },
                                            "type": "ParseJson",
                                            "inputs": {
                                                "content": "@body('Get_group_lifecycle_policy')",
                                                "schema": {
                                                    "properties": {
                                                        "@@odata.context": {
                                                            "type": "string"
                                                        },
                                                        "value": {
                                                            "items": {
                                                                "properties": {
                                                                    "alternateNotificationEmails": {
                                                                        "type": "string"
                                                                    },
                                                                    "groupLifetimeInDays": {
                                                                        "type": "integer"
                                                                    },
                                                                    "id": {
                                                                        "type": "string"
                                                                    },
                                                                    "managedGroupTypes": {
                                                                        "type": "string"
                                                                    }
                                                                },
                                                                "required": [
                                                                    "id",
                                                                    "groupLifetimeInDays",
                                                                    "managedGroupTypes",
                                                                    "alternateNotificationEmails"
                                                                ],
                                                                "type": "object"
                                                            },
                                                            "type": "array"
                                                        }
                                                    },
                                                    "type": "object"
                                                }
                                            }
                                        }
                                    },
                                    "runAfter": {},
                                    "expression": {
                                        "or": [
                                            {
                                                "equals": [
                                                    "@triggerBody()?['SpaceTypeInternal']",
                                                    "Office 365 Group"
                                                ]
                                            },
                                            {
                                                "equals": [
                                                    "@triggerBody()?['SpaceTypeInternal']",
                                                    "Microsoft Teams Team"
                                                ]
                                            }
                                        ]
                                    },
                                    "type": "If",
                                    "description": "We only need to store the expiration date if the space type is a group/team."
                                }
                            },
                            "runAfter": {
                                "Apply_sensitivity_label": [
                                    "Succeeded"
                                ]
                            },
                            "type": "Scope"
                        },
                        "Update_status_to_Space_Created": {
                            "runAfter": {
                                "Configure_space": [
                                    "Succeeded"
                                ]
                            },
                            "type": "ApiConnection",
                            "inputs": {
                                "body": {
                                    "GroupId": "@variables('GroupID')",
                                    "Status": {
                                        "Value": "Space Created"
                                    },
                                    "TeamsURL": "@{if(equals(triggerBody()?['SpaceType']?['Value'],'Microsoft Teams Team'),variables('TeamURL'),'')}",
                                    "Title": "@triggerBody()?['Title']",
                                    "VivaEngageCommunityURL": "@variables('VivaEngageURL')"
                                },
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['sharepointonline']['connectionId']"
                                    }
                                },
                                "method": "patch",
                                "path": "[concat('/datasets/@{encodeURIComponent(encodeURIComponent(',variables('singlequote'),parameters('requestsSiteUrl'),variables('singlequote'),'))}/tables/@{encodeURIComponent(encodeURIComponent(',variables('singlequote'),parameters('requestsListId'),variables('singlequote'),'))}/items/@{encodeURIComponent(triggerBody()?[',variables('singlequote'),'ID',variables('singlequote'),'])}')]"
                            }
                        },
                        "Update_status_to_Space_Creation": {
                            "runAfter": {},
                            "type": "ApiConnection",
                            "inputs": {
                                "body": {
                                    "Description": "@triggerBody()?['Description']",
                                    "Status": {
                                        "Value": "Space Creation"
                                    },
                                    "Title": "@triggerBody()?['Title']"
                                },
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['sharepointonline']['connectionId']"
                                    }
                                },
                                "method": "patch",
                                "path": "[concat('/datasets/@{encodeURIComponent(encodeURIComponent(',variables('singlequote'),parameters('requestsSiteUrl'),variables('singlequote'),'))}/tables/@{encodeURIComponent(encodeURIComponent(',variables('singlequote'),parameters('requestsListId'),variables('singlequote'),'))}/items/@{encodeURIComponent(triggerBody()?[',variables('singlequote'),'ID',variables('singlequote'),'])}')]"
                            }
                        }
                    },
                    "outputs": {}
                },
                "parameters": {
                    "$connections": {
                        "value": {
                            "sharepointonline": {
                                "connectionId": "[concat('/subscriptions/',parameters('subscriptionId'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Web/connections/provisionassist-spo')]",
                                "connectionName": "provisionassist-spo",
                                "id": "[concat('/subscriptions/',parameters('subscriptionId'),'/providers/Microsoft.Web/locations/',parameters('location'),'/managedApis/sharepointonline')]"
                            },
                            "azureautomation": {
                                "connectionId": "[concat('/subscriptions/',parameters('subscriptionId'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Web/connections/provisionassist-automation')]",
                                "connectionName": "provisionassist-automation",
                                "id": "[concat('/subscriptions/',parameters('subscriptionId'),'/providers/Microsoft.Web/locations/',parameters('location'),'/managedApis/azureautomation')]"
                            },
                            "office365": {
                                "connectionId": "[concat('/subscriptions/',parameters('subscriptionId'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Web/connections/provisionassist-o365')]",
                                "connectionName": "provisionassist-o365",
                                "id": "[concat('/subscriptions/',parameters('subscriptionId'),'/providers/Microsoft.Web/locations/',parameters('location'),'/managedApis/office365')]"
                            },
                            "office365users": {
                                "connectionId": "[concat('/subscriptions/',parameters('subscriptionId'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Web/connections/provisionassist-o365users')]",
                                "connectionName": "provisionassist-o365users",
                                "id": "[concat('/subscriptions/',parameters('subscriptionId'),'/providers/Microsoft.Web/locations/',parameters('location'),'/managedApis/office365users')]"
                            },
                            "teams": {
                                "connectionId": "[concat('/subscriptions/',parameters('subscriptionId'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Web/connections/provisionassist-teams')]",
                                "connectionName": "provisionassist-teams",
                                "id": "[concat('/subscriptions/',parameters('subscriptionId'),'/providers/Microsoft.Web/locations/',parameters('location'),'/managedApis/teams')]"
                            },
                            "keyvault": {
                                "connectionId": "[concat('/subscriptions/',parameters('subscriptionId'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Web/connections/provisionassist-kv')]",
                                "connectionName": "provisionassist-kv",
                                "id": "[concat('/subscriptions/',parameters('subscriptionId'),'/providers/Microsoft.Web/locations/',parameters('location'),'/managedApis/keyvault')]"
                            }
                        }
                    }
                }
            }
        }
    ]
}